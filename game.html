<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoreGrid: Extract.</title>
    <link rel="icon" href="./sprites/tower.png">
    <meta name="description"
        content="an extraction strategy game where you build, loot, and escape before everything goes wrong">
    <meta name="keywords"
        content="grid, game, management, resource, offline game, extraction game, strategy game, tower defense">
    <meta name="author" content="A_I_X">
    <meta name="theme-color" content="#66d9ff">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-primary: #2b2b2b;
            --bg-secondary: #3a3a3a;
            --bg-tertiary: #404040;
            --border-color: #696969;
            --text-primary: #e0e0e0;
            --text-secondary: #c0c0c0;
            --accent-primary: #66d9ff;
            --accent-secondary: #99ecff;
            --danger: #dd7e77;
            --success: #7a977b;
            --warning: #ceab77;
            --cell-size: 42px;
            --grid-gap: 6px;
            --border-radius: 4px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(18, 18, 18, 0.95);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: #2b2b2b;
            border: 3px solid #7a7a7a;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 1100px;
            height: 100vh;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }

        .homescreen-modal {
            padding: 15px;
        }

        .homescreen-fullscreen {
            display: flex;
            height: 100vh;
            width: 100vw;
            max-width: none;
            max-height: none;
            border-radius: 0;
            overflow: hidden;
            align-items: stretch;
        }

        .homescreen-main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px 15px 15px 25px;
            gap: 10px;
            height: 100%;
            min-height: 0;
        }

        .homescreen-sidebar {
            width: 340px;
            background: #353535;
            border: 2px solid var(--border-color);
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            padding: 15px;
            gap: 15px;
            border-radius: var(--border-radius);
            margin-top: 14px;
            margin-bottom: 14px;
        }

        .homescreen-vault-army-section {
            display: flex;
            gap: 15px;
            padding: 0;
            align-items: stretch;
            flex: 2;
            min-height: 0;
        }

        .homescreen-vault-army-section .vault-panel {
            flex: 1;
            margin-bottom: 0;
            display: flex;
            flex-direction: column;
        }

        .homescreen-vault-army-section .army-box {
            flex: 1;
            margin-bottom: 0;
            min-height: auto;
            display: flex;
            flex-direction: column;
        }

        .homescreen-stats-panel,
        .recent-activity-panel {
            background: #3a3a3a;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.2);
        }

        .stats-header,
        .activity-header {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #555;
        }

        .stats-header h3,
        .activity-header h3 {
            color: var(--accent-primary);
            font-size: 1.2rem;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stats-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #444;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            color: var(--accent-primary);
            font-weight: bold;
            font-size: 1rem;
        }

        .activity-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .activity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #404040;
            border-radius: var(--border-radius);
            border: 1px solid #7a7a7a;
        }

        .activity-time {
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-style: italic;
        }

        .activity-text {
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .vault-panel {
            background: #3a3a3a;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }

        .vault-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #555;
        }

        .vault-header h2 {
            color: var(--accent-primary);
            font-size: 1.4rem;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .vault-storage-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .vault-storage-label {
            color: var(--text-secondary);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .vault-storage-amount {
            color: var(--accent-primary);
            font-weight: bold;
            font-size: 1.3rem;
        }

        .vault-resources {
            display: flex;
            flex-direction: column;
            gap: 17px;
            flex: 1;
        }

        .vault-resource-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #404040;
            border-radius: var(--border-radius);
            border: 1px solid #7a7a7a;
        }

        .vault-resource-icon img {
            width: 45px;
            height: 45px;
            image-rendering: pixelated;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 7px;
            margin-top: 3px;
        }

        .vault-resource-info {
            flex-grow: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .vault-resource-name {
            color: var(--text);
            font-size: 1rem;
            text-transform: uppercase;
        }

        .vault-resource-value {
            color: var(--accent-primary);
            font-weight: bold;
            font-size: 1.1rem;
        }

        .vault-resource-amountof {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            margin: 3px;
            padding: 6px 8px;
            border-radius: var(--border-radius);
        }

        .death-screen-content {
            background: linear-gradient(145deg, #2b1a1a, #3a2525);
            border: 3px solid #8b0000;
            max-width: 500px;
            text-align: center;
        }

        .death-screen-header {
            padding: 30px 20px;
            background: linear-gradient(145deg, #8b0000, #6b0000);
            border-bottom: 3px solid #5a0000;
            position: relative;
        }

        .death-screen-header h2 {
            color: #ff6b6b;
            font-size: 2.5rem;
            text-transform: uppercase;
            letter-spacing: 3px;
            margin: 0;
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }

        .skull-icon {
            font-size: 3rem;
            margin-top: 15px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.8;
            }

            50% {
                transform: scale(1.1);
                opacity: 1;
            }
        }

        .death-screen-body {
            padding: 30px;
        }

        .death-message {
            margin-bottom: 25px;
        }

        .death-message p {
            color: #e0e0e0;
            font-size: 1.1rem;
            margin: 10px 0;
            line-height: 1.6;
        }

        .death-stats {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .death-stat {
            display: flex;
            justify-content: space-between;
            margin: 12px 0;
            padding: 8px 0;
            border-bottom: 1px solid #444;
        }

        .death-stat:last-child {
            border-bottom: none;
        }

        .death-stat .stat-label {
            color: #c0c0c0;
            font-size: 1rem;
        }

        .death-stat .stat-value {
            color: #ff6b6b;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .death-screen-actions {
            padding: 20px 30px;
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        #death-return-btn {
            background: #555;
            border-color: #777;
            color: #ddd;
        }

        #death-return-btn:hover {
            background: #666;
            border-color: #888;
        }

        #death-retry-btn {
            background: #8b0000;
            border-color: #aa0000;
        }

        #death-retry-btn:hover {
            background: #aa0000;
            border-color: #cc0000;
            box-shadow: 0 0 15px rgba(170, 0, 0, 0.4);
        }

        .army-box {
            background: #3a3a3a;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }

        .wiki-box {
            background: #3a3a3a;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 12px;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.2);
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            box-sizing: border-box;
        }

        .wiki-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #555;
        }

        .wiki-header h2 {
            color: var(--accent-primary);
            font-size: 1.4rem;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .wiki-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            margin-bottom: 10px;
        }

        .wiki-description {
            color: var(--text-secondary);
            font-size: 1rem;
            line-height: 1.6;
            margin: 0;
        }

        .wiki-open-btn {
            padding: 10px 20px;
            background: var(--accent-primary);
            color: #111;
            border: 2px solid var(--accent-secondary);
            border-radius: var(--border-radius);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: fit-content;
            margin-top: auto;
            align-self: flex-end;
            margin-bottom: 0;
            flex-shrink: 0;
        }

        .wiki-open-btn:hover {
            background: var(--accent-secondary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 217, 255, 0.4);
        }

        .army-box h2 {
            color: var(--accent-primary);
            font-size: 1.4rem;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .army-box-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 2px solid #555;
        }

        .army-unit-count {
            color: var(--accent-primary);
            font-size: 1rem;
            background: var(--bg-secondary);
            padding: 6px 16px;
            border-radius: 7px;
            border: 2px solid var(--border-color);
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            min-width: 80px;
            text-align: center;
        }

        .army-units-container {
            min-height: 80px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
        }

        .no-army-units {
            text-align: center;
            color: var(--text-secondary);
            padding: 20px;
            font-size: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 2px solid var(--border-color);
            margin: 8px;
        }

        .no-army-units p {
            margin: 10px 0;
            line-height: 1.6;
        }

        .no-army-units p:first-child {
            color: var(--accent-primary);
            font-weight: bold;
            font-size: 1.1rem;
        }

        .army-unit-display {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: linear-gradient(145deg, #2d2d2d, #252525);
            border: 2px solid #555;
            border-radius: 8px;
            margin-bottom: 12px;
            width: 100%;
            box-sizing: border-box;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .army-unit-display:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 217, 255, 0.2);
        }

        .army-unit-display:last-child {
            margin-bottom: 0;
        }

        .army-unit-display-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(145deg, #3a3a3a, #2d2d2d);
            border-radius: 8px;
            border: 2px solid #7a7a7a;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .army-unit-display-icon img {
            width: 32px;
            height: 32px;
            image-rendering: pixelated;
        }

        .army-unit-display-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .army-unit-display-name {
            color: var(--text-primary);
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 0;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .army-unit-display-stats {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
            flex-wrap: wrap;
        }

        .army-unit-display-stat {
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            background: rgba(45, 45, 45, 0.5);
            border-radius: 12px;
            border: 1px solid #444;
        }

        .army-unit-display-stat.health {
            color: #7a977b;
            background: rgba(122, 151, 123, 0.2);
            border-color: #7a977b;
        }

        .army-unit-display-stat.range {
            color: #ceab77;
            background: rgba(206, 171, 119, 0.2);
            border-color: #ceab77;
        }

        .army-unit-display-stat.movement {
            color: #66d9ff;
            background: rgba(102, 217, 255, 0.2);
            border-color: #66d9ff;
        }

        .army-unit-display-stat.damage {
            color: #dd7e77;
            background: rgba(221, 126, 119, 0.2);
            border-color: #dd7e77;
        }

        @keyframes unitCardAppear {
            0% {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }

            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .army-unit-display.new-unit {
            animation: unitCardAppear 0.5s ease-out;
        }

        .army-box-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #555;
        }

        .homescreen-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: auto;
        }

        .homescreen-button {
            padding: 15px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .homescreen-button:hover {
            box-shadow: 0 8px 20px rgba(102, 217, 255, 0.3);
            border: 2px solid var(--accent-primary);
            transform: translateY(-2px);
            background: linear-gradient(145deg, #5a5a5a, #4a4a4a);
        }

        .play-button {
            background: var(--accent-primary);
            color: #111;
            border-color: var(--accent-secondary);
            padding: 22px 0px;
            font-size: 1.2rem;
        }

        .play-button:hover {
            background: var(--accent-secondary);
            box-shadow: 0 8px 20px rgba(102, 217, 255, 0.5);
        }

        .crates-btn {
            background: linear-gradient(145deg, #4a4a4a, #3a3a3a);
            border-color: #66d9ff;
            color: #e0e0e0;
        }

        .crates-btn:hover {
            background: linear-gradient(145deg, #5a5a5a, #4a4a4a);
            border-color: #66d9ff;
            color: #66d9ff;
            box-shadow: 0 8px 20px rgba(102, 217, 255, 0.5);
        }


        .homescreen-button img {
            width: 24px;
            height: 24px;
            image-rendering: pixelated;
        }

        .zone-selection-modal {
            max-width: 1200px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #3a3a3a;
            border-bottom: 2px solid #7a7a7a;
        }

        .modal-header h2 {
            color: var(--accent-primary);
            margin: 0;
            font-size: 1.8rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.8rem;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            line-height: 1;
        }

        .close-btn:hover {
            background: rgba(255, 85, 85, 0.2);
            color: #ff5555;
            transform: scale(1.1);
        }

        .close-btn::before {
            content: "✕";
            font-family: Arial, sans-serif;
        }

        .modal-body {
            padding: 25px;
        }

        .crate-result-content {
            max-width: 700px;
            max-height: 1300px;
            width: 95%;
            background: #2a2a2a;
            border-color: var(--border-color);
            border-radius: var(--border-radius);
        }

        .crate-result-body {
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
        }

        /* Enhanced Header Styling */
        .modal-header {
            background: linear-gradient(145deg, #3a3a3a, #2a2a2a);
            border-bottom: 2px solid #66d9ff;
            padding: 25px;
            text-align: center;
        }

        .modal-header h2 {
            color: #66d9ff;
            font-size: 2.2rem;
            margin: 0;
            text-shadow: 0 0 15px rgba(102, 217, 255, 0.5);
            letter-spacing: 2px;
        }

        /* Enhanced Result Info Layout */
        .crate-result-info {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 25px;
        }

        .result-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background: rgba(102, 217, 255, 0.1);
            border: 2px solid #66d9ff;
            border-radius: 12px;
            width: 100%;
            max-width: 300px;
        }

        .result-header h3 {
            color: #66d9ff;
            margin: 0;
            font-size: 1.8rem;
            text-align: center;
            text-shadow: 0 0 10px rgba(102, 217, 255, 0.3);
        }

        .result-sprite-placeholder {
            display: flex;
            justify-content: center;
        }

        .result-sprite-placeholder img {
            width: 100px;
            height: 100px;
            object-fit: contain;
            border: 3px solid #66d9ff;
            border-radius: 12px;
            background: linear-gradient(145deg, #3a3a3a, #2a2a2a);
            padding: 10px;
            box-shadow: 0 0 20px rgba(102, 217, 255, 0.3);
            transition: all 0.3s ease;
        }

        .result-sprite-placeholder img:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(102, 217, 255, 0.5);
        }

        .result-details {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 25px;
        }

        .reward-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 500px;
            padding: 20px;
            background: rgba(50, 50, 50, 0.5);
            border: 2px solid #555;
            border-radius: 12px;
        }

        .reward-item {
            background: linear-gradient(145deg, #3a3a3a, #2a2a2a);
            border-color: var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .reward-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(102, 217, 255, 0.3);
            border-color: var(--border-color);
        }

        .reward-item.oil {
            border-color: #7a977b;
            background: linear-gradient(145deg, #353a35, #2a302a);
        }

        .reward-item.oil:hover {
            border-color: #8aac8b;
            box-shadow: 0 6px 12px rgba(122, 151, 123, 0.3);
        }

        .reward-label {
            font-size: 1rem;
            color: #ddd;
            margin-bottom: 8px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .reward-amount {
            font-size: 1.6rem;
            font-weight: bold;
            color: #66d9ff;
            margin-bottom: 5px;
        }

        .reward-item.oil .reward-amount {
            color: #7a977b;
        }

        .reward-value {
            font-size: 1rem;
            color: #aaa;
            font-style: italic;
            font-weight: 500;
        }

        .result-message {
            font-size: 1.4rem;
            font-weight: bold;
            margin: 20px 0;
            padding: 20px 30px;
            border-radius: 12px;
            text-align: center;
            width: 100%;
            max-width: 400px;
            letter-spacing: 1px;
        }

        .result-win {
            background: linear-gradient(145deg, rgba(46, 204, 113, 0.3), rgba(39, 174, 96, 0.3));
            border: 3px solid #2ecc71;
            color: #2ecc71;
        }

        .result-loss {
            background: linear-gradient(145deg, rgba(231, 76, 60, 0.3), rgba(192, 57, 43, 0.3));
            border: 3px solid #e74c3c;
            color: #e74c3c;
        }

        .result-break-even {
            background: linear-gradient(145deg, rgba(241, 196, 15, 0.3), rgba(243, 156, 18, 0.3));
            border: 3px solid #f1c40f;
            color: #f1c40f;
        }

        .result-actions {
            margin-top: 10px;
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .result-actions .modal-btn {
            padding: 15px 40px;
            font-size: 1.1rem;
            letter-spacing: 2px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .result-actions .modal-btn:hover {
            transform: translateY(-3px);
        }

        /* Crates Modal Styles */
        .crates-modal-content {
            max-width: 1200px;
            width: 95%;
            height: 90vh;
            max-height: 90vh;
        }

        .crates-modal-body {
            display: flex;
            flex-direction: column;
            gap: 25px;
            padding: 25px;
            overflow-y: auto;
            max-height: calc(90vh - 120px);
        }

        .crates-intro {
            text-align: center;
            padding: 20px;
            background: #3a3a3a;
            border: 2px solid #66d9ff;
            border-radius: var(--border-radius);
        }

        .crates-intro p {
            margin: 10px 0;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .risk-warning {
            color: #ff6b6b !important;
            font-weight: bold;
            margin-top: 15px !important;
        }

        .crates-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .crate-type {
            flex: 1;
            min-width: 300px;
            max-width: 400px;
        }

        .crate-type h3 {
            text-align: center;
            color: var(--accent-primary);
            margin-bottom: 20px;
            font-size: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding-bottom: 10px;
            border-bottom: 2px solid #555;
        }

        .ore-crates h3 {
            color: #66d9ff;
            border-color: #66d9ff;
        }

        .oil-crates h3 {
            color: #7a977b;
            border-color: #7a977b;
        }

        .crate-levels {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .crate-item {
            background: #3a3a3a;
            border: 2px solid #7a7a7a;
            border-radius: var(--border-radius);
            padding: 20px;
            transition: all 0.3s ease;
            text-align: center;
        }

        .crate-sprite {
            margin: -20px -20px 15px -20px;
            padding: 15px 0;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid #555;
        }

        .crate-sprite img {
            width: 120px;
            height: 120px;
            object-fit: contain;
            image-rendering: pixelated;
            border: 2px solid #66d9ff;
            border-radius: 8px;
            background: #3a3a3a;
            padding: 8px;
            transition: all 0.3s ease;
        }

        .ore-crates .crate-sprite img {
            border-color: #66d9ff;
            background: #3a3a3a;
        }

        .oil-crates .crate-sprite img {
            border-color: #7a977b;
            background: #3a3a3a;
        }


        .crate-item:hover {
            border-color: var(--accent-primary);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.5);
        }

        .ore-crates .crate-item:hover {
            border-color: #66d9ff;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.5);
        }

        .oil-crates .crate-item:hover {
            border-color: #7a977b;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.5);
        }

        .crate-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #555;
        }

        .crate-name {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--text-primary);
        }

        .crate-cost {
            font-weight: bold;
            color: var(--accent-primary);
            background: #3a3a3a;
            padding: 5px 10px;
            border-radius: 15px;
            border: 1px solid var(--accent-primary);
        }

        .ore-crates .crate-cost {
            color: #66d9ff;
            background: #3a3a3a;
            border-color: #66d9ff;
        }

        .oil-crates .crate-cost {
            color: #7a977b;
            background: #3a3a3a;
            border-color: #7a977b;
        }

        .free-crates h3 {
            color: #ceab77;
            border-color: #ceab77;
        }

        .free-crates .crate-sprite img {
            border-color: #ceab77;
            background: #3a3a3a;
        }

        .free-crates .crate-item:hover {
            border-color: #ceab77;
            box-shadow: 0 6px 15px rgba(206, 171, 119, 0.3);
        }

        .free-crates .crate-cost {
            color: #ceab77;
            background: #3a3a3a;
            border-color: #ceab77;
        }

        .free-crates .crate-buy-btn {
            background: #ceab77;
            border-color: #ae8b57;
            color: #111;
        }

        .free-crates .crate-buy-btn:hover {
            background: #debb87;
            border-color: #be9b67;
            box-shadow: 0 5px 15px rgba(206, 171, 119, 0.3);
        }

        .daily-streak {
            background: rgba(206, 171, 119, 0.2);
            border: 1px solid #ceab77;
            border-radius: var(--border-radius);
            padding: 10px;
            margin: 10px 0;
            text-align: center;
        }

        .streak-counter {
            font-weight: bold;
            color: #ceab77;
            font-size: 1.2rem;
        }

        .streak-rewards {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .claimed-today {
            opacity: 0.6;
            pointer-events: none;
        }

        .claimed-today .crate-buy-btn {
            background: #555;
            border-color: #777;
            color: #999;
        }

        .crate-rewards {
            margin-bottom: 20px;
        }

        .crate-rewards span {
            display: block;
            margin: 5px 0;
            color: var(--text-secondary);
        }

        .crate-rewards .min-reward,
        .crate-rewards .max-reward {
            font-size: 0.9rem;
            font-weight: bold;
        }

        .min-reward {
            color: #7a977b;
        }

        .max-reward {
            color: #dd7e77;
        }

        .crate-buy-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent-primary);
            color: #111;
            border: 2px solid var(--accent-secondary);
            border-radius: var(--border-radius);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .crate-buy-btn:hover {
            background: var(--accent-secondary);
            transform: translateY(-2px);
        }

        .ore-crates .crate-buy-btn {
            background: #66d9ff;
            border-color: #46b9df;
            color: #111;
        }

        .ore-crates .crate-buy-btn:hover {
            background: #76e9ff;
            border-color: #56c9ef;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .oil-crates .crate-buy-btn {
            background: #7a977b;
            border-color: #5a775b;
            color: #111;
        }

        .oil-crates .crate-buy-btn:hover {
            background: #8aac8b;
            border-color: #6a8c6b;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .crate-buy-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .crate-sprite img[src*="default_crate.png"] {
            background: #3a3a3a;
            border: 2px solid var(--border-color);
            font-size: 3rem;
            color: #66d9ff;
            font-weight: bold;
        }

        .crate-opening-effect {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 4000;
            pointer-events: none;
        }

        .crate-effect-content {
            text-align: center;
            animation: floatUp 2s ease-out;
        }

        .crate-text {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            margin-top: 20px;
            animation: glowPulse 1s infinite alternate;
        }

        .crate-sparkles {
            width: 100px;
            height: 100px;
            margin: 0 auto;
            position: relative;
        }

        .crate-sparkles::before,
        .crate-sparkles::after {
            content: "✨";
            position: absolute;
            font-size: 2rem;
            animation: sparkleSpin 1.5s infinite linear;
        }

        .crate-sparkles::before {
            top: 0;
            left: 0;
            animation-delay: 0s;
        }

        .crate-sparkles::after {
            bottom: 0;
            right: 0;
            animation-delay: 0.75s;
        }

        @keyframes crateOpenAnimation {
            0% {
                opacity: 0;
                transform: scale(0.5);
            }
            50% {
                opacity: 1;
                transform: scale(1.2);
            }
            100% {
                opacity: 0;
                transform: scale(0.8);
            }
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px);
                opacity: 0;
            }
        }

        @keyframes glowPulse {
            0% {
                text-shadow: 0 0 3px rgba(0, 0, 0, 0.3);
            }
            100% {
                text-shadow: 0 0 8px rgba(0, 0, 0, 0.7);
            }
        }

        @keyframes sparkleSpin {
            0% {
                transform: rotate(0deg) scale(1);
            }
            50% {
                transform: rotate(180deg) scale(1.3);
            }
            100% {
                transform: rotate(360deg) scale(1);
            }
        }

        .zone-selection-modal .zones-section {
            margin: 0;
            padding: 0;
            border: none;
            box-shadow: none;
            background: transparent;
        }

        .zone-selection-modal .panel-header {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #555;
        }

        .wiki-modal-content {
            max-width: 1300px;
            width: 95%;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }

        .wiki-modal-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .wiki-sidebar {
            width: 280px;
            background: #353535;
            border-right: 2px solid #7a7a7a;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .wiki-search {
            padding: 20px;
            border-bottom: 2px solid #7a7a7a;
            display: flex;
            gap: 10px;
        }

        .wiki-search-input {
            flex: 1;
            padding: 12px;
            background: #404040;
            border: 2px solid #7a7a7a;
            border-radius: var(--border-radius);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .wiki-search-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .wiki-search-input::placeholder {
            color: var(--text-secondary);
        }

        .wiki-search-btn {
            padding: 12px 15px;
            background: var(--accent-primary);
            border: 2px solid var(--accent-secondary);
            border-radius: var(--border-radius);
            color: #111;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .wiki-search-btn:hover {
            background: var(--accent-secondary);
            transform: translateY(-1px);
        }

        .wiki-categories {
            flex: 1;
            overflow-y: auto;
            padding: 15px 0;
        }

        .wiki-category {
            margin-bottom: 20px;
        }

        .wiki-category h3 {
            color: var(--accent-primary);
            padding: 10px 20px;
            margin: 0;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid #555;
        }

        .wiki-pages-list {
            list-style: none;
            padding: 0;
            margin: 10px 0 0 0;
        }

        .wiki-page-item {
            padding: 12px 25px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .wiki-page-item:hover {
            background: #404040;
            color: var(--text-primary);
            border-left-color: var(--accent-primary);
        }

        .wiki-page-item.active {
            background: #404040;
            color: var(--accent-primary);
            border-left-color: var(--accent-primary);
            font-weight: bold;
        }

        .wiki-content-area {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            background: #2b2b2b;
        }

        .wiki-content-display {
            max-width: 800px;
            margin: 0 auto;
        }

        .wiki-article-content {
            display: none;
        }

        .wiki-article-content.active {
            display: block;
        }

        .wiki-search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #2d2d2d;
            border: 2px solid #ff6b6b;
            border-top: none;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .wiki-search-dropdown[style*="block"] {
            display: block !important;
        }

        .search-dropdown-list {
            padding: 10px;
        }

        .search-results-count {
            color: var(--accent-primary);
            font-weight: bold;
            padding: 8px 12px;
            border-bottom: 1px solid #444;
            margin-bottom: 10px;
        }

        .search-result-item {
            padding: 12px;
            border: 1px solid #444;
            border-radius: var(--border-radius);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #3a3a3a;
        }

        .search-result-item:hover {
            background: #4a4a4a;
            border-color: var(--accent-primary);
            transform: translateX(5px);
        }

        .search-result-title {
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .search-result-matches {
            font-size: 0.9em;
        }

        .search-match {
            margin: 5px 0;
            padding: 5px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        .match-type {
            color: var(--accent-secondary);
            font-weight: bold;
            margin-right: 8px;
        }

        .match-text {
            color: var(--text-secondary);
        }

        .match-text mark {
            background: var(--accent-primary);
            color: #000;
            padding: 2px 4px;
            border-radius: 2px;
        }

        .more-matches {
            color: var(--text-secondary);
            font-style: italic;
            margin-top: 5px;
            font-size: 0.85em;
        }

        .search-no-results {
            text-align: center;
            padding: 30px 20px;
        }

        .no-results-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .no-results-text {
            color: var(--text-primary);
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .no-results-subtext {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .wiki-search-modal-content {
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
        }

        .wiki-search-modal-body {
            padding: 20px;
        }

        .wiki-search-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 100%;
        }

        .wiki-search-bar {
            display: flex;
            gap: 10px;
        }

        .search-results-container {
            flex: 1;
            overflow-y: auto;
            background: #2d2d2d;
            border-radius: var(--border-radius);
            border: 2px solid #555;
            padding: 15px;
        }

        .search-placeholder {
            text-align: center;
            padding: 50px 20px;
            color: var(--text-secondary);
        }

        .search-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .search-instruction {
            font-size: 1.1rem;
        }

        .search-results-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .search-result-card {
            background: #3a3a3a;
            border: 2px solid #555;
            border-radius: var(--border-radius);
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .search-result-card:hover {
            border-color: var(--accent-primary);
            background: #4a4a4a;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(102, 217, 255, 0.3);
        }

        .search-result-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .search-result-excerpt {
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .search-result-meta {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
            color: var(--accent-secondary);
        }

        .search-result-match-count {
            background: var(--accent-primary);
            color: #000;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: bold;
        }

        .search-no-results {
            text-align: center;
            padding: 50px 20px;
        }

        .search-no-results .no-results-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .search-no-results .no-results-text {
            font-size: 1.3rem;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .search-no-results .no-results-subtext {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .wiki-home-content {
            text-align: center;
            padding: 40px 20px;
        }

        .wiki-home-content h2 {
            color: var(--accent-primary);
            font-size: 2rem;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .wiki-home-content p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .wiki-quick-links {
            margin-top: 30px;
        }

        .wiki-quick-links h3 {
            color: var(--accent-primary);
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .quick-links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .quick-link-btn {
            padding: 15px;
            background: #3a3a3a;
            border: 2px solid #7a7a7a;
            border-radius: var(--border-radius);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: bold;
        }

        .quick-link-btn:hover {
            background: #4a4a4a;
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 217, 255, 0.3);
        }

        .wiki-article {
            padding: 20px 0;
        }

        .wiki-article h1 {
            color: var(--accent-primary);
            font-size: 2rem;
            margin-bottom: 25px;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-bottom: 3px solid #555;
            padding-bottom: 15px;
        }

        .wiki-article h2 {
            color: var(--accent-secondary);
            font-size: 1.5rem;
            margin: 25px 0 15px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .wiki-article h3 {
            color: var(--text-primary);
            font-size: 1.2rem;
            margin: 20px 0 10px 0;
        }

        .wiki-article p {
            color: var(--text-secondary);
            line-height: 1.7;
            margin-bottom: 15px;
        }

        .wiki-article ul,
        .wiki-article ol {
            color: var(--text-secondary);
            margin: 15px 0;
            padding-left: 30px;
        }

        .wiki-article li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .wiki-tip {
            background: rgba(102, 217, 255, 0.1);
            border-left: 4px solid var(--accent-primary);
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }

        .wiki-tip h4 {
            color: var(--accent-primary);
            margin-top: 0;
            margin-bottom: 10px;
        }

        .wiki-warning {
            background: rgba(206, 171, 119, 0.1);
            border-left: 4px solid var(--warning);
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }

        .wiki-warning h4 {
            color: var(--warning);
            margin-top: 0;
            margin-bottom: 10px;
        }

        .wiki-search-results {
            padding: 20px 0;
        }

        .wiki-search-results h2 {
            color: var(--accent-primary);
            font-size: 1.8rem;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .wiki-search-results p {
            color: var(--text-secondary);
            margin-bottom: 25px;
            font-size: 1.1rem;
        }

        .search-results-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .search-result-item {
            background: #3a3a3a;
            border: 2px solid #7a7a7a;
            border-radius: var(--border-radius);
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-result-item:hover {
            border-color: var(--accent-primary);
            background: #4a4a4a;
            transform: translateY(-2px);
        }

        .search-result-item h3 {
            color: var(--accent-secondary);
            margin: 0 0 10px 0;
            font-size: 1.3rem;
        }

        .search-result-item p {
            color: var(--text-secondary);
            margin: 0;
            line-height: 1.5;
        }



        .research-btn,
        .research-nav-btn {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            color: var(--text-primary);
        }

        .research-btn:hover,
        .research-nav-btn:hover {
            box-shadow: 0 8px 20px rgba(102, 217, 255, 0.3);
            border: 2px solid var(--accent-primary);
            transform: translateY(-2px);
            background: linear-gradient(145deg, #5a5a5a, #4a4a4a);
        }

        .research-nav-btn {
            padding: 10px 20px;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(145deg, #3a3a3a, #2d2d2d);
            border: 1px solid #666;
            border-radius: 6px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            min-width: 100px;
            justify-content: center;
        }

        .research-nav-btn img {
            width: 24px;
            height: 24px;
            image-rendering: pixelated;
        }

        .nav-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .nav-folders {
            display: flex;
            gap: 10px;
        }

        .nav-folders .folder {
            margin: 0;
            min-width: 80px;
        }

        .nav-folders .folder-title {
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        .nav-folders .folder-content {
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 200px;
            z-index: 1000;
        }

        .title-box {
            background: #3a3a3a;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 32px 20px;
            box-shadow: 0 8px 0 rgba(0, 0, 0, 0.3);
            text-align: center;
            flex-shrink: 0;
        }

        .title-box .game-title {
            font-size: 1.8rem;
            margin: 0 0 3px 0;
            color: var(--accent-primary);
            letter-spacing: 3px;
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .title-box .game-subtitle {
            font-size: 0.9rem;
            margin: 0;
            color: var(--text-secondary);
            letter-spacing: 2px;
            font-weight: 300;
            text-transform: uppercase;
        }



        .tagline {
            font-size: 1.2rem;
            color: var(--accent-secondary);
            margin-top: 20px;
            font-style: italic;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #555;
        }

        .panel-header h2 {
            color: var(--accent-primary);
            font-size: 2rem;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .storage-indicator,
        .risk-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .storage-label,
        .risk-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .storage-amount {
            color: var(--accent-primary);
            font-weight: bold;
            font-size: 1.3rem;
        }

        .risk-level {
            padding: 6px 15px;
            border-radius: 20px;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }

        .risk-level.safe {
            background: var(--success);
            color: #e0ffe0;
        }

        .stored-resources-section {
            background: #353535;
            border: 3px solid #7a7a7a;
            border-radius: var(--border-radius);
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: 0 10px 0 rgba(0, 0, 0, 0.3);
        }

        .resources-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .resource-card {
            background: #3a3a3a;
            border: 2px solid #7a7a7a;
            border-radius: var(--border-radius);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .resource-card:hover {
            transform: translateY(-3px);
            border-color: var(--accent-primary);
            background: #4a4a4a;
        }

        .resource-icon img {
            width: 48px;
            height: 48px;
            image-rendering: pixelated;
        }

        .resource-info {
            display: flex;
            flex-direction: column;
        }

        .resource-name {
            color: var(--text-primary);
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .resource-value {
            color: var(--accent-primary);
            font-size: 1.4rem;
            font-weight: bold;
        }

        .zones-section {
            background: #353535;
            border: 3px solid #7a7a7a;
            border-radius: var(--border-radius);
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: 0 10px 0 rgba(0, 0, 0, 0.3);
        }

        .zone-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }

        .zone-card {
            background: #3a3a3a;
            border: 3px solid #7a7a7a;
            border-radius: var(--border-radius);
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .zone-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 0 rgba(0, 0, 0, 0.3);
        }

        .zone-header {
            background: #404040;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 2px solid #7a7a7a;
        }

        .zone-icon img {
            width: 50px;
            height: 50px;
            image-rendering: pixelated;
        }

        .zone-title {
            flex-grow: 1;
        }

        .zone-title h3 {
            color: var(--text-primary);
            margin: 0 0 5px 0;
            font-size: 1.4rem;
        }

        .zone-risk {
            padding: 4px 12px;
            border-radius: 15px;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 1px;
        }

        .zone-risk.low {
            background: var(--success);
            color: #e0ffe0;
        }

        .zone-risk.medium {
            background: var(--warning);
            color: #111;
        }

        .zone-risk.high {
            background: var(--danger);
            color: #ffe0e0;
        }

        .zone-content {
            padding: 15px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .zone-description {
            color: var(--text-secondary);
            margin-bottom: 20px;
            line-height: 1.5;
            flex: 1;
        }

        .zone-rewards {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 20px;
        }

        .reward-item {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--border-color);
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
        }


        @keyframes glowPulse {

            0%,
            100% {
                box-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
            }

            50% {
                box-shadow: 0 0 25px rgba(255, 215, 0, 0.9);
            }
        }

        .reward-item img {
            width: 20px;
            height: 20px;
            image-rendering: pixelated;
        }

        .zone-footer {
            padding: 0 20px 20px 20px;
            margin-top: auto;
        }

        .zone-enter-btn {
            width: 100%;
            padding: 15px;
            background: var(--accent-primary);
            color: #111;
            border: none;
            border-radius: var(--border-radius);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1rem;
        }

        .zone-enter-btn:hover {
            background: var(--accent-secondary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 217, 255, 0.4);
        }

        .homescreen-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 0;
            border-top: 2px solid #555;
        }

        .utility-controls {
            display: flex;
            gap: 15px;
        }

        .utility-btn {
            background: #3a3a3a;
            border: 2px solid #7a7a7a;
            border-radius: var(--border-radius);
            padding: 12px 20px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
        }

        .utility-btn:hover {
            background: var(--accent-primary);
            color: #111;
            border-color: var(--accent-secondary);
            transform: translateY(-2px);
        }

        .utility-btn img {
            width: 20px;
            height: 20px;
            image-rendering: pixelated;
        }


        .game-navbar {
            background: #353535;
            border: 2px solid #7a7a7a;
            border-radius: var(--border-radius);
            padding: 15px 25px;
            margin-bottom: 20px;
            display: flex;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.2);
            width: 1300px !important;
            justify-content: flex-start;
            align-items: stretch;
            flex-wrap: wrap;
            gap: 20px;
        }

        .nav-right-group {
            display: flex;
            align-items: center;
            gap: 25px;
        }
        
        .nav-current-zone {
            display: flex;
            align-items: center;
            gap: 25px;
            padding: 10px 16px;
        }

        .folder-bar {
            display: flex;
            justify-content: center;
            gap: 15px;
            background: rgba(58, 58, 58, 0.9);
            padding: 12px;
            border-radius: 7px;
            border: 1px solid #555;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            margin: 10px 0;
            position: relative;
            z-index: 100;
            width: 100%;
        }

        .folder-item {
            position: relative;
        }

        .folder-trigger {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            background: linear-gradient(145deg, #3a3a3a, #2d2d2d);
            border: 1px solid #666;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            min-width: 100px;
            justify-content: center;
        }

        .folder-trigger:hover {
            background: linear-gradient(145deg, #4a4a4a, #3a3a3a);
            border-color: #7a7a7a;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }

        .folder-trigger.selected {
            background: var(--accent-primary);
            color: #111;
            border-color: var(--accent-secondary);
            box-shadow: 0 0 15px rgba(102, 217, 255, 0.6);
            animation: selectionPulse 1.5s infinite;
        }

        @keyframes selectionPulse {

            0%,
            100% {
                box-shadow: 0 0 15px rgba(102, 217, 255, 0.6);
            }

            50% {
                box-shadow: 0 0 25px rgba(102, 217, 255, 0.9), 0 0 5px rgba(102, 217, 255, 0.3);
            }
        }

        .folder-trigger img {
            width: 24px;
            height: 24px;
            image-rendering: pixelated;
        }

        .folder-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 7px;
            min-width: 280px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: none;
            padding: 10px;
        }

        .folder-item:hover .folder-dropdown {
            display: block;
        }

        .dropdown-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
        }

        .dropdown-btn {
            display: flex;
            flex-direction: column;
            width: 100%;
            padding: 10px;
            background: #3a3a3a;
            border: 1px solid #555;
            color: var(--text-primary);
            cursor: pointer;
            border-radius: 7px;
            transition: all 0.2s ease;
            text-align: left;
            gap: 6px;
            position: relative;
        }

        .dropdown-btn:hover {
            background: #4a4a4a;
            border-color: #666;
        }

        .dropdown-btn-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 5px;
        }

        .dropdown-btn img {
            width: 32px;
            height: 32px;
            image-rendering: pixelated;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 7px;
            padding: 4px;
        }

        .dropdown-btn-title {
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--text-primary);
            flex: 1;
        }

        .dropdown-btn-cost {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(102, 217, 255, 0.15);
            padding: 6px 10px;
            border-radius: 20px;
            border: 1px solid var(--accent-primary);
            font-weight: bold;
            font-size: 0.9rem;
        }

        .cost-resource {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .cost-resource img {
            width: 18px;
            height: 18px;
            image-rendering: pixelated;
            padding: 0;
            background: none;
            border-radius: 0;
        }

        .dropdown-btn-description {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .dropdown-btn-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: auto;
        }

        .stat-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #666;
            color: var(--text-secondary);
        }

        .stat-badge.health {
            background: rgba(122, 151, 123, 0.2);
            border-color: #7a977b;
            color: #7a977b;
        }

        .stat-badge.range {
            background: rgba(206, 171, 119, 0.2);
            border-color: #ceab77;
            color: #ceab77;
        }

        .stat-badge.movement {
            background: rgba(102, 217, 255, 0.2);
            border-color: #66d9ff;
            color: #66d9ff;
        }

        .dropdown-btn span:last-child {
            margin-left: auto;
            color: #858585;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80px;
            cursor: pointer;
            border-bottom: 1px dotted #858585;
        }

        .dropdown-btn span:last-child:hover {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }

        .full-cost-popup {
            position: fixed;
            background: #222;
            border: 2px solid var(--accent-primary);
            border-radius: var(--border-radius);
            padding: 12px 16px;
            font-size: 1rem;
            color: var(--text-primary);
            z-index: 2000;
            box-shadow: 0 0 20px rgba(102, 217, 255, 0.4);
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
            transform: translateY(-10px);
            opacity: 0;
            transition: all 0.2s ease;
        }

        .full-cost-popup.show {
            transform: translateY(0);
            opacity: 1;
        }

        .full-cost-popup::before {
            content: "COST DETAILS";
            display: block;
            color: var(--accent-primary);
            font-size: 0.8rem;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .nav-section {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            background: rgba(58, 58, 58, 0.9);
            border-radius: 7px;
            border: 1px solid #555;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .nav-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .nav-value {
            color: var(--accent-primary);
            font-weight: bold;
            font-size: 1.2rem;
            padding: 4px 8px;
            background: rgba(102, 217, 255, 0.15);
            border-radius: 4px;
            border: 1px solid rgba(102, 217, 255, 0.3);
        }

        .zone-name {
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .threat-indicator .threat-status {
            padding: 8px 18px;
            border-radius: 25px;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.95rem;
            letter-spacing: 1px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        }

        .threat-indicator .threat-status.safe {
            background: var(--success);
            color: #e0ffe0;
        }

        .threat-indicator .threat-status.danger {
            background: var(--danger);
            color: #ffe0e0;
            animation: pulseDanger 1.5s infinite;
        }

        .nav-divider {
            width: 2px;
            height: 40px;
            background: linear-gradient(to bottom, transparent, #555, transparent);
            margin: 0 10px;
            align-self: center;
        }

        .nav-section-highlight {
            position: relative;
        }

        .nav-section-highlight::before {
            content: "";
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border: 1px solid rgba(102, 217, 255, 0.3);
            border-radius: calc(var(--border-radius) + 2px);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .nav-section-highlight:hover::before {
            opacity: 1;
        }

        .tech-tree-completion-banner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(43, 43, 43, 0.95);
            border: 3px solid var(--accent-primary);
            border-radius: var(--border-radius);
            padding: 30px;
            z-index: 5000;
            text-align: center;
            box-shadow: 0 0 30px rgba(102, 217, 255, 0.5);
            animation: fadeInScale 0.5s ease;
            min-width: 400px;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }

            to {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
        }

        .tech-tree-completion-banner .banner-content h2 {
            color: var(--accent-primary);
            margin: 0 0 15px 0;
            font-size: 2rem;
            text-shadow: 0 0 10px rgba(102, 217, 255, 0.7);
        }

        .tech-tree-completion-banner .banner-content p {
            color: var(--text-primary);
            margin: 0 0 20px 0;
            font-size: 1.2rem;
        }

        .bonus-rewards {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .bonus-rewards .reward-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 12px 20px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            font-size: 1.1rem;
            border: 2px solid var(--accent-primary);
            box-shadow: 0 0 15px rgba(102, 217, 255, 0.3);
            animation: pulseGlow 2s infinite;
        }

        @keyframes pulseGlow {

            0%,
            100% {
                box-shadow: 0 0 15px rgba(102, 217, 255, 0.3);
                transform: scale(1);
            }

            50% {
                box-shadow: 0 0 25px rgba(102, 217, 255, 0.6);
                transform: scale(1.05);
            }
        }

        .bonus-rewards .reward-item img {
            width: 28px;
            height: 28px;
            image-rendering: pixelated;
        }

        .game-main-area {
            display: flex;
            gap: 25px;
            min-height: 600px;
        }

        .game-sidebar {
            width: 280px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .resources-panel {
            background: #353535;
            border: 2px solid #7a7a7a;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.2);
        }

        .resources-panel h3 {
            color: var(--accent-primary);
            margin: 0 0 20px 0;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 1.2rem;
        }

        .resources-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .resource-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #3a3a3a;
            border-radius: var(--border-radius);
            border: 1px solid #7a7a7a;
        }

        .resource-item img {
            width: 32px;
            height: 32px;
            image-rendering: pixelated;
        }

        .resource-details {
            flex-grow: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .resource-name {
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .resource-amount {
            color: var(--accent-primary);
            font-weight: bold;
            font-size: 1.2rem;
        }

        .extraction-controls-panel {
            background: #353535;
            border: 2px solid #7a7a7a;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.2);
        }

        .extraction-controls-panel h3 {
            color: var(--accent-primary);
            margin: 0 0 20px 0;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 1.2rem;
        }

        .control-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .control-btn {
            padding: 15px;
            border: 2px solid #7a7a7a;
            border-radius: var(--border-radius);
            background: #3a3a3a;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .control-btn:hover {
            transform: translateY(-2px);
        }

        .control-btn img {
            width: 24px;
            height: 24px;
            image-rendering: pixelated;
        }

        .extract-btn {
            background: var(--warning);
            color: #111;
            border-color: #aa8b57;
        }

        .extract-btn:hover:not(:disabled) {
            background: #deb887;
            border-color: #c9a063;
            box-shadow: 0 5px 15px rgba(206, 171, 119, 0.4);
        }

        .extract-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .continue-btn {
            background: var(--accent-primary);
            color: #111;
            border-color: var(--accent-secondary);
        }

        .continue-btn:hover {
            background: var(--accent-secondary);
            box-shadow: 0 5px 15px rgba(102, 217, 255, 0.4);
        }

        .game-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .game-grid-container {
            flex-grow: 1;
            display: flex;
            justify-content: flex-start;
        }

        .game-info-panel {
            background: #353535;
            border: 2px solid #7a7a7a;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.2);
        }

        .game-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
        }

        .stat-box {
            text-align: left;
        }

        .stat-box .stat-label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .stat-box .stat-value {
            display: block;
            color: var(--accent-primary);
            font-weight: bold;
            font-size: 1.4rem;
        }

        .instructions-panel {
            text-align: left;
            padding: 15px;
            background: #3a3a3a;
            border-radius: var(--border-radius);
            border: 1px solid #7a7a7a;
        }

        .instructions-panel p {
            color: var(--text-primary);
            margin: 0;
            font-size: 1.1rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
        }

        ::-webkit-scrollbar {
            display: none;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            padding: 30px;
            min-height: 100vh;
            display: flex;
            justify-content: flex-start;
            align-items: flex-start;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .game-container {
            max-width: 900px;
            width: 100%;
            text-align: left;
        }

        .game-header {
            margin-bottom: 20px;
        }

        .game-title {
            font-size: 3rem !important;
            color: var(--accent-primary);
            text-align: left;
            letter-spacing: 1px;
        }

        .game-subtitle {
            color: var(--text-secondary);
            margin-bottom: 20px;
            text-align: left;
        }

        .ui-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 20px;
            background: #353535;
            border: 2px solid #7a7a7a;
            border-radius: var(--border-radius);
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .resources {
            display: flex;
            gap: 20px;
        }

        .resource {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--text-primary);
            padding: 10px 15px;
            background: #353535;
            border-radius: var(--border-radius);
            border: 2px solid #7a7a7a;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
        }

        .resource img {
            width: 24px;
            height: 24px;
        }

        .controls-folder {
            display: flex;
            gap: 15px;
        }

        .folder {
            background: var(--bg-tertiary);
            border-radius: var(--border-radius);
            border: 3px solid #7a7a7a;
            min-width: 100px;
            position: relative;
            z-index: 100;
            transition: all 0.2s ease;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
            display: inline-block;
        }

        .folder:not(.open) .folder-content {
            display: none !important;
        }

        .folder-title {
            padding: 10px 12px;
            background: #353535;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #ddd;
            border-radius: var(--border-radius);
            border: 3px solid #7a7a7a;
            display: flex;
            align-items: center;
            gap: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: inset 0 -3px 0 rgba(0, 0, 0, 0.2);
            font-size: 12px;
            user-select: none;
        }

        .folder-title img {
            width: 24px;
            height: 24px;
            object-fit: contain;
            image-rendering: pixelated;
            display: block;
        }

        .folder-content {
            display: none;
            flex-direction: column;
            gap: 8px;
            padding: 0;
            position: fixed;
            background: var(--bg-tertiary);
            border-radius: var(--border-radius);
            border: 3px solid #7a7a7a;
            width: 200px;
            z-index: 1000;
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
            min-width: 140px;
        }

        .folder-header {
            padding: 8px 12px;
            background: #3a3a3a;
            font-weight: bold;
            cursor: move;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid #7a7a7a;
            user-select: none;
        }

        .folder-header-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .folder-close {
            background: none;
            border: none;
            color: #ddd;
            cursor: pointer;
            font-size: 16px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
        }

        .folder-close:hover {
            background: #ff5555;
        }

        .folder-content.draggable {
            position: fixed;
        }

        .folder-buttons {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .folder.open .folder-content {
            display: block;
            animation: dropdownFade 0.2s ease;
        }

        @keyframes dropdownFade {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .folder-content .btn {
            width: 100%;
            height: auto;
            min-height: 50px;
            border: 2px solid #7a7a7a;
            border-radius: var(--border-radius);
            background-color: #353535;
            color: #ddd;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            font-size: 11px;
            text-align: left;
            padding: 6px 10px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .folder-content .btn:hover {
            background-color: var(--accent-primary);
            color: #111;
            border-color: var(--accent-secondary);
            transform: translateX(5px);
        }

        .folder-content .btn img {
            width: 20px;
            height: 20px;
            object-fit: contain;
            image-rendering: pixelated;
            display: block;
            margin: 0;
            max-width: 20px;
            max-height: 20px;
        }

        .btn-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-right {
            display: flex;
            align-items: center;
        }

        .btn-left img {
            width: 20px;
            height: 20px;
            object-fit: contain;
            image-rendering: pixelated;
        }

        .btn-left span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .btn-right .lowcol {
            font-weight: bold;
            color: #aaa;
        }

        .btn {
            width: 100px;
            height: 80px;
            border: 2px solid #7a7a7a;
            border-radius: var(--border-radius);
            background-color: #353535;
            color: #ddd;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-size: 11px;
            text-align: center;
            padding: 5px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
        }

        .info-icon {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 16px;
            height: 16px;
            background-color: #444;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: #ddd;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
            border: 1px solid #7a7a7a;
        }

        .btn:hover .info-icon {
            opacity: 1;
        }

        .info-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, #2d2d2d, #252525);
            border: 3px solid var(--accent-primary);
            border-radius: 12px;
            padding: 20px;
            width: auto;
            min-width: 300px;
            max-width: 400px;
            z-index: 3000;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(102, 217, 255, 0.3);
            display: none;
            font-size: 13px;
            backdrop-filter: blur(10px);
        }

        .info-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent-primary);
        }

        .info-popup-title {
            font-weight: bold;
            font-size: 16px;
            text-transform: uppercase;
            color: var(--accent-primary);
            letter-spacing: 1px;
        }

        .info-popup-close {
            background: none;
            border: none;
            color: #ddd;
            cursor: pointer;
            font-size: 18px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
        }

        .info-popup-close:hover {
            background: #ff5555;
        }

        .info-popup-content {
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .info-popup-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        .info-popup-stat {
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            border: 1px solid #666;
            color: var(--text-secondary);
        }

        .info-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1999;
            display: none;
        }

        .btn:hover {
            background-color: var(--accent-primary);
            color: #111;
            border-color: var(--accent-secondary);
            transform: translateY(-2px);
        }

        .btn img {
            width: 16px;
            height: 16px;
            object-fit: contain;
            image-rendering: pixelated;
            display: block;
            margin: 0 auto;
            max-width: 16px;
            max-height: 16px;
        }

        .btn.active {
            background-color: var(--accent-primary);
            color: #111;
            border-color: var(--accent-secondary);
        }

        .btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn.disabled:hover {
            transform: none;
            background: var(--bg-tertiary);
        }

        /* Gray out unresearched dropdown items */
        .dropdown-btn.disabled {
            opacity: 0.4;
            filter: grayscale(100%);
            background: #404040 !important;
            color: #888 !important;
            border-color: #555 !important;
            cursor: not-allowed;
        }

        .dropdown-btn.disabled:hover {
            opacity: 0.4;
            filter: grayscale(100%);
            background: #404040 !important;
            transform: none;
            cursor: not-allowed;
        }

        .dropdown-btn.disabled img {
            opacity: 0.3;
            filter: grayscale(100%);
        }

        .dropdown-btn.disabled span {
            color: #888 !important;
        }

        .dropdown-btn.disabled .cost {
            color: #666 !important;
        }

        .btn.researched {
            background-color: #7a977b;
            border-color: #5a775b;
        }

        .btn.researched:hover {
            background-color: #8aac8b;
            border-color: #6a8c6b;
        }

        .btn.available {
            background-color: #66d9ff;
            border-color: #46b9df;
            color: #111;
        }

        .btn.available:hover {
            background-color: #76e9ff;
            border-color: #56c9ef;
        }

        .game-grid-container {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 20px;
        }

        .game-grid {
            display: grid;
            grid-template-columns: repeat(25, 1fr);
            grid-template-rows: repeat(15, 1fr);
            gap: var(--grid-gap);
            background: #353535;
            border: 2px solid #7a7a7a;
            padding: 15px;
            border-radius: var(--border-radius);
            justify-content: flex-start;
            align-content: flex-start;
            min-height: 650px;
            aspect-ratio: 25 / 15;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.2);
        }

        .grid-cell {
            background: #2f811b;
            border: 3px solid #398d24;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #ccc;
            border-radius: var(--border-radius);
            aspect-ratio: 1 / 1;
        }
        
        /* Zone-specific grid cell colors */
        .grid-cell.zone-shallow {
            background: #2f811b;
            border: 3px solid #398d24;
        }
        
        .grid-cell.zone-medium {
            background: #636E4C;
            border: 3px solid #7a865f;
        }
        
        .grid-cell.zone-deep {
            background: #140201;
            border: 3px solid #2a0402;
        }
        
        /* Hover effects for zone-specific cells */
        .grid-cell.zone-shallow:hover {
            background: #3ea326;
            border: 3px solid #4cb72f;
        }
        
        .grid-cell.zone-medium:hover {
            background: #7a865f;
            border: 3px solid #8d996c;
        }
        
        .grid-cell.zone-deep:hover {
            background: #2a0402;
            border: 3px solid #3d0603;
        }

        .grid-cell:hover {
            background: #3ea326;
            border: 3px solid #4cb72f;
            transform: translateY(-2px);
            border-radius: var(--border-radius);
            z-index: 2;
        }

        .grid-cell.selected {
            box-shadow: 0 0 8px var(--accent-secondary);
            border-color: var(--accent-secondary);
            background: rgba(255, 215, 0, 0.2);
        }

        .grid-cell.valid-move {
            background: rgba(76, 175, 80, 0.3);
            border-color: var(--accent-primary);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(102, 217, 255, 0.5);
            animation: gridPulse 1s infinite;
        }

        .grid-cell.valid-attack {
            background: rgba(244, 67, 54, 0.3);
            border-color: var(--danger);
            cursor: crosshair;
            box-shadow: 0 0 10px rgba(221, 126, 119, 0.5);
            animation: gridPulse 1s infinite;
        }

        @keyframes gridPulse {

            0%,
            100% {
                box-shadow: 0 0 10px rgba(102, 217, 255, 0.5);
                transform: scale(1);
            }

            50% {
                box-shadow: 0 0 20px rgba(102, 217, 255, 0.8);
                transform: scale(1.05);
            }
        }

        .grid-cell.valid-attack:hover {
            background: rgba(244, 67, 54, 0.5);
        }

        .grid-cell .object-sprite {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            border-radius: 2px;
        }

        .grid-cell .object-sprite img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            image-rendering: pixelated;
            display: block;
        }

        .game-info {
            display: flex;
            gap: 25px;
            margin-bottom: 25px;
        }

        .turn-info,
        .wave-info {
            padding: 20px;
            background: #353535;
            border-radius: var(--border-radius);
            border: 2px solid #7a7a7a;
            text-align: left;
            color: var(--text-primary);
            flex: 1;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
        }

        .info-panel {
            padding: 20px;
            background: #353535;
            border-radius: var(--border-radius);
            border: 2px solid #7a7a7a;
            text-align: left;
            color: var(--text-primary);
            margin-bottom: 25px;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
        }

        .info-panel h3 {
            margin-bottom: 10px;
            color: var(--accent-primary);
            border-left: 5px solid var(--accent-primary);
            padding-left: 10px;
        }

        .info-panel p {
            color: var(--text-secondary);
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .floating-sidebar {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 15px;
            background: #353535;
            border-radius: var(--border-radius);
            border: 2px solid #7a7a7a;
            z-index: 1000;
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
        }

        .control-btn {
            padding: 12px 20px;
            border: 2px solid #7a7a7a;
            background-color: #353535;
            color: #ddd;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
        }

        .control-btn:hover {
            background-color: var(--accent-primary);
            color: #111;
            border-color: var(--accent-secondary);
            transform: translateY(-2px);
        }

        .control-btn.primary {
            background-color: var(--accent-primary);
            color: #111;
            border-color: var(--accent-secondary);
        }

        .control-btn.warning {
            background: var(--warning);
            color: white;
            border-color: #7a7a7a;
        }

        .health-bar {
            position: absolute;
            bottom: 2px;
            left: 2px;
            right: 2px;
            height: 3px;
            background: #333;
            border-radius: 2px;
            overflow: hidden;
            border: 1px solid #555;
        }

        .health-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s ease;
        }

        .notification {
            padding: 15px 20px;
            background: #353535;
            color: var(--text-primary);
            border: 2px solid #7a7a7a;
            border-radius: var(--border-radius);
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
            width: 300px;
            margin-bottom: 10px;
        }

        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        .lowcol {
            color: #858585;
        }

        .card {
            background: #353535;
            border: 2px solid #7a7a7a;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            transition: transform 0.15s ease, border-color 0.2s ease;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
        }

        .card:hover {
            transform: scale(1.01);
            border-color: var(--accent-primary);
        }

        .card h2 {
            margin-bottom: 10px;
            color: #e8e8e8;
            font-size: 1.4rem;
        }

        .card p {
            color: var(--text-secondary);
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .text-section h2 {
            color: #eee;
            border-left: 5px solid var(--accent-primary);
            padding-left: 10px;
            margin-bottom: 15px;
        }

        .highlight {
            background-color: #353535;
            border: 2px solid #7a7a7a;
            padding: 20px;
            color: #ddd;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 25px 0;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #111111;
            color: #fff;
            text-align: left;
            border-radius: 4px;
            padding: 8px;
            position: absolute;
            z-index: 1001;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 11px;
            line-height: 1.4;
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #303030 transparent transparent transparent;
        }

        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 0;
            pointer-events: none;
            opacity: 0;
        }

        .particle-effect {
            position: absolute;
            pointer-events: none;
            z-index: 999;
        }

        .selection-tooltip {
            position: fixed;
            background: rgba(43, 43, 43, 0.95);
            border: 2px solid #7a7a7a;
            border-radius: var(--border-radius);
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 2000;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            min-width: 180px;
        }

        .selection-tooltip .tooltip-icon {
            width: 32px;
            height: 32px;
            image-rendering: pixelated;
        }

        .selection-tooltip .tooltip-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .selection-tooltip .tooltip-name {
            color: var(--text-primary);
            font-weight: bold;
            font-size: 1rem;
        }

        .selection-tooltip .tooltip-cost {
            color: var(--accent-primary);
            font-weight: bold;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .selection-tooltip .tooltip-cost img {
            width: 16px;
            height: 16px;
            image-rendering: pixelated;
        }

        .placement-preview-tooltip {
            position: fixed;
            z-index: 10000;
            pointer-events: none;
        }

        .preview-tooltip-content {
            background: rgba(43, 43, 43, 0.95);
            border: 2px solid #7a7a7a;
            border-radius: var(--border-radius);
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            min-width: 180px;
        }

        .preview-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .preview-icon {
            width: 32px;
            height: 32px;
            image-rendering: pixelated;
        }

        .preview-icon.error {
            background: #555;
            border: 1px solid #777;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #ccc;
            text-align: center;
        }

        .preview-title {
            color: var(--text-primary);
            font-weight: bold;
            font-size: 1rem;
        }

        .preview-costs {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .preview-cost-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--accent-primary);
            font-weight: bold;
            font-size: 0.9rem;
        }

        .preview-cost-item img {
            width: 16px;
            height: 16px;
            image-rendering: pixelated;
        }

        .preview-cost-placeholder {
            color: var(--text-secondary);
            font-style: italic;
            font-size: 0.85rem;
        }

        .preview-instruction {
            color: var(--accent-primary);
            font-weight: bold;
            font-size: 0.8rem;
            text-align: center;
            letter-spacing: 1px;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .folder-buttons .btn {
            position: relative;
        }

        .tech-tree-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #353535;
            border: none;
            border-radius: 0;
            z-index: 2000;
            box-shadow: none;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .tech-tree-header {
            padding: 20px 25px;
            background: #3a3a3a;
            border-bottom: 2px solid #7a7a7a;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            flex-shrink: 0;
        }

        .tech-tree-header h2 {
            margin: 0;
            color: var(--accent-primary);
            font-size: 1.5rem;
        }

        .tech-tree-close {
            background: none;
            border: none;
            color: #ddd;
            cursor: pointer;
            font-size: 1.8rem;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            line-height: 1;
        }

        .tech-tree-close:hover {
            background: rgba(255, 85, 85, 0.2);
            color: #ff5555;
            transform: scale(1.1);
        }

        .tech-tree-close::before {
            content: "✕";
            font-family: Arial, sans-serif;
        }

        .tech-tree-resources {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .tech-tree-resources-card {
            position: fixed;
            top: 110px;
            right: 25px;
            background: #3a3a3a;
            border: 2px solid #7a7a7a;
            border-radius: var(--border-radius);
            padding: 12px 15px;
            display: flex;
            gap: 15px;
            z-index: 2025;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .tech-tree-resource {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            font-weight: bold;
        }

        .tech-tree-resource img {
            width: 20px;
            height: 20px;
            image-rendering: pixelated;
        }

        .tech-tree-content {
            padding: 25px;
            overflow: auto;
            flex-grow: 1;
            position: relative;
            background: #2b2b2b;
            min-height: 700px;
            background-image:
                radial-gradient(circle at 10px 10px, rgba(100, 100, 100, 0.1) 1px, transparent 0);
            background-size: 30px 30px;
            display: flex;
            flex-direction: column;
        }

        .tech-tree-main {
            flex-grow: 1;
            position: relative;
            margin-bottom: 180px; /* Increased to accommodate the info panel */
        }

        .tech-info-panel {
            background: #353535;
            border: 2px solid #7a7a7a;
            padding: 15px;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            transition: all 0.3s ease;
            position: fixed;
            bottom: 25px;
            left: 25px;
            z-index: 2030;
            border-radius: var(--border-radius);
            width: 350px;
            max-width: 350px;
        }

        .tech-info-panel.hidden {
            opacity: 0.6;
        }

        .tech-info-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--accent-primary);
            margin-bottom: 8px;
        }

        .tech-info-description {
            color: var(--text-secondary);
            margin-bottom: 12px;
            line-height: 1.4;
            max-width: 80%;
        }

        .tech-info-cost {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tech-cost-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
        }

        .tech-cost-steel {
            color: #aaa;
        }

        .tech-cost-coins {
            color: #d4af37;
        }

        .tech-cost-gold {
            color: #ffcc00;
        }

        .tech-cost-oil {
            color: #9e5623;
        }

        .tech-info-default {
            color: #888;
            font-style: italic;
        }

        .tech-tree-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1999;
            display: none;
        }

        .resource-selection-modal {
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .resource-selection-container {
            padding: 20px;
        }

        .resource-selection-layout {
            display: flex;
            gap: 25px;
            height: 100%;
        }

        .resource-controls-sidebar {
            width: 280px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            padding: 20px;
            background: #353535;
            border-radius: var(--border-radius);
            border: 2px solid #555;
            flex-shrink: 0;
        }

        .resource-grid-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 25px;
            min-width: 0;
        }

        .resource-selection-description {
            text-align: center;
            margin-bottom: 30px;
            color: var(--text-secondary);
            line-height: 1.6;
            font-size: 1.1rem;
            background: rgba(102, 217, 255, 0.1);
            padding: 15px;
            border-radius: var(--border-radius);
            border: 1px solid rgba(102, 217, 255, 0.3);
        }

        .resource-overview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            padding: 15px;
            background: #353535;
            border-radius: var(--border-radius);
            border: 2px solid #555;
        }

        .resource-overview-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 10px;
            background: #3a3a3a;
            border-radius: var(--border-radius);
            border: 1px solid #7a7a7a;
            transition: all 0.3s ease;
        }

        .resource-overview-item:hover {
            transform: translateY(-3px);
            border-color: var(--accent-primary);
            background: #4a4a4a;
        }

        .resource-overview-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .resource-overview-icon img {
            width: 32px;
            height: 32px;
            image-rendering: pixelated;
        }

        .resource-overview-name {
            color: var(--text-primary);
            font-weight: bold;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .resource-overview-amount {
            color: var(--accent-primary);
            font-weight: bold;
            font-size: 1.1rem;
        }

        .resource-sliders {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .resource-slider-group {
            background: #3a3a3a;
            padding: 15px;
            border-radius: var(--border-radius);
            border: 2px solid #555;
            transition: all 0.3s ease;
        }

        .resource-slider-group:hover {
            border-color: var(--accent-primary);
            background: #424242;
        }

        .resource-label {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .resource-label img {
            width: 32px;
            height: 32px;
            image-rendering: pixelated;
        }

        .available-amount {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-left: auto;
        }

        .available-amount span {
            color: var(--accent-primary);
            font-weight: bold;
        }

        .resource-slider {
            width: 100%;
            height: 25px;
            margin-bottom: 10px;
            -webkit-appearance: none;
            appearance: none;
            background: #555;
            border-radius: 10px;
            outline: none;
        }

        .resource-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: var(--accent-primary);
            cursor: pointer;
            border: 2px solid #111;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .resource-slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: var(--accent-primary);
            cursor: pointer;
            border: 2px solid #111;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .slider-value {
            text-align: center;
            color: var(--accent-primary);
            font-weight: bold;
            font-size: 1.1rem;
            padding: 8px;
            background: rgba(102, 217, 255, 0.15);
            border-radius: var(--border-radius);
            border: 1px solid rgba(102, 217, 255, 0.3);
        }

        .resource-selection-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .resource-selection-actions .btn-secondary,
        .resource-selection-actions .btn-primary {
            width: 100%;
            padding: 12px;
            font-size: 0.9rem;
        }

        .btn-secondary,
        .btn-primary {
            padding: 12px 25px;
            border-radius: var(--border-radius);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid;
        }

        .btn-secondary {
            background: #3a3a3a;
            border-color: #7a7a7a;
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--accent-primary);
            color: #111;
            border-color: var(--accent-secondary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 217, 255, 0.4);
        }

        .btn-primary {
            background: var(--accent-primary);
            border-color: var(--accent-secondary);
            color: #111;
        }

        .btn-primary:hover {
            background: var(--accent-secondary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 217, 255, 0.6);
        }

        .resource-label img {
            width: 24px;
            height: 24px;
            image-rendering: pixelated;
        }

        .available-amount {
            margin-left: auto;
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .resource-slider {
            width: 100%;
            height: 25px;
            -webkit-appearance: none;
            appearance: none;
            background: #555;
            outline: none;
            border-radius: 10px;
            margin: 10px 0;
        }

        .resource-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            background: var(--accent-primary);
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #111;
        }

        .resource-slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            background: var(--accent-primary);
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #111;
        }

        .slider-value {
            text-align: center;
            font-weight: bold;
            color: var(--accent-primary);
        }

        .resource-selection-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .btn-primary,
        .btn-secondary {
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: #111;
        }

        .btn-primary:hover {
            background: var(--accent-secondary);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #555;
            color: var(--text-primary);
            border: 2px solid #777;
        }

        .btn-secondary:hover {
            background: #666;
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .tech-node {
            position: absolute;
            width: 90px;
            height: 90px;
            border: 2px solid #7a7a7a;
            border-radius: var(--border-radius);
            background: linear-gradient(145deg, #3a3a3a, #2d2d2d);
            color: #ddd;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.15);
            text-align: center;
            z-index: 10;
            font-size: 12px;
            overflow: hidden;
        }

        .tech-node::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #7a7a7a;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .tech-node:hover {
            transform: translateY(-5px) scale(1.15);
            z-index: 20;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.3);
            border-color: var(--accent-primary);
            background: linear-gradient(145deg, #4a4a4a, #3a3a3a);
        }

        .tech-node.researched {
            background: linear-gradient(145deg, #7a977b, #6a876b);
            border-color: #5a775b;
        }

        .tech-node.researched::before {
            background: #5a775b;
        }

        .tech-node.available {
            background: linear-gradient(145deg, #66d9ff, #56c9ef);
            border-color: #46b9df;
            color: #111;
        }

        .tech-node.available::before {
            background: #46b9df;
        }

        .tech-node.available:hover {
            background: linear-gradient(145deg, #76e9ff, #66d9ff);
            border-color: #56c9ef;
        }

        .tech-node.locked {
            background: linear-gradient(145deg, #4a4a4a, #3a3a3a);
            border-color: #555;
            opacity: 1;
            cursor: not-allowed;
        }

        .tech-node.locked::before {
            background: #555;
        }

        .tech-node.locked:hover {
            transform: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border-color: #555;
        }

        .tech-tooltip {
            position: absolute;
            background: #66d9ff;
            outline: 3px solid #64d1f5;
            color: #111;
            padding: 8px 12px;
            border-radius: 4px 24px 24px 24px;
            font-size: 13px;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transform: translate(0, 0);
        }

        .tech-node-icon {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.25);
            padding: 10px;
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .tech-node-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            image-rendering: pixelated;
        }

        .tech-node-name {
            display: none;
        }

        .tech-node-cost {
            display: none;
        }

        .tech-node-status {
            display: none;
        }

        .tech-node.researched .tech-node-status {
            background: #5a775b;
            color: #e0ffe0;
        }

        .tech-node.available .tech-node-status {
            background: #46b9df;
            color: #111;
        }

        .tech-node.locked .tech-node-status {
            background: #666;
            color: #bbb;
        }

        .tech-connection {
            position: absolute;
            background: #7a7a7a;
            transform-origin: 0 0;
            z-index: 5;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
            height: 4px;
        }

        .tech-connection.researched {
            background: #5a775b;
            box-shadow: 0 0 5px #5a775b;
        }

        .tech-connection.locked {
            background: #555;
            opacity: 0.6;
        }

        .building-info-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #353535;
            border: 3px solid #7a7a7a;
            border-radius: var(--border-radius);
            width: 400px;
            max-width: 90vw;
            height: auto;
            max-height: 80vh;
            z-index: 2000;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .building-info-header {
            padding: 15px 20px;
            background: #3a3a3a;
            border-bottom: 2px solid #7a7a7a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .building-info-header h2 {
            margin: 0;
            color: var(--accent-primary);
            font-size: 1.5rem;
        }

        .building-info-close {
            background: none;
            border: none;
            color: #ddd;
            cursor: pointer;
            font-size: 1.8rem;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            line-height: 1;
        }

        .building-info-close:hover {
            background: rgba(255, 85, 85, 0.2);
            color: #ff5555;
            transform: scale(1.1);
        }

        .building-info-close::before {
            content: "✕";
            font-family: Arial, sans-serif;
        }

        .building-info-content {
            padding: 25px;
            overflow-y: auto;
            flex-grow: 1;
            background: #2b2b2b;
        }

        .building-icon-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .building-icon {
            width: 64px;
            height: 64px;
            object-fit: contain;
            image-rendering: pixelated;
        }

        .building-description {
            margin-bottom: 25px;
            line-height: 1.5;
            color: var(--text-secondary);
        }

        .module-slots-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .modules-locked-message {
            text-align: center;
            padding: 20px;
            background: #3a3a3a;
            border: 2px dashed #7a7a7a;
            border-radius: var(--border-radius);
            color: #aaa;
            font-style: italic;
        }

        .modules-locked-message strong {
            color: var(--warning);
            font-style: normal;
        }

        .module-slot {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #3a3a3a;
            border: 1px solid #7a7a7a;
            border-radius: var(--border-radius);
        }

        .module-slot-label {
            font-weight: bold;
            min-width: 80px;
        }

        .module-select {
            flex-grow: 1;
            padding: 8px;
            background: #353535;
            border: 1px solid #7a7a7a;
            border-radius: var(--border-radius);
            color: #ddd;
        }

        .equip-btn,
        .unequip-btn {
            padding: 8px 12px;
            border: 1px solid #7a7a7a;
            background-color: #353535;
            color: #ddd;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .equip-btn:hover {
            background-color: var(--accent-primary);
            color: #111;
            border-color: var(--accent-secondary);
        }

        .unequip-btn:hover {
            background-color: var(--danger);
            color: #fff;
            border-color: var(--danger);
        }

        .building-info-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1999;
            display: none;
        }

        .module-slots-header {
            margin-bottom: 15px;
            text-align: center;
        }

        .module-slots-title {
            font-size: 16px;
            font-weight: bold;
            color: var(--accent-primary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .module-slots {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .module-slot {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100px;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 8px;
            border-radius: var(--border-radius);
            border: 2px solid #7a7a7a;
            background: #3a3a3a;
            position: relative;
        }

        .module-slot:hover {
            background: #4a4a4a;
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .module-slot.equipped {
            background: #4a5a4a;
            border-color: #66d9ff;
        }

        .module-slot-inner {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #5a5a5a;
            border-radius: var(--border-radius);
            background: #2d2d2d;
            position: relative;
            overflow: hidden;
        }

        .module-slot.equipped .module-slot-inner {
            background: #3d3d3d;
            border-color: #66d9ff;
        }

        .module-slot-icon {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .module-slot-icon img {
            width: 80%;
            height: 80%;
            object-fit: contain;
            image-rendering: pixelated;
        }

        .module-slot-empty .module-slot-icon {
            display: none;
        }

        .module-slot-tier {
            position: absolute;
            bottom: 2px;
            right: 2px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 10px;
            font-weight: bold;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #7a7a7a;
        }

        .module-slot-label {
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
        }

        .module-selection-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #353535;
            border: 3px solid #7a7a7a;
            border-radius: var(--border-radius);
            width: 350px;
            max-width: 90vw;
            max-height: 80vh;
            z-index: 2001;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            display: none;
            flex-direction: column;
            overflow: hidden;
            animation: popupFadeIn 0.3s ease;
        }

        @keyframes popupFadeIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .module-selection-header {
            padding: 15px 20px;
            background: #3a3a3a;
            border-bottom: 2px solid #7a7a7a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .module-selection-header span {
            color: var(--accent-primary);
            font-size: 1.2rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .module-close-btn {
            background: none;
            border: none;
            color: #ddd;
            cursor: pointer;
            font-size: 1.8rem;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            line-height: 1;
        }

        .module-close-btn:hover {
            background: rgba(255, 85, 85, 0.2);
            color: #ff5555;
            transform: scale(1.1);
        }

        .module-close-btn::before {
            content: "✕";
            font-family: Arial, sans-serif;
        }

        .module-options {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .module-options::-webkit-scrollbar {
            width: 8px;
        }

        .module-options::-webkit-scrollbar-track {
            background: #2a2a2a;
            border-radius: 4px;
        }

        .module-options::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }

        .module-options::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        .module-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #3a3a3a;
            border: 2px solid #7a7a7a;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .module-option:hover {
            background: var(--accent-primary);
            border-color: var(--accent-secondary);
            color: #111;
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .module-option.unaffordable {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .module-option.unaffordable:hover {
            background: #3a3a3a;
            border-color: #7a7a7a;
            color: #ddd;
            transform: none;
        }

        .module-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.25);
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 4px;
        }

        .module-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            image-rendering: pixelated;
        }

        .module-info {
            flex-grow: 1;
        }

        .module-name {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .module-cost {
            font-size: 14px;
            color: #ceab77;
            font-weight: bold;
        }

        .module-cost[data-resource="iron"]::before {
            content: "IRON ";
            color: #aaa;
            font-weight: normal;
        }

        .module-selection-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: none;
        }

        .building-special-actions {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid #555;
        }

        .building-action-btn {
            width: 100%;
            padding: 12px;
            background: #3a3a3a;
            border: 2px solid #7a7a7a;
            border-radius: var(--border-radius);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .building-action-btn:hover {
            background: #4a4a4a;
            border-color: var(--accent-primary);
            box-shadow: 0 0 15px rgba(102, 217, 255, 0.4);
        }

        .building-action-btn img {
            width: 24px;
            height: 24px;
            image-rendering: pixelated;
        }

        .action-cost {
            color: var(--accent-primary);
            font-size: 0.9rem;
            margin-left: auto;
        }

        .army-selection-modal {
            max-width: 800px;
            width: 90%;
        }

        .army-selection-info {
            margin-bottom: 20px;
            padding: 15px;
            background: #3a3a3a;
            border-radius: var(--border-radius);
            border: 2px solid #7a7a7a;
        }

        .army-selection-info p {
            margin: 0 0 10px 0;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .army-cost-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .army-cost-info span {
            color: var(--accent-primary);
            font-weight: bold;
            font-size: 1rem;
        }

        .army-units-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: #2d2d2d;
            border-radius: var(--border-radius);
        }

        .army-unit-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: #3a3a3a;
            border: 2px solid #7a7a7a;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .army-unit-item:hover {
            border-color: var(--accent-primary);
            background: #4a4a4a;
            transform: translateY(-2px);
        }

        .army-unit-item.selected {
            border-color: var(--accent-primary);
            background: #4a5a4a;
            box-shadow: 0 0 10px rgba(102, 217, 255, 0.4);
        }

        .army-unit-checkbox {
            width: 20px;
            height: 20px;
            accent-color: var(--accent-primary);
        }

        .army-unit-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #2d2d2d;
            border-radius: 4px;
            border: 1px solid #555;
        }

        .army-unit-icon img {
            width: 32px;
            height: 32px;
            image-rendering: pixelated;
        }

        .army-unit-info {
            flex: 1;
        }

        .army-unit-name {
            color: var(--text-primary);
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 4px;
        }

        .army-unit-stats {
            display: flex;
            gap: 12px;
            font-size: 0.9rem;
        }

        .army-unit-stat {
            color: var(--text-secondary);
        }

        .army-unit-stat.health {
            color: #7a977b;
        }

        .army-unit-stat.range {
            color: #ceab77;
        }

        .army-unit-stat.movement {
            color: #66d9ff;
        }

        .army-selection-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 12px 25px;
            border: 2px solid #7a7a7a;
            border-radius: var(--border-radius);
            background: #3a3a3a;
            color: var(--text-primary);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .modal-btn.secondary {
            background: #555;
            border-color: #777;
        }

        .modal-btn.secondary:hover {
            background: #666;
            border-color: #888;
        }

        .modal-btn.primary {
            background: var(--accent-primary);
            border-color: var(--accent-secondary);
            color: #111;
        }

        .modal-btn.primary:hover {
            background: var(--accent-secondary);
            box-shadow: 0 5px 15px rgba(102, 217, 255, 0.6);
        }

        .modal-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .no-army-message {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .no-army-message p {
            margin: 10px 0;
        }

        .attack-btn {
            padding: 28px 0px;
            font-size: 1.1rem;
        }

        /* Combat Menu Styles */
        .combat-modal-content {
            max-width: 900px;
            width: 90%;
            max-height: 80vh;
        }

        .combat-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .combat-resources-display {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .resource-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: linear-gradient(145deg, #404040, #353535);
            border: 2px solid #7a7a7a;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .resource-item img {
            width: 24px;
            height: 24px;
            image-rendering: pixelated;
        }

        .resource-item span {
            color: var(--text-primary);
            font-weight: bold;
            font-size: 1.1rem;
        }

        .combat-modal-body {
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .combat-setup-area {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .player-army-section h3 {
            color: var(--accent-primary);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .army-units-selector {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .combat-unit-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            background: #404040;
            border: 2px solid #7a7a7a;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .combat-unit-selector:hover {
            border-color: var(--accent-primary);
            background: #4a4a4a;
        }

        .combat-unit-checkbox {
            width: 20px;
            height: 20px;
        }

        .combat-unit-icon img {
            width: 40px;
            height: 40px;
            image-rendering: pixelated;
        }

        .combat-unit-info {
            flex: 1;
        }

        .combat-unit-name {
            color: var(--text-primary);
            font-weight: bold;
            margin-bottom: 5px;
        }

        .combat-unit-stats {
            display: flex;
            gap: 15px;
            font-size: 0.85rem;
        }

        .combat-unit-stat {
            color: var(--text-secondary);
        }

        .combat-unit-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .unit-amount-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .amount-btn {
            width: 28px;
            height: 28px;
            background: #555;
            border: 1px solid #777;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .amount-btn:hover {
            background: #666;
        }

        .unit-amount-input {
            width: 50px;
            padding: 5px;
            background: #333;
            border: 1px solid #555;
            color: var(--text-primary);
            text-align: center;
        }

        .combat-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            padding-top: 20px;
            border-top: 2px solid #555;
        }

        /* Combat Battle Styles */
        .combat-battle-content {
            max-width: 1200px;
            width: 95%;
            height: 90vh;
            display: flex;
            flex-direction: column;
            background: #353535;
            border: 3px solid #7a7a7a;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .combat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(145deg, #3a3a3a, #2d2d2d);
            border-bottom: 3px solid #7a7a7a;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .combat-status {
            color: var(--accent-primary);
            font-size: 1.5rem;
            font-weight: bold;
        }

        .combat-arena {
            flex: 1;
            display: flex;
            padding: 20px;
            gap: 20px;
            overflow: hidden;
            background: #2d2d2d;
        }

        .combat-player-side,
        .combat-fortress-side {
            width: 250px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .combat-log-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .combat-log {
            flex: 1;
            background: #2d2d2d;
            border: 2px solid #555;
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .log-entry {
            color: var(--text-secondary);
            font-size: 0.9rem;
            padding: 5px;
            border-radius: 4px;
        }

        .log-entry.player-action {
            color: var(--accent-primary);
            background: rgba(102, 217, 255, 0.1);
        }

        .log-entry.fortress-action {
            color: var(--danger);
            background: rgba(221, 126, 119, 0.1);
        }

        .player-units-container,
        .fortress-units-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex: 1;
        }

        .combat-unit-display {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: linear-gradient(145deg, #404040, #353535);
            border: 2px solid #7a7a7a;
            border-radius: 8px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .combat-unit-display:hover {
            border-color: #ceab77;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }

        .combat-unit-display-icon img {
            width: 36px;
            height: 36px;
            image-rendering: pixelated;
        }

        .combat-unit-display-info {
            flex: 1;
        }

        .combat-unit-display-name {
            color: var(--text-primary);
            font-weight: bold;
            font-size: 0.9rem;
        }

        .combat-unit-display-health {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }
        
        .combat-unit-damage-info {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .combat-unit-damage-info::before {
            content: "⚔️";
            font-size: 0.9rem;
        }

        .campfire-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: linear-gradient(145deg, #404040, #353535);
            border: 2px solid #7a7a7a;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .campfire-toggle:hover {
            border-color: #ceab77;
            background: linear-gradient(145deg, #4a4a4a, #3a3a3a);
            transform: translateY(-2px);
        }

        .campfire-toggle:hover {
            border-color: var(--accent-primary);
        }

        .campfire-toggle.active {
            border-color: #ceab77;
            background: rgba(206, 171, 119, 0.2);
        }

        .campfire-toggle img {
            width: 32px;
            height: 32px;
            image-rendering: pixelated;
        }

        .campfire-toggle span {
            color: var(--text-primary);
            font-weight: bold;
        }

        .fortress-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: linear-gradient(145deg, #404040, #353535);
            border: 2px solid #7a7a7a;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .fortress-display img {
            width: 64px;
            height: 64px;
            image-rendering: pixelated;
        }

        .fortress-health-bar {
            width: 100%;
            height: 20px;
            background: linear-gradient(145deg, #333, #2a2a2a);
            border: 2px solid #7a7a7a;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #dd7e77, #ee8e87);
            width: 72%;
            transition: width 0.3s ease;
            box-shadow: 0 0 8px rgba(221, 126, 119, 0.6);
        }

        .health-fill.low {
            background: linear-gradient(90deg, #dd7e77, #ff6b6b);
            box-shadow: 0 0 12px rgba(221, 126, 119, 0.8);
        }

        .combat-action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            background: linear-gradient(145deg, #3a3a3a, #2d2d2d);
            border-top: 3px solid #7a7a7a;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }

        .combat-btn {
            padding: 15px 40px;
            font-size: 1.1rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 2px solid #7a7a7a;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: linear-gradient(145deg, #404040, #353535);
            color: var(--text-primary);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .combat-btn:hover:not(:disabled) {
            border-color: var(--accent-primary);
            background: linear-gradient(145deg, #4a4a4a, #3a3a3a);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }

        .combat-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .combat-btn.attack-btn {
            border-color: #dd7e77;
        }

        .combat-btn.attack-btn:hover:not(:disabled) {
            border-color: #ee8e87;
            background: linear-gradient(145deg, #5a3a3a, #4a3030);
        }

        .combat-btn.defend-btn {
            border-color: #7a977b;
        }

        .combat-btn.defend-btn:hover:not(:disabled) {
            border-color: #8ba78c;
            background: linear-gradient(145deg, #3a4a3a, #304030);
        }

        /* Combat Instructions Overlay */
        .combat-instructions-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        .instruction-step {
            position: absolute;
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 25px;
            background: rgba(122, 122, 122, 0.95);
            border: 3px solid #7a7a7a;
            border-radius: 12px;
            color: #f0f0f0;
            font-weight: bold;
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 5px 20px rgba(122, 122, 122, 0.7);
            animation: instructionAppear 0.5s ease-out;
        }

        .step-1 {
            top: 30%;
            left: 50%;
            transform: translateX(-50%);
        }

        .step-2 {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .step-3 {
            bottom: 30%;
            left: 50%;
            transform: translateX(-50%);
        }


        .instruction-text {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        @keyframes instructionAppear {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        /* Campfire Effects */
        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(206, 171, 119, 0.7);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 0 10px rgba(206, 171, 119, 0.3);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(206, 171, 119, 0);
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Selected Unit Highlight */
        .selected-unit {
            position: relative;
        }

        .selected-unit::before {
            content: "";
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border: 2px dashed #66d9ff;
            border-radius: 12px;
            animation: pulseBorder 2s infinite;
            pointer-events: none;
        }

        @keyframes pulseBorder {
            0% {
                opacity: 0.5;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            100% {
                opacity: 0.5;
                transform: scale(1);
            }
        }

        /* Button Pulse Highlight */
        .pulse-highlight {
            animation: pulseButton 1.5s infinite;
        }

        @keyframes pulseButton {
            0% {
                transform: scale(1);
                box-shadow: 0 5px 15px rgba(221, 126, 119, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 8px 25px rgba(221, 126, 119, 0.8);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 5px 15px rgba(221, 126, 119, 0.4);
            }
        }

        /* Target Selection Visual Feedback */
        .fortress-display.targetable,
        .combat-unit-display.targetable {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .fortress-display.targetable:hover,
        .combat-unit-display.targetable:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        .fortress-display.target-selected,
        .combat-unit-display.target-selected {
            border: 3px solid #ceab77;
            box-shadow: 0 0 20px rgba(206, 171, 119, 0.7);
        }

        /* Skip Tutorial Button */
        .skip-tutorial-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: #555;
            color: #f0f0f0;
            border: 2px solid #7a7a7a;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 1000;
        }

        .skip-tutorial-btn:hover {
            background: #666;
            border-color: #ceab77;
            transform: translateY(-2px);
        }
    </style>
</head>

<body>
    <div class="game-container">

        <div id="homescreen-overlay" class="modal-overlay active">
            <div class="modal-content homescreen-modal homescreen-fullscreen">
                <div class="homescreen-main-content">
                    <div class="title-box">
                        <h1 class="game-title">COREGRID</h1>
                        <h2 class="game-subtitle">EXTRACTION PROTOCOL</h2>
                    </div>

                    <div class="homescreen-vault-army-section">
                        <div class="vault-panel">
                            <div class="vault-header">
                                <h2>VAULT</h2>
                                <div class="vault-storage-indicator">
                                    <span class="vault-storage-label">VALUE:</span>
                                    <span class="vault-storage-amount" id="vault-total-storage">175</span>
                                </div>
                            </div>

                            <div class="vault-resources">
                                <div class="vault-resource-item">
                                    <div class="vault-resource-icon">
                                        <img src="./sprites/ironin.png" alt="Steel">
                                    </div>
                                    <div class="vault-resource-info">
                                        <span class="vault-resource-name">STEEL</span>
                                        <span class="vault-resource-value vault-resource-amountof"
                                            id="vault-stored-steel-count">100</span>
                                    </div>
                                </div>

                                <div class="vault-resource-item">
                                    <div class="vault-resource-icon">
                                        <img src="./sprites/coin.png" alt="Coins">
                                    </div>
                                    <div class="vault-resource-info">
                                        <span class="vault-resource-name">COINS</span>
                                        <span class="vault-resource-value vault-resource-amountof"
                                            id="vault-stored-coin-count">50</span>
                                    </div>
                                </div>

                                <div class="vault-resource-item">
                                    <div class="vault-resource-icon">
                                        <img src="./sprites/goldin.png" alt="Gold">
                                    </div>
                                    <div class="vault-resource-info">
                                        <span class="vault-resource-name">GOLD</span>
                                        <span class="vault-resource-value vault-resource-amountof"
                                            id="vault-stored-gold-count">25</span>
                                    </div>
                                </div>

                                <div class="vault-resource-item">
                                    <div class="vault-resource-icon">
                                        <img src="./sprites/Oil.png" alt="Oil">
                                    </div>
                                    <div class="vault-resource-info">
                                        <span class="vault-resource-name">OIL</span>
                                        <span class="vault-resource-value vault-resource-amountof"
                                            id="vault-stored-oil-count">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="army-box" id="army-box">
                            <div class="army-box-header">
                                <h2>ARMY</h2>
                                <div class="army-unit-count" id="army-unit-count">0 units</div>
                            </div>
                            <div class="army-units-container" id="army-units-container">
                                <div class="no-army-units">
                                    <p>No army units stored</p>
                                    <p>Use the WarGate to send units from a dive.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="wiki-box">
                        <div class="wiki-header">
                            <h2>WIKI</h2>
                        </div>
                        <div class="wiki-content">
                            <p class="wiki-description">Access the complete game guide, strategies, and documentation to
                                master CoreGrid.</p>
                        </div>
                        <button class="wiki-open-btn" id="open-wiki-btn">
                            OPEN WIKI
                        </button>
                    </div>





                </div>

                <div class="homescreen-sidebar">
                    <div class="homescreen-stats-panel">
                        <div class="stats-header">
                            <h3>OPERATION STATS</h3>
                        </div>
                        <div class="stats-content">
                            <div class="stat-item">
                                <span class="stat-label">TOTAL MISSIONS:</span>
                                <span class="stat-value" id="total-missions">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">SUCCESS RATE:</span>
                                <span class="stat-value" id="success-rate">0%</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">RESOURCES COLLECTED:</span>
                                <span class="stat-value" id="resources-collected">0</span>
                            </div>

                        </div>
                    </div>


                    <div class="homescreen-buttons">
                        <button class="homescreen-button play-button" id="play-game-btn">
                            <img src="./sprites/turret.png" alt="Play">
                            START
                        </button>
                        <button class="homescreen-button attack-btn" id="attack-game-btn">
                            ATTACK
                        </button>
                        <button class="homescreen-button" id="crates-game-btn">
                            CRATES
                        </button>
                        <button class="homescreen-button" id="load-game-btn">
                            LOAD
                        </button>
                        <button class="homescreen-button" id="save-game-btn">
                            SAVE
                        </button>
                        <button class="homescreen-button discord-button" id="discord-btn">
                            DISCORD
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="zone-selection-popup" class="modal-overlay">
            <div class="modal-content zone-selection-modal">
                <div class="modal-header">
                    <h2>SELECT EXTRACTION ZONE</h2>
                    <button class="close-btn" onclick="closeZoneSelection()"></button>
                </div>
                <div class="modal-body">
                    <section class="zones-section">
                        <div class="panel-header">
                            <h2>EXTRACTION ZONES</h2>
                            <div class="risk-indicator">
                                <span class="risk-label">CURRENT STATUS:</span>
                                <span class="risk-level safe">BASE SECURE</span>
                            </div>
                        </div>

                        <div class="zone-grid">
                            <div class="zone-card" data-zone="shallow">
                                <div class="zone-header">
                                    <div class="zone-icon">
                                        <img src="./sprites/UI/Z1.png" alt="Shallow">
                                    </div>
                                    <div class="zone-title">
                                        <h3>SHALLOW DIVE</h3>
                                        <span class="zone-risk low">LOW RISK</span>
                                    </div>
                                </div>

                                <div class="zone-content">
                                    <p class="zone-description">Surface deposits with minimal hostiles. Perfect for your
                                        first dive and establishing base operations.</p>

                                    <div class="zone-rewards">
                                        <div class="reward-item">
                                            <img src="./sprites/ironin.png" alt="Steel">
                                            <span>+500</span>
                                        </div>
                                        <div class="reward-item">
                                            <img src="./sprites/coin.png" alt="Coins">
                                            <span>+250</span>
                                        </div>
                                        <div class="reward-item">
                                            <img src="./sprites/goldin.png" alt="Gold">
                                            <span>+125</span>
                                        </div>
                                        <div class="reward-item oil-reward">
                                            <img src="./sprites/Oil.png" alt="Oil">
                                            <span>+50</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="zone-footer">
                                    <button class="zone-enter-btn" data-zone="shallow">
                                        DIVE
                                    </button>
                                </div>
                            </div>

                            <div class="zone-card" data-zone="medium">
                                <div class="zone-header">
                                    <div class="zone-icon">
                                        <img src="./sprites/UI/Z2.png" alt="Medium">
                                    </div>
                                    <div class="zone-title">
                                        <h3>MEDIUM DIVE</h3>
                                        <span class="zone-risk medium">MODERATE RISK</span>
                                    </div>
                                </div>

                                <div class="zone-content">
                                    <p class="zone-description">Deeper deposits with increased hostile activity.
                                        Requires adequate defenses for successful diving operations.</p>

                                    <div class="zone-rewards">
                                        <div class="reward-item">
                                            <img src="./sprites/ironin.png" alt="Steel">
                                            <span>+750</span>
                                        </div>
                                        <div class="reward-item">
                                            <img src="./sprites/coin.png" alt="Coins">
                                            <span>+375</span>
                                        </div>
                                        <div class="reward-item">
                                            <img src="./sprites/goldin.png" alt="Gold">
                                            <span>+185</span>
                                        </div>
                                        <div class="reward-item oil-reward">
                                            <img src="./sprites/Oil.png" alt="Oil">
                                            <span>+75</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="zone-footer">
                                    <button class="zone-enter-btn" data-zone="medium">
                                        DIVE
                                    </button>
                                </div>
                            </div>

                            <div class="zone-card" data-zone="deep">
                                <div class="zone-header">
                                    <div class="zone-icon">
                                        <img src="./sprites/UI/Z3.png" alt="Deep">
                                    </div>
                                    <div class="zone-title">
                                        <h3>DEEP DIVE</h3>
                                        <span class="zone-risk high">HIGH RISK</span>
                                    </div>
                                </div>

                                <div class="zone-content">
                                    <p class="zone-description">Premium resource deposits in dangerous depths. Only for
                                        experienced divers with heavy defenses.</p>

                                    <div class="zone-rewards">
                                        <div class="reward-item">
                                            <img src="./sprites/ironin.png" alt="Steel">
                                            <span>+1000</span>
                                        </div>
                                        <div class="reward-item">
                                            <img src="./sprites/coin.png" alt="Coins">
                                            <span>+500</span>
                                        </div>
                                        <div class="reward-item">
                                            <img src="./sprites/goldin.png" alt="Gold">
                                            <span>+250</span>
                                        </div>
                                        <div class="reward-item">
                                            <img src="./sprites/Oil.png" alt="Oil">
                                            <span>+100</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="zone-footer">
                                    <button class="zone-enter-btn" data-zone="deep">
                                        DIVE
                                    </button>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>

        <div id="death-screen" class="modal-overlay">
            <div class="modal-content death-screen-content">
                <div class="death-screen-header">
                    <h2>MISSION FAILED</h2>
                    <div class="skull-icon"><i class="fas fa-skull"></i></div>
                </div>
                <div class="death-screen-body">
                    <div class="death-message">
                        <p>Your forces have been overwhelmed...</p>
                        <p>The enemies have breached your defenses.</p>
                    </div>
                    <div class="death-stats">
                        <div class="death-stat">
                            <span class="stat-label">Turns Survived:</span>
                            <span class="stat-value" id="death-turns">0</span>
                        </div>
                        <div class="death-stat">
                            <span class="stat-label">Waves Completed:</span>
                            <span class="stat-value" id="death-waves">0</span>
                        </div>
                        <div class="death-stat">
                            <span class="stat-label">Resources Lost:</span>
                            <span class="stat-value" id="death-resources">0</span>
                        </div>
                    </div>
                </div>
                <div class="death-screen-actions">
                    <button class="modal-btn secondary" id="death-return-btn">Return to Base</button>
                    <button class="modal-btn primary" id="death-retry-btn">Retry Mission</button>
                </div>
            </div>
        </div>

        <div id="combat-menu" class="modal-overlay">
            <div class="modal-content combat-modal-content">
                <div class="modal-header">
                    <div class="combat-menu-header">
                        <h2>COMBAT MENU</h2>
                        <div class="combat-resources-display">
                            <div class="resource-item">
                                <img src="./sprites/oil.png" alt="Oil">
                                <span id="combat-oil-count">0</span>
                            </div>
                        </div>
                    </div>
                    <button class="close-btn" onclick="closeCombatMenu()"></button>
                </div>
                <div class="combat-modal-body">
                    <div class="combat-setup-area">
                        <div class="player-army-section">
                            <h3>YOUR ARMY</h3>
                            <div class="army-units-selector" id="combat-army-selector">
                                <!-- Army units will be populated here -->
                            </div>
                        </div>
                        
                        <div class="combat-controls">
                            <button class="modal-btn primary" id="start-combat-btn" disabled>START BATTLE</button>
                            <button class="modal-btn secondary" onclick="closeCombatMenu()">CANCEL</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Crate Opening Result Modal -->
        <div id="crate-result-modal" class="modal-overlay">
            <div class="modal-content crate-result-content">
                <div class="modal-header">
                    <h2>CRATE OPENED!</h2>
                    <button class="close-btn" onclick="closeCrateResultModal()"></button>
                </div>
                <div class="modal-body crate-result-body">
                    <div class="crate-result-info">
                        <div class="result-header">
                            <h3 id="result-crate-name">Ore Crate L1</h3>
                            <div class="result-sprite-placeholder" id="result-sprite">
                                <img src="" alt="Crate Sprite">
                            </div>
                        </div>
                        <div class="result-details">
                            <div class="reward-display" id="reward-display">
                                <!-- Rewards will be populated here -->
                            </div>
                            <div class="result-message" id="result-message">
                                <!-- Win/Loss message will appear here -->
                            </div>
                        </div>
                        <div class="result-actions">
                            <button class="modal-btn primary" onclick="closeCrateResultModal()">CONTINUE</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="crates-modal" class="modal-overlay">
            <div class="modal-content crates-modal-content">
                <div class="modal-header">
                    <h2>CRATES</h2>
                    <button class="close-btn" onclick="closeCratesModal()"></button>
                </div>
                <div class="modal-body crates-modal-body">
                    <div class="crates-intro">
                        <p>Purchase crates with your resources for a chance at valuable rewards!</p>
                        <p>Higher level crates offer bigger rewards but with increased risk!</p>
                    </div>
                    
                    <div class="crates-container">
                        <div class="crate-type ore-crates">
                            <h3>Ore Crates</h3>
                            <div class="crate-levels">
                                <div class="crate-item" data-crate="ore" data-level="1">
                                    <div class="crate-sprite">
                                        <img src="./sprites/smallcrate.png" alt="Small Ore Crate" onerror="this.src='./sprites/default_crate.png'">
                                    </div>
                                    <div class="crate-header">
                                        <span class="crate-name">Ore Crate L1</span>
                                        <span class="crate-cost">1,000 COINS</span>
                                    </div>
                                    <div class="crate-rewards">
                                        <span>Steel, Coins, Gold</span>
                                        <span class="min-reward">Min: 200</span>
                                        <span class="max-reward">Max: 2,000</span>
                                    </div>
                                    <button class="crate-buy-btn" onclick="buyCrate('ore', 1)">BUY CRATE</button>
                                </div>
                                
                                <div class="crate-item" data-crate="ore" data-level="2">
                                    <div class="crate-sprite">
                                        <img src="./sprites/bigcrate.png" alt="Big Ore Crate" onerror="this.src='./sprites/default_crate.png'">
                                    </div>
                                    <div class="crate-header">
                                        <span class="crate-name">Ore Crate L2</span>
                                        <span class="crate-cost">2,000 COINS</span>
                                    </div>
                                    <div class="crate-rewards">
                                        <span>Steel, Coins, Gold</span>
                                        <span class="min-reward">Min: 400</span>
                                        <span class="max-reward">Max: 4,000</span>
                                    </div>
                                    <button class="crate-buy-btn" onclick="buyCrate('ore', 2)">BUY CRATE</button>
                                </div>
                                
                                <div class="crate-item" data-crate="ore" data-level="3">
                                    <div class="crate-sprite">
                                        <img src="./sprites/bigcrate.png" alt="Big Ore Crate" onerror="this.src='./sprites/default_crate.png'">
                                    </div>
                                    <div class="crate-header">
                                        <span class="crate-name">Ore Crate L3</span>
                                        <span class="crate-cost">3,000 COINS</span>
                                    </div>
                                    <div class="crate-rewards">
                                        <span>Steel, Coins, Gold</span>
                                        <span class="min-reward">Min: 600</span>
                                        <span class="max-reward">Max: 10,000</span>
                                    </div>
                                    <button class="crate-buy-btn" onclick="buyCrate('ore', 3)">BUY CRATE</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="crate-type oil-crates">
                            <h3>Oil Crates</h3>
                            <div class="crate-levels">
                                <div class="crate-item" data-crate="oil" data-level="1">
                                    <div class="crate-sprite">
                                        <img src="./sprites/smallcrate.png" alt="Small Oil Crate" onerror="this.src='./sprites/default_crate.png'">
                                    </div>
                                    <div class="crate-header">
                                        <span class="crate-name">Oil Crate L1</span>
                                        <span class="crate-cost">3,000 STEEL</span>
                                    </div>
                                    <div class="crate-rewards">
                                        <span>Oil Only</span>
                                        <span class="min-reward">Min: 150</span>
                                        <span class="max-reward">Max: 1,500</span>
                                    </div>
                                    <button class="crate-buy-btn" onclick="buyCrate('oil', 1)">BUY CRATE</button>
                                </div>
                                
                                <div class="crate-item" data-crate="oil" data-level="2">
                                    <div class="crate-sprite">
                                        <img src="./sprites/bigcrate.png" alt="Big Oil Crate" onerror="this.src='./sprites/default_crate.png'">
                                    </div>
                                    <div class="crate-header">
                                        <span class="crate-name">Oil Crate L2</span>
                                        <span class="crate-cost">4,000 STEEL</span>
                                    </div>
                                    <div class="crate-rewards">
                                        <span>Oil Only</span>
                                        <span class="min-reward">Min: 200</span>
                                        <span class="max-reward">Max: 4,000</span>
                                    </div>
                                    <button class="crate-buy-btn" onclick="buyCrate('oil', 2)">BUY CRATE</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="crate-type free-crates">
                            <h3>Free Crates</h3>
                            <div class="crate-levels">
                                <div class="crate-item" id="daily-crate-item">
                                    <div class="crate-sprite">
                                        <img src="./sprites/smallcrate.png" alt="Daily Crate" onerror="this.src='./sprites/default_crate.png'">
                                    </div>
                                    <div class="crate-header">
                                        <span class="crate-name">Daily Crate</span>
                                        <span class="crate-cost">FREE</span>
                                    </div>
                                    <div class="daily-streak">
                                        <div class="streak-counter">Day <span id="current-streak">1</span></div>
                                        <div class="streak-rewards">Streak: <span id="streak-rewards">500S 250C 250G 50O</span></div>
                                    </div>
                                    <div class="crate-rewards">
                                        <span>Daily Resources</span>
                                        <span class="min-reward">Guaranteed</span>
                                        <span class="max-reward">Double Each Day</span>
                                    </div>
                                    <button class="crate-buy-btn" id="claim-daily-btn" onclick="claimDailyCrate()">CLAIM DAILY</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="combat-battle" class="modal-overlay">
            <div class="modal-content combat-battle-content">
                <div class="combat-header">
                    <div class="combat-status">
                        <span id="fortress-health">72/100</span>
                    </div>
                    <button class="close-btn" onclick="exitCombat()"></button>
                </div>
                
                <div class="combat-arena">
                    <div class="combat-player-side">
                        <div class="player-units-container" id="player-units-combat">
                            <!-- Player units displayed here -->
                        </div>
                        <div class="campfire-toggle" id="campfire-toggle">
                            <img src="./sprites/campfire.gif" alt="Campfire">
                            <span>CAMPFIRE: OFF</span>
                        </div>
                    </div>
                    
                    <div class="combat-log-container">
                        <div class="combat-log" id="combat-log">
                            <div class="log-entry">Battle started!</div>
                        </div>
                    </div>
                    
                    <div class="combat-fortress-side">
                        <div class="fortress-units-container" id="fortress-units-combat">
                            <!-- Fortress units displayed here -->
                        </div>
                        <div class="fortress-display">
                            <img src="./sprites/spawn.png" alt="Fortress">
                            <div class="fortress-health-bar">
                                <div class="health-fill" id="fortress-health-bar"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="combat-action-buttons">
                    <button class="combat-btn attack-btn" id="combat-attack-btn">ATTACK</button>
                    <button class="combat-btn defend-btn" id="combat-defend-btn">DEFEND</button>
                </div>
            </div>
        </div>

        <div id="wiki-modal" class="modal-overlay">
            <div class="modal-content wiki-modal-content">
                <div class="modal-header">
                    <h2>COREGRID WIKI </h2>
                    <button class="close-btn" onclick="closeWikiModal()"></button>
                </div>
                <div class="wiki-modal-body">
                    <div class="wiki-sidebar">
                        <div class="wiki-search">
                            <input type="text" id="wiki-search-input" placeholder="Search wiki..."
                                class="wiki-search-input">
                        </div>
                        <div class="wiki-categories">
                            <div class="wiki-category" data-category="basics">
                                <h3>Core Basics</h3>
                                <ul class="wiki-pages-list">
                                    <li class="wiki-page-item" data-target="introduction-article">Introduction</li>
                                    <li class="wiki-page-item" data-target="zones-guide-article">Zones & Progression
                                    </li>
                                </ul>
                            </div>
                            <div class="wiki-category" data-category="advanced">
                                <h3>More</h3>
                                <ul class="wiki-pages-list">
                                    <li class="wiki-page-item" data-target="research-modules-article">Extraction</li>
                                    <li class="wiki-page-item" data-target="strategy-guide-article">Extras</li>
                                    <li class="wiki-page-item" data-target="unit-transfer-article">Unit Transfer</li>
                                    <li class="wiki-page-item" data-target="combat-article">Combat System</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="wiki-content-area">
                        <div id="wiki-content-display" class="wiki-content-display">
                            <div id="wiki-articles-container">
                                <div id="wiki-home-content" class="wiki-article-content active">
                                    <div class="wiki-home-content">
                                        <h2>Welcome to the CoreGrid Wiki</h2>
                                        <p>The wiki is a work in progress but there are already some articles available. </p>
                                    </div>
                                </div>

                                <div id="introduction-article" class="wiki-article-content">
                                    <div class="wiki-article">
                                        <h1>General Things Welcome</h1>
                                        <p>So you wanna play CoreGrid? Here's what you need to know to get started!</p>
                                        <p>Just saying that this game is NOT finished yet.</p>

                                        <h2>Essential Controls</h2>
                                        <p><strong>Navigation:</strong> Use the arrow keys to look around the
                                            battlefield. This helps you survey your defenses and plan your strategy.</p>

                                        <h2>Core Objective</h2>
                                        <div style="display: flex; align-items: center; gap: 15px; margin: 15px 0;">
                                            <img src="./sprites/spawn.png" alt="Fortress"
                                                style="width: 48px; height: 48px; image-rendering: pixelated;">
                                            <p><strong>Protect Your Core:</strong> The enemies should never touch your
                                                fortress (castle/fortress). If they reach it, it's game over!</p>
                                        </div>

                                        <h2>Getting Started Strategy</h2>
                                        <ol>
                                            <li><strong>Build Economy:</strong> Start by placing iron mines (Steel
                                                Mines) to generate resources</li>
                                            <li><strong>Research Path:</strong> Work your way up the tech tree until you
                                                can build turrets</li>
                                            <li><strong>Defense Setup:</strong> Once you have turrets, focus on creating
                                                effective defensive positions</li>
                                        </ol>

                                        <h2>Game Progression Options</h2>
                                        <ul>
                                            <li><strong>Completion Route:</strong> Follow the tech tree all the way to
                                                completion for a significant resource boost</li>
                                            <li><strong>Extraction Route:</strong> Extract your resources before
                                                finishing the tech tree to the vault, this will end the game too.</li>
                                            <li><strong>Hybrid Approach:</strong> Play for a while, extract when your
                                                done.</li>
                                        </ul>

                                        <div class="wiki-tip">
                                            <h4>Pro Tip</h4>
                                            <p>Don't rush to harder zones. Take your time to build a solid economy. It's
                                                almost impossible to live without a massive resource pile.</p>
                                        </div>
                                    </div>
                                </div>

                                <div id="zones-guide-article" class="wiki-article-content">
                                    <div class="wiki-article">
                                        <h1>Zone System & Progression</h1>
                                        <p>Navigate CoreGrid's three extraction zones, each requiring more accumulated
                                            resources than the last.</p>

                                        <h2>Zone Details</h2>

                                        <h3>Shallow Dive</h3>
                                        <p><strong>Risk:</strong> Low | <strong>Rewards:</strong> +500 Steel, +250
                                            Coins, +125 Gold, +50 Oil<br>
                                            Great for establishing economy and Starting with the game.</p>

                                        <h3>Medium Dive</h3>
                                        <p><strong>Risk:</strong> Moderate | <strong>Rewards:</strong> +750 Steel, +375
                                            Coins, +185 Gold, +75 Oil<br>
                                            Requires solid amounts base of resources. <br>

                                        <h3>Deep Dive</h3>
                                        <p><strong>Risk:</strong> High | <strong>Rewards:</strong> +1000 Steel, +500
                                            Coins, +250 Gold, +100 Oil<br>
                                            Demands substantial resource stockpiles and effective strategies.</p>

                                        <h2>Zone Mechanics</h2>
                                        <ul>
                                            <li><strong>Investments:</strong> You should really think about how much you
                                                bring down for each zone, as it affects your chances of success.</li>
                                            <li><strong>Temporary Setup:</strong> All researchs will be erased after
                                                each extration.</li>
                                            <li><strong>Wave Survival:</strong> Enemies can will get exponentially
                                                harder to defeat and more will spawn.</li>
                                        </ul>

                                    </div>
                                </div>

                                <div id="research-modules-article" class="wiki-article-content">
                                    <div class="wiki-article">
                                        <h1>Extraction</h1>
                                        <p>Some basics about Extracting resources</p>

                                        <h2>When to extract</h2>
                                        <p>The best time to extract depends on your play style, if you want the bonus
                                            extract after you research everything, if you dont want to take a risk just
                                            extract when you have over 2000 of most things.</p>
                                        <ul>
                                            <li><strong>Completion Route:</strong> Wait till you finish the techtree for
                                                the bonus.</li>
                                            <li><strong>Extraction Route:</strong> Only stock pile resorces for a bit
                                                then Extract and take the resorce to Home.</li>
                                        </ul>



                                    </div>
                                </div>

                                <div id="strategy-guide-article" class="wiki-article-content">
                                    <div class="wiki-article">
                                        <h1>Extra tech to know.</h1>
                                        <p>These are some extra small things to look out for.</p>

                                        <h2>Small Tech:</h2>
                                        <ul>
                                            <li><strong>Campfire Boosting:</strong> 50% production increase for
                                                buildings around them.</li>
                                            <li><strong>Oil Rig:</strong> You cant place the Oil rig beside a campfire
                                                this meaning making oil can be sped up only by speed modules.</li>
                                            <li><strong>Supply Drops:</strong> Supply drops are a mix of all miner
                                                units, they give a random amount of a random item every round.</li>
                                        </ul>

                                        <h2>Module System</h2>
                                        <p>Click on buildings to bring up the menu.</p>
                                        <ul>
                                            <li><strong>Speed Modules:</strong> 2x/3x/4x movement range boost -
                                                145/290/580 Steel</li>
                                            <li><strong>Defense Modules:</strong> 2x/3x/4x health boost - 50/100/200
                                                Steel</li>


                                            <div class="wiki-warning">
                                                <h4>Little heads up</h4>
                                                <p>Unlike traditional tower defense games, success comes from resource
                                                    accumulation rather than permanent base building. Focus on
                                                    stockpiling
                                                    vault resources to tackle increasingly difficult zones.</p>
                                            </div>
                                    </div>
                                </div>

                                <div id="unit-transfer-article" class="wiki-article-content">
                                    <div class="wiki-article">
                                        <h1>Sending Units from Dive to Base</h1>
                                        <p>Learn how to move your units between dive missions and your home base.</p>

                                        <h2>Basic Steps</h2>
                                        
                                        <h3>1. Buy and Place Units</h3>
                                        <ul>
                                            <li>Buy units during your dive using collected resources</li>
                                            <li>Place them on the grid to fight waves</li>
                                            <li>These units can later be sent to your base</li>
                                        </ul>

                                        <h3>2. Unlock War Gate</h3>
                                        <ul>
                                            <li>Research War Gate technology in the tech tree</li>
                                            <li>This lets you teleport units back to base</li>
                                            <li>Needs lots of resources to unlock</li>
                                        </ul>

                                        <h3>3. Build War Gate</h3>
                                        <ul>
                                            <li>Cost: 150 Steel, 100 Gold, 75 Oil</li>
                                            <li>Place it anywhere on your grid</li>
                                            <li>Lasts for 50 uses</li>
                                            <li>Each teleport costs 50 oil</li>
                                        </ul>

                                        <h3>4. Choose Units to Send</h3>
                                        <ul>
                                            <li>Click the War Gate on the grid</li>
                                            <li>Select which units to send back</li>
                                            <li>You can pick multiple units</li>
                                        </ul>

                                        <h3>5. Send Them Home</h3>
                                        <ul>
                                            <li>Confirm your choices</li>
                                            <li>Pay the oil cost</li>
                                            <li>Units go straight to your base storage</li>
                                            <li>They're gone from the current dive forever</li>
                                        </ul>

                                        <h2>Smart Tips</h2>
                                        
                                        <h3>When to Send Units</h3>
                                        <ul>
                                            <li>Send during easy waves when you don't need all units</li>
                                            <li>Don't send everything mid-dive</li>
                                            <li>Save good units for your base army</li>
                                        </ul>

                                        <h3>Which Units to Send</h3>
                                        <ul>
                                            <li>Send expensive, high-tier units</li>
                                            <li>Keep cheap units for fighting</li>
                                            <li>Think about what you'll need later</li>
                                        </ul>

                                        <div class="wiki-tip">
                                            <h4>Pro Tip</h4>
                                            <p>Build several War Gates early in long dives. This lets you slowly build your base army while still defending.</p>
                                        </div>

                                        <div class="wiki-warning">
                                            <h4>Warning</h4>
                                            <p>Once you send units to base, you can't get them back in the same dive. Make sure you won't need them for remaining waves!</p>
                                        </div>
                                    </div>
                                </div>

                                <div id="combat-article" class="wiki-article-content">
                                    <div class="wiki-article">
                                        <h1>Combat System Guide</h1>
                                        <p>Combat is still in work. Learn how combat works in CoreGrid and how to effectively use your army units.</p>

                                        <h2>Basic Combat</h2>
                                        <p>Combat happens when you attack the enemy fortress. You use units from your base army to fight against fortress guards and the main fortress.</p>

                                        <h3>Starting Combat</h3>
                                        <ul>
                                            <li>Click the ATTACK button on the homescreen</li>
                                            <li>Select which units from your army you want to use</li>
                                            <li>Each unit type has different stats and abilities</li>
                                            <li>You can send multiple units of the same type</li>
                                        </ul>

                                        <h2>Unit Types and Stats</h2>
                                        
                                        <h3>Soldier (Scout)</h3>
                                        <ul>
                                            <li>Health: 1 | Damage: 1 | Range: 1 | Movement: 1</li>
                                            <li>Basic unit with balanced stats</li>
                                            <li>Good for early game and filling gaps</li>
                                        </ul>

                                        <h3>Knight</h3>
                                        <ul>
                                            <li>Health: 1 | Damage: 2 | Range: 1 | Movement: 5</li>
                                            <li>Fast-moving unit with high mobility</li>
                                            <li>Great for getting into position quickly</li>
                                        </ul>

                                        <h3>Archer</h3>
                                        <ul>
                                            <li>Health: 1 | Damage: 2 | Range: 4 | Movement: 1</li>
                                            <li>Ranged unit that attacks from distance</li>
                                            <li>Safe attacking but slow movement</li>
                                        </ul>

                                        <h3>Tank</h3>
                                        <ul>
                                            <li>Health: 5 | Damage: 3 | Range: 1 | Movement: 1</li>
                                            <li>Heavy unit with high health</li>
                                            <li>Excellent for soaking damage</li>
                                        </ul>

                                        <h3>Siege Tower</h3>
                                        <ul>
                                            <li>Health: 1 | Damage: 1 | Range: 4 | Movement: 1</li>
                                            <li>Powerful siege unit with long range</li>
                                        </ul>

                                        <h3>King</h3>
                                        <ul>
                                            <li>Health: 25 | Damage: 4 | Range: 2 | Movement: 2</li>
                                            <li>Command unit that boosts nearby army</li>
                                            <li>Very expensive but powerful</li>
                                        </ul>

                                        <h2>Combat Mechanics</h2>

                                        <h3>Turn-Based Fighting</h3>
                                        <ul>
                                            <li>Combat works in turns alternating between you and the fortress</li>
                                            <li>On your turn, choose Attack or Defend</li>
                                            <li>Fortress will also choose Attack or Defend</li>
                                            <li>Different combinations have different outcomes</li>
                                        </ul>

                                        <h3>Action Outcomes</h3>
                                        <ul>
                                            <li><strong>Both Attack:</strong> You deal damage to fortress or guards</li>
                                            <li><strong>Both Defend:</strong> Nothing happens, both sides stay safe</li>
                                            <li><strong>You Attack, Fortress Stands:</strong> You deal damage to fortress or guards</li>
                                            <li><strong>You Defend, Fortress Attacks:</strong> Fortress deals damage to your unit</li>
                                        </ul>

                                        <h3>Stacking Units</h3>
                                        <ul>
                                            <li>You can send multiple units of the same type</li>
                                            <li>Damage is multiplied by the number of units</li>
                                            <li>Stacks share health pool but multiply damage output</li>
                                        </ul>

                                        <h2>Strategies</h2>

                                        <h3>More</h3>
                                        <ul>
                                            <li>Activate campfire for 100 oil per attack</li>
                                            <li>Gives 1.5x damage boost to your attacks</li>
                                            <li>Great for breaking through tough defenses</li>
                                            <li>Only use when you have plenty of oil</li>
                                        </ul>


                                        <div class="wiki-warning">
                                            <h4>Warning</h4>
                                            <p>Units used in combat are permanently lost. Even if you win.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="wiki-search-modal" class="modal-overlay">
            <div class="modal-content wiki-search-modal-content">
                <div class="modal-header">
                    <h2>SEARCH WIKI</h2>
                    <button class="close-btn" onclick="closeSearchModal()"></button>
                </div>
                <div class="wiki-search-modal-body">
                    <div class="wiki-search-container">
                        <div class="wiki-search-bar">
                            <input type="text" id="search-modal-input" placeholder="Search for articles..."
                                class="wiki-search-input">
                            <button id="search-modal-btn" class="wiki-search-btn"><i class="fas fa-search"></i></button>
                        </div>
                        <div id="search-results-container" class="search-results-container">
                            <div class="search-placeholder">
                                <div class="search-icon"><i class="fas fa-search"></i></div>
                                <div class="search-instruction">Type to search through wiki articles</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="active-zone-view" class="screen-view">
            <nav class="game-navbar">
                <div class="nav-section nav-current-zone">
                    <span class="nav-label">CURRENT DIVE:</span>
                    <span class="nav-value zone-name" id="current-zone-display">SHALLOW DIVE</span>
                </div>

                <div class="nav-section nav-right-group">
                    <div class="folder-bar">
                        <div class="folder-item" data-folder>
                            <div class="folder-trigger">
                                <img src="./sprites/wall.png" alt="Walls">
                                <span>Walls</span>
                            </div>
                            <div class="folder-dropdown">
                                <div class="dropdown-content">
                                    <button class="dropdown-btn" id="place-wall"
                                        data-info="Wall,Basic defensive structure to block enemy movement,Health: 1">
                                        <div class="dropdown-btn-header">
                                            <img src="./sprites/wall.png" alt="Wall">
                                            <span class="dropdown-btn-title">Wall</span>
                                            <div class="dropdown-btn-cost">
                                                <div class="cost-resource">
                                                    <img src="./sprites/ironin.png" alt="Steel">
                                                    <span>10</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="dropdown-btn-description">Basic defensive structure to block enemy movement</div>
                                        <div class="dropdown-btn-stats">
                                            <span class="stat-badge health">Health: 1</span>
                                        </div>
                                    </button>
                                    <button class="dropdown-btn" id="place-steel-wall"
                                        data-info="Steel Wall,Stronger wall with increased durability,Health: 3,Requires: Advanced Defense">
                                        <div class="dropdown-btn-header">
                                            <img src="./sprites/wallsteel.png" alt="Steel Wall">
                                            <span class="dropdown-btn-title">Steel Wall</span>
                                            <div class="dropdown-btn-cost">
                                                <div class="cost-resource">
                                                    <img src="./sprites/ironin.png" alt="Steel">
                                                    <span>20</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="dropdown-btn-description">Stronger wall with increased durability</div>
                                        <div class="dropdown-btn-stats">
                                            <span class="stat-badge health">Health: 3</span>
                                            <span class="stat-badge">Requires: Advanced Defense</span>
                                        </div>
                                    </button>
                                    <button class="dropdown-btn" id="place-spike"
                                        data-info="Spike,Damages enemies that walk over it,Health: 3,Requires: Spike Traps">
                                        <div class="dropdown-btn-header">
                                            <img src="./sprites/spike.png" alt="Spike">
                                            <span class="dropdown-btn-title">Spike</span>
                                            <div class="dropdown-btn-cost">
                                                <div class="cost-resource">
                                                    <img src="./sprites/ironin.png" alt="Steel">
                                                    <span>15</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="dropdown-btn-description">Damages enemies that walk over it</div>
                                        <div class="dropdown-btn-stats">
                                            <span class="stat-badge health">Health: 3</span>
                                            <span class="stat-badge">Requires: Spike Traps</span>
                                        </div>
                                    </button>
                                    <button class="dropdown-btn" id="place-castle-wall"
                                        data-info="Castle Wall,Strong defensive wall structure,Health: 25,Requires: Castle Wall">
                                        <div class="dropdown-btn-header">
                                            <img src="./sprites/Castle_wall.png" alt="Castle Wall">
                                            <span class="dropdown-btn-title">Castle Wall</span>
                                            <div class="dropdown-btn-cost">
                                                <div class="cost-resource">
                                                    <img src="./sprites/goldin.png" alt="Gold">
                                                    <span>25</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="dropdown-btn-description">Strong defensive wall structure</div>
                                        <div class="dropdown-btn-stats">
                                            <span class="stat-badge health">Health: 25</span>
                                            <span class="stat-badge">Requires: Castle Wall</span>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="folder-item" data-folder>
                            <div class="folder-trigger">
                                <img src="./sprites/turret.png" alt="Tech">
                                <span>Tech</span>
                            </div>
                            <div class="folder-dropdown">
                                <div class="dropdown-content">
                                    <button class="dropdown-btn" id="place-tech"
                                        data-info="Steel Mine,Generates 5 steel per turn,Health: 2,Requires: Fortress">
                                        <div class="dropdown-btn-header">
                                            <img src="./sprites/iron.png" alt="Steel Mine">
                                            <span class="dropdown-btn-title">Steel Mine</span>
                                            <div class="dropdown-btn-cost">
                                                <div class="cost-resource">
                                                    <img src="./sprites/ironin.png" alt="Steel">
                                                    <span>20</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="dropdown-btn-description">Generates 5 steel per turn</div>
                                        <div class="dropdown-btn-stats">
                                            <span class="stat-badge health">Health: 2</span>
                                            <span class="stat-badge">Requires: Fortress</span>
                                        </div>
                                    </button>
                                    <button class="dropdown-btn" id="place-gold-miner"
                                        data-info="Gold Mine,Generates 1 gold per turn,Health: 2,Requires: Advanced Mining">
                                        <div class="dropdown-btn-header">
                                            <img src="./sprites/gold.png" alt="Gold Mine">
                                            <span class="dropdown-btn-title">Gold Mine</span>
                                            <div class="dropdown-btn-cost">
                                                <div class="cost-resource">
                                                    <img src="./sprites/ironin.png" alt="Steel">
                                                    <span>25</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="dropdown-btn-description">Generates 1 gold per turn</div>
                                        <div class="dropdown-btn-stats">
                                            <span class="stat-badge health">Health: 2</span>
                                            <span class="stat-badge">Requires: Advanced Mining</span>
                                        </div>
                                    </button>
                                    <button class="dropdown-btn" id="place-coin-maker"
                                        data-info="Bank,Generates 5 coins per turn,Health: 2,Requires: Advanced Mining">
                                        <div class="dropdown-btn-header">
                                            <img src="./sprites/bank.png" alt="Bank">
                                            <span class="dropdown-btn-title">Bank</span>
                                            <div class="dropdown-btn-cost">
                                                <div class="cost-resource">
                                                    <img src="./sprites/ironin.png" alt="Steel">
                                                    <span>30</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="dropdown-btn-description">Generates 5 coins per turn</div>
                                        <div class="dropdown-btn-stats">
                                            <span class="stat-badge health">Health: 2</span>
                                            <span class="stat-badge">Requires: Advanced Mining</span>
                                        </div>
                                    </button>
                                    <button class="dropdown-btn" id="place-turret"
                                        data-info="Turret,Attacks enemies within range 3,Health: 2,Shots: 8,Requires: Fortress">
                                        <div class="dropdown-btn-header">
                                            <img src="./sprites/turret.png" alt="Turret">
                                            <span class="dropdown-btn-title">Turret</span>
                                            <div class="dropdown-btn-cost">
                                                <div class="cost-resource">
                                                    <img src="./sprites/ironin.png" alt="Steel">
                                                    <span>40</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="dropdown-btn-description">Attacks enemies within range 3</div>
                                        <div class="dropdown-btn-stats">
                                            <span class="stat-badge health">Health: 2</span>
                                            <span class="stat-badge range">Range: 3</span>
                                            <span class="stat-badge">Shots: 8</span>
                                            <span class="stat-badge">Requires: Fortress</span>
                                        </div>
                                    </button>
                                    <button class="dropdown-btn" id="place-gold-turret"
                                        data-info="Gold Turret,Powerful turret with range 3,Health: 2,Shots: 10,Requires: Fortified Defense">
                                        <div class="dropdown-btn-header">
                                            <img src="./sprites/goldturret.png" alt="Gold Turret">
                                            <span class="dropdown-btn-title">Gold Turret</span>
                                            <div class="dropdown-btn-cost">
                                                <div class="cost-resource">
                                                    <img src="./sprites/goldin.png" alt="Gold">
                                                    <span>200</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="dropdown-btn-description">Powerful turret with range 3</div>
                                        <div class="dropdown-btn-stats">
                                            <span class="stat-badge health">Health: 2</span>
                                            <span class="stat-badge range">Range: 3</span>
                                            <span class="stat-badge">Shots: 10</span>
                                            <span class="stat-badge">Requires: Fortified Defense</span>
                                        </div>
                                    </button>
                                    <button class="dropdown-btn" id="place-bomb"
                                        data-info="Bomb,Explodes when enemy approaches damaging area,Health: 1,Requires: Spike Traps">
                                        <div class="dropdown-btn-header">
                                            <img src="./sprites/bomb.png" alt="Bomb">
                                            <span class="dropdown-btn-title">Bomb</span>
                                            <div class="dropdown-btn-cost">
                                                <div class="cost-resource">
                                                    <img src="./sprites/goldin.png" alt="Gold">
                                                    <span>10</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="dropdown-btn-description">Explodes when enemy approaches damaging area</div>
                                        <div class="dropdown-btn-stats">
                                            <span class="stat-badge health">Health: 1</span>
                                            <span class="stat-badge">Requires: Spike Traps</span>
                                        </div>
                                    </button>
                                    <button class="dropdown-btn" id="place-supply"
                                        data-info="Supply Drop,Randomly generates resources,Health: 1,Requires: Supply Systems">
                                        <div class="dropdown-btn-header">
                                            <img src="./sprites/supply.gif" alt="Supply Drop">
                                            <span class="dropdown-btn-title">Supply Drop</span>
                                            <div class="dropdown-btn-cost">
                                                <div class="cost-resource">
                                                    <img src="./sprites/goldin.png" alt="Gold">
                                                    <span>35</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="dropdown-btn-description">Randomly generates resources</div>
                                        <div class="dropdown-btn-stats">
                                            <span class="stat-badge health">Health: 1</span>
                                            <span class="stat-badge">Requires: Supply Systems</span>
                                        </div>
                                    </button>
                                    <button class="dropdown-btn" id="place-oil-rig"
                                        data-info="Oil Rig,Generates 1 oil per turn,Health: 2,Requires: Oil Rig Tech">
                                        <div class="dropdown-btn-header">
                                            <img src="./sprites/oilrig.png" alt="Oil Rig">
                                            <span class="dropdown-btn-title">Oil Rig</span>
                                            <div class="dropdown-btn-cost">
                                                <div class="cost-resource">
                                                    <img src="./sprites/ironin.png" alt="Steel">
                                                    <span>35</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="dropdown-btn-description">Generates 1 oil per turn</div>
                                        <div class="dropdown-btn-stats">
                                            <span class="stat-badge health">Health: 2</span>
                                            <span class="stat-badge">Requires: Oil Rig Tech</span>
                                        </div>
                                    </button>
                                    <button class="dropdown-btn" id="place-campfire"
                                        data-info="Campfire,Boosts nearby resource buildings by 50%,Health: 1,Requires: Resource Management">
                                        <div class="dropdown-btn-header">
                                            <img src="./sprites/campfire.gif" alt="Campfire">
                                            <span class="dropdown-btn-title">Campfire</span>
                                            <div class="dropdown-btn-cost">
                                                <div class="cost-resource">
                                                    <img src="./sprites/ironin.png" alt="Steel">
                                                    <span>30</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="dropdown-btn-description">Boosts nearby resource buildings by 50%</div>
                                        <div class="dropdown-btn-stats">
                                            <span class="stat-badge health">Health: 1</span>
                                            <span class="stat-badge">Requires: Resource Management</span>
                                        </div>
                                    </button>
                                    <button class="dropdown-btn" id="place-warpgate"
                                        data-info="Warpgate,Teleports deployed armies back to base,Health: 3,Requires: Advanced Army,Uses: 50 oil per teleport">
                                        <div class="dropdown-btn-header">
                                            <img src="./sprites/wargate.png" alt="Warpgate">
                                            <span class="dropdown-btn-title">Warpgate</span>
                                            <div class="dropdown-btn-cost">
                                                <div class="cost-resource">
                                                    <img src="./sprites/ironin.png" alt="Steel">
                                                    <span>150</span>
                                                </div>
                                                <div class="cost-resource">
                                                    <img src="./sprites/goldin.png" alt="Gold">
                                                    <span>100</span>
                                                </div>
                                                <div class="cost-resource">
                                                    <img src="./sprites/Oil.png" alt="Oil">
                                                    <span>75</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="dropdown-btn-description">Teleports deployed armies back to base</div>
                                        <div class="dropdown-btn-stats">
                                            <span class="stat-badge health">Health: 3</span>
                                            <span class="stat-badge">Requires: Advanced Army</span>
                                            <span class="stat-badge">Uses: 50 oil per teleport</span>
                                        </div>
                                    </button>
                                    <button class="dropdown-btn" id="place-camp-tower"
                                        data-info="Camp Tower,Turret-like building that shoots enemies in 3x3 area,Health: 2,Range: 3,Cost: 70 Iron 80 Coins,Requires: Siege Weapons">
                                        <div class="dropdown-btn-header">
                                            <img src="./sprites/camptower.png" alt="Camp Tower">
                                            <span class="dropdown-btn-title">Camp Tower</span>
                                            <div class="dropdown-btn-cost">
                                                <div class="cost-resource">
                                                    <img src="./sprites/ironin.png" alt="Steel">
                                                    <span>70</span>
                                                </div>
                                                <div class="cost-resource">
                                                    <img src="./sprites/coin.png" alt="Coins">
                                                    <span>80</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="dropdown-btn-description">Turret-like building that takes coins for each enemy killed</div>
                                        <div class="dropdown-btn-stats">
                                            <span class="stat-badge health">Health: 2</span>
                                            <span class="stat-badge range">Range: 3</span>
                                            <span class="stat-badge">Requires: Siege Weapons</span>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="folder-item" data-folder>
                            <div class="folder-trigger">
                                <img src="./sprites/Tank.png" alt="Army">
                                <span>Army</span>
                            </div>
                            <div class="folder-dropdown">
                                <div class="dropdown-content">
                                    <button class="dropdown-btn" id="place-scout"
                                        data-info="Soldier,Basic unit with balanced stats,Health: 1,Range: 1,Movement: 1,Requires: Fortress">
                                        <div class="dropdown-btn-header">
                                            <img src="./sprites/soldier.png" alt="Soldier">
                                            <span class="dropdown-btn-title">Soldier</span>
                                            <div class="dropdown-btn-cost">
                                                <div class="cost-resource">
                                                    <img src="./sprites/coin.png" alt="Coins">
                                                    <span>15</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="dropdown-btn-description">Basic unit with balanced stats</div>
                                        <div class="dropdown-btn-stats">
                                            <span class="stat-badge health">Health: 1</span>
                                            <span class="stat-badge range">Range: 1</span>
                                            <span class="stat-badge movement">Movement: 1</span>
                                            <span class="stat-badge">Requires: Fortress</span>
                                        </div>
                                    </button>
                                    <button class="dropdown-btn" id="place-knight"
                                        data-info="Knight,Fast-moving unit with high mobility,Health: 1,Range: 1,Movement: 5,Requires: Basic Army">
                                        <div class="dropdown-btn-header">
                                            <img src="./sprites/knight.png" alt="Knight">
                                            <span class="dropdown-btn-title">Knight</span>
                                            <div class="dropdown-btn-cost">
                                                <div class="cost-resource">
                                                    <img src="./sprites/coin.png" alt="Coins">
                                                    <span>25</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="dropdown-btn-description">Fast-moving unit with high mobility</div>
                                        <div class="dropdown-btn-stats">
                                            <span class="stat-badge health">Health: 1</span>
                                            <span class="stat-badge range">Range: 1</span>
                                            <span class="stat-badge movement">Movement: 5</span>
                                            <span class="stat-badge">Requires: Basic Army</span>
                                        </div>
                                    </button>
                                    <button class="dropdown-btn" id="place-archer"
                                        data-info="Archer,Ranged unit that can attack from a distance,Health: 1,Range: 4,Movement: 1,Requires: Basic Army">
                                        <div class="dropdown-btn-header">
                                            <img src="./sprites/Archer.png" alt="Archer">
                                            <span class="dropdown-btn-title">Archer</span>
                                            <div class="dropdown-btn-cost">
                                                <div class="cost-resource">
                                                    <img src="./sprites/coin.png" alt="Coins">
                                                    <span>20</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="dropdown-btn-description">Ranged unit that can attack from a distance</div>
                                        <div class="dropdown-btn-stats">
                                            <span class="stat-badge health">Health: 1</span>
                                            <span class="stat-badge range">Range: 4</span>
                                            <span class="stat-badge movement">Movement: 1</span>
                                            <span class="stat-badge">Requires: Basic Army</span>
                                        </div>
                                    </button>
                                    <button class="dropdown-btn" id="place-tank"
                                        data-info="Tank,Heavy unit with high health,Health: 5,Range: 1,Movement: 1,Requires: Elite Units">
                                        <div class="dropdown-btn-header">
                                            <img src="./sprites/Tank.png" alt="Tank">
                                            <span class="dropdown-btn-title">Tank</span>
                                            <div class="dropdown-btn-cost">
                                                <div class="cost-resource">
                                                    <img src="./sprites/coin.png" alt="Coins">
                                                    <span>50</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="dropdown-btn-description">Heavy unit with high health</div>
                                        <div class="dropdown-btn-stats">
                                            <span class="stat-badge health">Health: 5</span>
                                            <span class="stat-badge range">Range: 1</span>
                                            <span class="stat-badge movement">Movement: 1</span>
                                            <span class="stat-badge">Requires: Elite Units</span>
                                        </div>
                                    </button>
                                    <button class="dropdown-btn" id="place-siege-tower"
                                        data-info="Siege Tower,Powerful siege unit with long range,Health: 1,Range: 4,Movement: 1,Requires: Siege Weapons">
                                        <div class="dropdown-btn-header">
                                            <img src="./sprites/siegetower.png" alt="Siege Tower">
                                            <span class="dropdown-btn-title">Siege Tower</span>
                                            <div class="dropdown-btn-cost">
                                                <div class="cost-resource">
                                                    <img src="./sprites/coin.png" alt="Coins">
                                                    <span>275</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="dropdown-btn-description">Powerful siege unit with long range</div>
                                        <div class="dropdown-btn-stats">
                                            <span class="stat-badge health">Health: 1</span>
                                            <span class="stat-badge range">Range: 4</span>
                                            <span class="stat-badge movement">Movement: 1</span>
                                            <span class="stat-badge">Requires: Siege Weapons</span>
                                        </div>
                                    </button>
                                    <button class="dropdown-btn" id="place-king"
                                        data-info="King,Command unit that boosts nearby army,Health: 25,Range: 2,Movement: 2,Requires: Elite Units">
                                        <div class="dropdown-btn-header">
                                            <img src="./sprites/king.png" alt="King">
                                            <span class="dropdown-btn-title">King</span>
                                            <div class="dropdown-btn-cost">
                                                <div class="cost-resource">
                                                    <img src="./sprites/goldin.png" alt="Gold">
                                                    <span>500</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="dropdown-btn-description">Command unit that boosts nearby army</div>
                                        <div class="dropdown-btn-stats">
                                            <span class="stat-badge health">Health: 25</span>
                                            <span class="stat-badge range">Range: 2</span>
                                            <span class="stat-badge movement">Movement: 2</span>
                                            <span class="stat-badge">Requires: Elite Units</span>
                                        </div>
                                    </button>
                                    <button class="dropdown-btn" id="place-barrack"
                                        data-info="Barrack,Automatically spawns soldier units,Health: 2,Requires: Advanced Army">
                                        <div class="dropdown-btn-header">
                                            <img src="./sprites/barrack.png" alt="Barrack">
                                            <span class="dropdown-btn-title">Barrack</span>
                                            <div class="dropdown-btn-cost">
                                                <div class="cost-resource">
                                                    <img src="./sprites/goldin.png" alt="Gold">
                                                    <span>50</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="dropdown-btn-description">Automatically spawns soldier units</div>
                                        <div class="dropdown-btn-stats">
                                            <span class="stat-badge health">Health: 2</span>
                                            <span class="stat-badge">Requires: Advanced Army</span>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div class="nav-section nav-controls">
                        <button class="nav-btn research-nav-btn" id="research-nav-btn">
                            <img src="./sprites/research.png" alt="Research">
                            RESEARCH
                        </button>
                        <span class="nav-label">BASE STATUS:</span>
                        <span class="threat-indicator" id="threat-indicator">
                            <span class="threat-status safe">SECURE</span>
                        </span>
                    </div>
                </div>
            </nav>

            <main class="game-main-area">
                <aside class="game-sidebar">
                    <div class="resources-panel">
                        <h3>CURRENT RESOURCES</h3>
                        <div class="resources-list">
                            <div class="resource-item">
                                <img src="./sprites/ironin.png" alt="Steel">
                                <div class="resource-details">
                                    <span class="resource-name">STEEL</span>
                                    <span class="resource-amount" id="steel-count">100</span>
                                </div>
                            </div>
                            <div class="resource-item">
                                <img src="./sprites/coin.png" alt="Coins">
                                <div class="resource-details">
                                    <span class="resource-name">COINS</span>
                                    <span class="resource-amount" id="coin-count">50</span>
                                </div>
                            </div>
                            <div class="resource-item">
                                <img src="./sprites/goldin.png" alt="Gold">
                                <div class="resource-details">
                                    <span class="resource-name">GOLD</span>
                                    <span class="resource-amount" id="gold-count">25</span>
                                </div>
                            </div>
                            <div class="resource-item">
                                <img src="./sprites/Oil.png" alt="Oil">
                                <div class="resource-details">
                                    <span class="resource-name">OIL</span>
                                    <span class="resource-amount" id="oil-count">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="extraction-controls-panel">
                        <h3>OPERATIONS</h3>
                        <div class="control-buttons">
                            <button class="control-btn extract-btn" id="extract-btn" disabled>
                                <img src="./sprites/bank.png" alt="Extract">
                                EXTRACT RESOURCES
                            </button>
                        </div>
                    </div>
                </aside>

                <div class="game-content">
                    <div class="game-grid-container">
                        <div class="game-grid" id="game-grid"></div>
                    </div>

                    <div class="game-info-panel">
                        <div class="game-stats">
                            <div class="stat-box">
                                <span class="stat-label">TURN</span>
                                <span class="stat-value" id="turn-count">1</span>
                            </div>
                            <div class="stat-box">
                                <span class="stat-label">WAVE</span>
                                <span class="stat-value" id="wave-count">1</span>
                            </div>
                            <div class="stat-box">
                                <span class="stat-label">ENEMIES</span>
                                <span class="stat-value" id="enemies-remaining">0</span>
                            </div>
                        </div>

                        <div class="instructions-panel">
                            <p id="turn-instructions">Click an army unit to select it, then click a highlighted square
                                to move</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <div class="tech-tree-popup" id="tech-tree-popup">
            <div class="tech-tree-header">
                <h2>Tech Tree</h2>
                <button class="tech-tree-close" id="tech-tree-close"></button>
            </div>
            <div class="tech-tree-resources-card">
                <div class="tech-tree-resource">
                    <img src="./sprites/ironin.png" alt="Steel">
                    <span id="tech-tree-steel">100</span>
                </div>
                <div class="tech-tree-resource">
                    <img src="./sprites/coin.png" alt="Coins">
                    <span id="tech-tree-coins">50</span>
                </div>
                <div class="tech-tree-resource">
                    <img src="./sprites/goldin.png" alt="Gold">
                    <span id="tech-tree-gold">25</span>
                </div>
                <div class="tech-tree-resource">
                    <img src="./sprites/Oil.png" alt="Oil">
                    <span id="tech-tree-oil">0</span>
                </div>
            </div>
            <div class="tech-tree-content" id="tech-tree-content">
                <div class="tech-tree-main" id="tech-tree-main"></div>
                <div class="tech-info-panel" id="tech-info-panel">
                    <div class="tech-info-default">Hover over a technology to see details</div>
                </div>
            </div>
        </div>

        <div class="tech-tree-overlay" id="tech-tree-overlay"></div>

        <div class="building-info-popup" id="building-info-popup">
            <div class="building-info-header">
                <div class="building-info-title" id="building-info-title">Building Name</div>
                <button class="building-info-close" id="building-info-close"></button>
            </div>
            <div class="building-info-content">
                <div class="building-icon-container">
                    <img class="building-icon" id="building-icon" src="./sprites/turret.png" alt="Building Icon">
                </div>
                <div class="building-description" id="building-description">Building description goes here.</div>
                <div class="module-slots-container">
                    <div class="module-slots-header">
                        <span class="module-slots-title">Modules</span>
                    </div>
                    <div class="module-slots">
                        <div class="module-slot" id="module-slot-1" data-slot="1">
                            <div class="module-slot-inner">
                                <div class="module-slot-icon"></div>
                                <div class="module-slot-tier"></div>
                            </div>
                            <div class="module-slot-label">Slot 1</div>
                        </div>
                        <div class="module-slot" id="module-slot-2" data-slot="2">
                            <div class="module-slot-inner">
                                <div class="module-slot-icon"></div>
                                <div class="module-slot-tier"></div>
                            </div>
                            <div class="module-slot-label">Slot 2</div>
                        </div>
                    </div>
                </div>

                <div class="module-selection-popup" id="module-selection-popup">
                    <div class="module-selection-header">
                        <span>Select Module</span>
                        <button class="module-close-btn" id="module-close-btn"></button>
                    </div>
                    <div class="module-options">
                        <div class="module-option" data-module="speed" data-tier="1">
                            <div class="module-icon">
                                <img src="./sprites/speedmod.png" alt="Speed Module">
                            </div>
                            <div class="module-info">
                                <div class="module-name">Speed Module (T1)</div>
                                <div class="module-cost" data-resource="iron">145</div>
                            </div>
                        </div>
                        <div class="module-option" data-module="speed" data-tier="2">
                            <div class="module-icon">
                                <img src="./sprites/speedmod.png" alt="Speed Module">
                            </div>
                            <div class="module-info">
                                <div class="module-name">Speed Module (T2)</div>
                                <div class="module-cost" data-resource="iron">290</div>
                            </div>
                        </div>
                        <div class="module-option" data-module="speed" data-tier="3">
                            <div class="module-icon">
                                <img src="./sprites/speedmod.png" alt="Speed Module">
                            </div>
                            <div class="module-info">
                                <div class="module-name">Speed Module (T3)</div>
                                <div class="module-cost" data-resource="iron">580</div>
                            </div>
                        </div>
                        <div class="module-option" data-module="defense" data-tier="1">
                            <div class="module-icon">
                                <img src="./sprites/defensemod.png" alt="Defense Module">
                            </div>
                            <div class="module-info">
                                <div class="module-name">Defense Module (T1)</div>
                                <div class="module-cost" data-resource="iron">50</div>
                            </div>
                        </div>
                        <div class="module-option" data-module="defense" data-tier="2">
                            <div class="module-icon">
                                <img src="./sprites/defensemod.png" alt="Defense Module">
                            </div>
                            <div class="module-info">
                                <div class="module-name">Defense Module (T2)</div>
                                <div class="module-cost" data-resource="iron">100</div>
                            </div>
                        </div>
                        <div class="module-option" data-module="defense" data-tier="3">
                            <div class="module-icon">
                                <img src="./sprites/defensemod.png" alt="Defense Module">
                            </div>
                            <div class="module-info">
                                <div class="module-name">Defense Module (T3)</div>
                                <div class="module-cost" data-resource="iron">200</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="module-selection-overlay" id="module-selection-overlay"></div>

                <div class="building-special-actions" id="building-special-actions">
                    <button class="building-action-btn" id="teleport-army-btn">
                        <img src="./sprites/wargate.png" alt="Teleport">
                        TELEPORT ARMY HOME
                        <span class="action-cost">50 OIL</span>
                    </button>
                </div>
            </div>
        </div>
        <div class="building-info-overlay" id="building-info-overlay"></div>

        <div class="modal-overlay" id="army-selection-popup">
            <div class="modal-content army-selection-modal">
                <div class="modal-header">
                    <h2>SELECT ARMY UNITS</h2>
                    <button class="close-btn" onclick="closeArmySelection()"></button>
                </div>
                <div class="modal-body">
                    <div class="army-selection-info">
                        <p>Select army units to send to your base:</p>
                        <div class="army-cost-info">
                            <span>Cost: 25 Oil per unit</span>
                        </div>
                    </div>

                    <div class="army-units-list" id="army-units-list">
                    </div>

                    <div class="army-selection-actions">
                        <button class="modal-btn secondary" onclick="closeArmySelection()">Cancel</button>
                        <button class="modal-btn primary" id="send-army-btn">Send Selected Units</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const CONFIG = {
                GRID_SIZE_X: 25,
                GRID_SIZE_Y: 15,
                PLAYER_START: { x: 12, y: 7 },
                WAVE_BREAK_TURNS: 3,
                INITIAL_RESOURCES: {
                    Steel: 100,
                    coins: 50,
                    gold: 25,
                    oil: 0
                },
                SPRITES: {
                    player: './sprites/spawn.png',
                    wall: {
                        stone: './sprites/wall.png',
                        steel: './sprites/wallsteel.png',
                        spike: './sprites/spike.png',
                        castle: './sprites/Castle_wall.png'
                    },
                    tech: {
                        miner: './sprites/iron.png',
                        goldminer: './sprites/gold.png',
                        coinmaker: './sprites/bank.png',
                        oilrig: './sprites/oilrig.png',
                        turret: './sprites/turret.png',
                        goldturret: './sprites/goldturret.png',
                        bomb: './sprites/bomb.png',
                        supply: './sprites/supply.gif',
                        campfire: './sprites/campfire.gif',
                        warpgate: './sprites/wargate.png'
                    },
                    army: {
                        scout: './sprites/soldier.png',
                        knight: './sprites/knight.png',
                        archer: './sprites/Archer.png',
                        tank: './sprites/Tank.png',
                        king: './sprites/king.png',
                        barrack: './sprites/barrack.png',
                        siegetower: './sprites/siegetower.png'
                    },
                    enemy: {
                        basic: './sprites/defaultbad.png',
                        fast: './sprites/badfast.png',
                        tank: './sprites/badheavy.png',
                        ranged: './sprites/badarcher.png',
                        healer: './sprites/badhealer.png'
                    }
                }
            }


            CONFIG.TECH_TREE = {};
            let NODE_POSITIONS = {};

            async function loadTechTree() {
                try {
                    console.log('Attempting to load tech tree...');

                    const response = await fetch('tech-tree-full.json');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const text = await response.text();
                    console.log('Raw response text:', text.substring(0, 200));

                    try {
                        const fullData = JSON.parse(text);

                        CONFIG.TECH_TREE = fullData.tech_tree;

                        NODE_POSITIONS = fullData.positions;

                        console.log('Tech tree loaded successfully. Nodes:', Object.keys(CONFIG.TECH_TREE).length);
                        console.log('Positions loaded:', Object.keys(NODE_POSITIONS).length);

                        if (typeof updateTechTreeDisplay === 'function') {
                            updateTechTreeDisplay();
                        }

                    } catch (parseError) {
                        console.error('Error parsing JSON:', parseError);
                        throw new Error('Invalid JSON format in tech tree file');
                    }

                } catch (error) {
                    console.error('Error loading tech tree:', error);

                    console.log('Using fallback tech tree data');
                    CONFIG.TECH_TREE = {
                        'fortress': {
                            name: 'Fortress',
                            description: 'Your main base that must be protected',
                            cost: { Steel: 0 },
                            tier: 0,
                            prerequisites: [],
                            unlocks: ['basic_defense', 'basic_army', 'module_research'],
                            icon: 'spawn.png'
                        },
                        'module_research': {
                            name: 'Module Research',
                            description: 'Unlocks the ability to research specialized modules',
                            cost: { Steel: 150, gold: 75 },
                            tier: 2,
                            prerequisites: ['fortress'],
                            unlocks: ['speed_module', 'defense_module'],
                            icon: 'research.png'
                        }
                    };

                    NODE_POSITIONS = {
                        'fortress': { x: 400, y: 30 },
                        'module_research': { x: 400, y: 120 }
                    };

                    if (typeof updateTechTreeDisplay === 'function') {
                        updateTechTreeDisplay();
                    }
                }
            }


            class GameState {
                constructor() {
                    this.reset();
                }

                reset() {
                    if (window.waveBreakTimeout) {
                        clearTimeout(window.waveBreakTimeout);
                        window.waveBreakTimeout = null;
                    }

                    this.resources = { ...CONFIG.INITIAL_RESOURCES };
                    this.storedResources = { ...CONFIG.INITIAL_RESOURCES };
                    this.sessionResources = { Steel: 0, coins: 0, gold: 0, oil: 0 };

                    this.turn = 1;
                    this.selectedUnit = null;
                    this.placementMode = null;

                    this.gameMode = 'homescreen';
                    this.currentZone = null;
                    this.zoneDepth = 0;
                    this.threatLevel = 0;

                    this.cameraOffset = { x: 0, y: 0 };
                    this.worldObjects = new Map();
                    this.grid = Array(CONFIG.GRID_SIZE_Y).fill().map(() => Array(CONFIG.GRID_SIZE_X).fill(null));
                    this.objects = new Map();
                    this.wave = 1;
                    this.waveBreakTurns = 0;
                    this.inWaveBreak = false;
                    this.enemiesRemaining = 0;
                    this.researchedTechs = new Set();
                    this.availableTechs = new Set();
                    this.techTreeCompletedRewardGiven = false;

                    if (CONFIG.TECH_TREE.fortress) {
                        this.researchedTechs.add('fortress');
                    }

                    this.updateAvailableTechs();

                    this.checkTechTreeCompletion();
                }

                canAfford(cost) {
                    return this.resources.Steel >= (cost.Steel || 0) &&
                        this.resources.coins >= (cost.coins || 0) &&
                        this.resources.gold >= (cost.gold || 0) &&
                        this.resources.oil >= (cost.oil || 0);
                }

                spendResources(cost) {
                    if (cost.Steel) this.resources.Steel -= cost.Steel;
                    if (cost.coins) this.resources.coins -= cost.coins;
                    if (cost.gold) this.resources.gold -= cost.gold;
                    if (cost.oil) this.resources.oil -= cost.oil;
                }

                addResources(resources) {
                    console.log('=== ADD RESOURCES CALLED ===');
                    console.log('Resources to add:', resources);
                    console.log('Current game mode:', this.gameMode);
                    console.log('Resources before:', { Steel: this.resources.Steel, coins: this.resources.coins, gold: this.resources.gold, oil: this.resources.oil });
                    console.log('Session resources before:', this.sessionResources);
                    
                    if (resources.Steel) this.resources.Steel += resources.Steel;
                    if (resources.coins) this.resources.coins += resources.coins;
                    if (resources.gold) this.resources.gold += resources.gold;
                    if (resources.oil) this.resources.oil += resources.oil;

                    console.log('Resources after:', { Steel: this.resources.Steel, coins: this.resources.coins, gold: this.resources.gold, oil: this.resources.oil });

                    if (this.gameMode === 'active_zone') {
                        console.log('Adding to session resources (active zone mode)');
                        if (resources.Steel) this.sessionResources.Steel += resources.Steel;
                        if (resources.coins) this.sessionResources.coins += resources.coins;
                        if (resources.gold) this.sessionResources.gold += resources.gold;
                        if (resources.oil) this.sessionResources.oil += resources.oil;
                        console.log('Session resources after:', this.sessionResources);
                    } else {
                        console.log('NOT adding to session resources - not in active zone mode');
                    }

                    updateDisplay();
                    console.log('=== ADD RESOURCES END ===');
                }

                enterZone(zoneType) {
                    this.gameMode = 'active_zone';
                    this.currentZone = zoneType;
                    this.zoneDepth = 0;
                    this.threatLevel = 0;
                    this.sessionResources = { Steel: 0, coins: 0, gold: 0, oil: 0 };

                    if (!this.resources || Object.keys(this.resources).length === 0) {
                        const zoneBaseResources = {
                            shallow: { Steel: 50, coins: 25, gold: 10, oil: 2 },
                            medium: { Steel: 75, coins: 40, gold: 15, oil: 5 },
                            deep: { Steel: 100, coins: 60, gold: 25, oil: 12 }
                        };

                        this.resources = { ...zoneBaseResources[zoneType] };
                    }

                    this.spawnInitialZoneEnemies(zoneType);

                    updateDisplay();
                    switchView('active-zone-view');
                }

                extractResources() {
                    console.log('=== EXTRACT RESOURCES START ===');
                    console.log('Session resources before extraction:', this.sessionResources);
                    console.log('Stored resources before extraction:', this.storedResources);
                    console.log('Current game mode:', this.gameMode);
                    console.log('Current zone:', this.currentZone);
                    console.log('Full session resources object:', JSON.stringify(this.sessionResources));
                    
                    // Test: Force add some steel to session resources for testing
                    console.log('FORCING steel into session resources for testing...');
                    this.sessionResources.Steel = (this.sessionResources.Steel || 0) + 50;
                    console.log('Session resources after forcing steel:', this.sessionResources);

                    let totalExtracted = 0;
                    for (const [resource, amount] of Object.entries(this.sessionResources)) {
                        if (amount > 0) {
                            const oldAmount = this.storedResources[resource] || 0;
                            this.storedResources[resource] = oldAmount + amount;
                            totalExtracted += amount;
                            console.log(`Transferred ${amount} ${resource} to storage`);
                            console.log(`Storage ${resource}: ${oldAmount} -> ${this.storedResources[resource]}`);
                        }
                    }

                    console.log('Total resources extracted:', totalExtracted);
                    console.log('Stored resources after extraction:', this.storedResources);
                    
                    // Log vault element values before update
                    const vaultSteelElement = document.getElementById('vault-stored-steel-count');
                    console.log('Vault steel element exists:', !!vaultSteelElement);
                    if (vaultSteelElement) {
                        console.log('Vault steel element text before update:', vaultSteelElement.textContent);
                    }

                    // Update display immediately to show extracted resources in vault
                    console.log('Calling updateDisplay() to refresh vault');
                    updateDisplay();
                    
                    // Log vault element values after update
                    if (vaultSteelElement) {
                        console.log('Vault steel element text after update:', vaultSteelElement.textContent);
                    }

                    console.log('Calling returnToHomescreen()');
                    this.returnToHomescreen();

                    const extractedList = Object.entries(this.sessionResources)
                        .filter(([_, amount]) => amount > 0)
                        .map(([res, amount]) => `${amount} ${res}`)
                        .join(', ');

                    if (extractedList) {
                        showNotification(`Extracted ${extractedList}!`, 12, 7, 'success');
                    } else {
                        showNotification('No resources to extract!', 12, 7, 'warning');
                    }

                    console.log('=== EXTRACT RESOURCES END ===');
                }

                returnToHomescreen() {
                    console.log('Returning to homescreen...');
                    console.log('Stored resources before return:', this.storedResources);

                    this.gameMode = 'homescreen';
                    this.currentZone = null;
                    this.zoneDepth = 0;
                    this.threatLevel = 0;
                    this.sessionResources = { Steel: 0, coins: 0, gold: 0, oil: 0 };
                    this.resources = { ...this.storedResources };

                    this.worldObjects.clear();
                    this.objects.clear();
                    this.grid = Array(CONFIG.GRID_SIZE_Y).fill().map(() => Array(CONFIG.GRID_SIZE_X).fill(null));
                    this.enemiesRemaining = 0;

                    console.log('Calling updateDisplay...');
                    updateDisplay();
                    console.log('Showing homescreen overlay...');
                    showHomescreen();
                    console.log('Return to homescreen complete');
                }

                increaseThreat() {
                    this.zoneDepth++;
                    this.threatLevel = Math.min(this.zoneDepth, 10);

                    const enemiesToSpawn = Math.floor(this.threatLevel / 2) + 1;
                    spawnWave(enemiesToSpawn);

                    updateDisplay();
                }

                checkBaseThreat() {
                    const playerX = CONFIG.PLAYER_START.x;
                    const playerY = CONFIG.PLAYER_START.y;

                    for (const obj of this.worldObjects.values()) {
                        if (obj.type === 'enemy') {
                            const distance = Math.abs(obj.x - playerX) + Math.abs(obj.y - playerY);
                            if (distance <= 2) {
                                return true;
                            }
                        }
                    }
                    return false;
                }

                isTechResearched(techId) {
                    return this.researchedTechs.has(techId);
                }

                canResearchTech(techId) {
                    const tech = CONFIG.TECH_TREE[techId];
                    if (!tech) return false;
                    if (this.isTechResearched(techId)) return false;

                    return tech.prerequisites.every(prereq => this.isTechResearched(prereq)) &&
                        this.canAfford(tech.cost);
                }

                researchTech(techId) {
                    if (!this.canResearchTech(techId)) return false;

                    const tech = CONFIG.TECH_TREE[techId];
                    this.spendResources(tech.cost);
                    this.researchedTechs.add(techId);
                    this.updateAvailableTechs();

                    this.checkTechTreeCompletion();

                    return true;
                }

                updateAvailableTechs() {
                    this.availableTechs.clear();
                    for (const techId in CONFIG.TECH_TREE) {
                        const tech = CONFIG.TECH_TREE[techId];
                        if (!this.isTechResearched(techId) &&
                            tech.prerequisites.every(prereq => this.isTechResearched(prereq))) {
                            this.availableTechs.add(techId);
                        }
                    }
                }

                getResourceMultiplier() {
                    let multiplier = 1.0;
                    if (this.isTechResearched('advanced_mining')) {
                        multiplier += 0.25;
                    }
                    if (this.isTechResearched('premium_mining')) {
                        multiplier += 0.5;
                    }
                    return multiplier;
                }

                countEnemies() {
                    let count = 0;
                    this.worldObjects.forEach(obj => {
                        if (obj.type === 'enemy') count++;
                    });
                    console.log(`countEnemies: calculated ${count}, previous value was ${this.enemiesRemaining}`);
                    this.enemiesRemaining = count;
                    return count;
                }

                checkTechTreeCompletion() {
                    if (this.techTreeCompletedRewardGiven) return;

                    const totalTechs = Object.keys(CONFIG.TECH_TREE).length;
                    const researchedCount = this.researchedTechs.size;

                    if (researchedCount === totalTechs && totalTechs > 0) {
                        this.giveTechTreeCompletionRewards();
                        this.techTreeCompletedRewardGiven = true;
                    }
                }

                giveTechTreeCompletionRewards() {
                    // Define zone-specific rewards
                    const zoneRewards = {
                        shallow: {
                            Steel: 1000,
                            coins: 250,
                            gold: 250,
                            oil: 100
                        },
                        medium: {
                            Steel: 2000,
                            coins: 750,
                            gold: 750,
                            oil: 500
                        },
                        deep: {
                            Steel: 5000,
                            coins: 3000,
                            gold: 3000,
                            oil: 1000
                        }
                    };

                    // Get rewards based on current zone
                    const currentZone = this.currentZone || 'shallow';
                    const rewards = zoneRewards[currentZone] || zoneRewards.shallow;

                    this.addResources(rewards);

                    const zoneNames = {
                        shallow: 'SHALLOW ZONE',
                        medium: 'MEDIUM ZONE',
                        deep: 'DEEP ZONE'
                    };

                    showNotification(
                        `${zoneNames[currentZone]} TECH TREE COMPLETED! Bonus: +${rewards.Steel}S +${rewards.coins}C +${rewards.gold}G +${rewards.oil}O`,
                        CONFIG.PLAYER_START.x,
                        CONFIG.PLAYER_START.y,
                        'success'
                    );

                    createTechTreeCompletionEffects(rewards);
                }

                spawnInitialZoneEnemies(zoneType) {
                    this.worldObjects.forEach((obj, key) => {
                        if (obj.type === 'enemy') {
                            this.worldObjects.delete(key);
                            this.objects.delete(key);

                            const gridX = obj.x - this.cameraOffset.x;
                            const gridY = obj.y - this.cameraOffset.y;
                            if (gridX >= 0 && gridX < CONFIG.GRID_SIZE_X &&
                                gridY >= 0 && gridY < CONFIG.GRID_SIZE_Y) {
                                this.grid[gridY][gridX] = null;
                            }
                        }
                    });

                    const zoneConfigs = {
                        shallow: {
                            count: 3,
                            minDistance: 5,
                            maxDistance: 8
                        },
                        medium: {
                            count: 5,
                            minDistance: 3,
                            maxDistance: 7
                        },
                        deep: {
                            count: 8,
                            minDistance: 3,
                            maxDistance: 6
                        }
                    };

                    const config = zoneConfigs[zoneType] || zoneConfigs.shallow;
                    const playerX = CONFIG.PLAYER_START.x;
                    const playerY = CONFIG.PLAYER_START.y;

                    const validPositions = [];
                    for (let y = 0; y < CONFIG.GRID_SIZE_Y; y++) {
                        for (let x = 0; x < CONFIG.GRID_SIZE_X; x++) {
                            const worldX = x + this.cameraOffset.x;
                            const worldY = y + this.cameraOffset.y;

                            if (worldX === playerX && worldY === playerY) continue;

                            if (this.grid[y][x] !== null) continue;

                            const distance = Math.abs(worldX - playerX) + Math.abs(worldY - playerY);
                            if (distance >= config.minDistance && distance <= config.maxDistance) {
                                validPositions.push({ x: worldX, y: worldY, gridX: x, gridY: y });
                            }
                        }
                    }

                    for (let i = validPositions.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [validPositions[i], validPositions[j]] = [validPositions[j], validPositions[i]];
                    }

                    const enemiesToSpawn = Math.min(config.count, validPositions.length);
                    for (let i = 0; i < enemiesToSpawn; i++) {
                        const pos = validPositions[i];
                        spawnEnemy(pos.gridX, pos.gridY);
                    }

                    console.log(`Spawned ${enemiesToSpawn} initial enemies for ${zoneType} zone`);
                }
            }

            class GameObject {
                constructor(x, y, type, subtype) {
                    this.x = x;
                    this.y = y;
                    this.type = type;
                    this.subtype = subtype;
                    this.id = `${type}_${subtype}_${x}_${y}_${Date.now()}`;
                    this.modules = [];
                    this.originalHealth = null;
                    this.originalMaxHealth = null;
                    this.originalRange = null;
                    this.originalShotsLeft = null;
                    this.originalMovement = null;
                }

                getSprite() {
                    const spritePath = CONFIG.SPRITES[this.type]?.[this.subtype] || 'sprites/missing.png';
                    console.log(`Getting sprite for ${this.type}-${this.subtype}: ${spritePath}`);
                    return spritePath;
                }

                addModule(moduleType) {
                    if (this.modules.length >= 2) return false;
                    if (this.modules.includes(moduleType)) return false;

                    this.modules.push(moduleType);
                    this.applyModuleEffect(moduleType);
                    return true;
                }

                removeModule(moduleType) {
                    const index = this.modules.indexOf(moduleType);
                    if (index === -1) return false;

                    this.modules.splice(index, 1);
                    this.removeModuleEffect(moduleType);
                    return true;
                }

                applyModuleEffect(moduleType) {
                    const baseModuleType = moduleType.includes('-') ? moduleType.split('-')[0] : moduleType;

                    const tier = moduleType.includes('-') ? parseInt(moduleType.split('-')[1]) : 1;
                    const multiplier = tier + 1;

                    if (baseModuleType === 'speed') {
                        if (this.type === 'army') {
                            if (this.originalMovement === null) {
                                this.originalMovement = this.movement;
                            }
                            this.movement = this.originalMovement * multiplier;
                        } else if (this.type === 'tech') {
                            if (this.subtype === 'turret' || this.subtype === 'goldturret') {
                                if (this.originalShotsLeft === null) {
                                    this.originalShotsLeft = this.shotsLeft;
                                }
                                this.shotsLeft = this.originalShotsLeft * multiplier;
                            }
                        }
                    } else if (baseModuleType === 'defense') {
                        if (this.originalHealth === null) {
                            this.originalHealth = this.health;
                            this.originalMaxHealth = this.maxHealth;
                        }
                        this.health = this.originalHealth * multiplier;
                        this.maxHealth = this.originalMaxHealth * multiplier;
                    }
                }

                removeModuleEffect(moduleType) {
                    const baseModuleType = moduleType.includes('-') ? moduleType.split('-')[0] : moduleType;

                    const tier = moduleType.includes('-') ? parseInt(moduleType.split('-')[1]) : 1;
                    const multiplier = tier + 1;

                    if (baseModuleType === 'speed') {
                        if (this.type === 'army') {
                            if (this.originalMovement !== null) {
                                this.movement = this.originalMovement;
                            }
                        } else if (this.type === 'tech') {
                            if (this.subtype === 'turret' || this.subtype === 'goldturret') {
                                if (this.originalShotsLeft !== null) {
                                    this.shotsLeft = this.originalShotsLeft;
                                }
                            }
                        }
                    } else if (baseModuleType === 'defense') {
                        if (this.originalHealth !== null && this.originalMaxHealth !== null) {
                            this.health = this.originalHealth;
                            this.maxHealth = this.originalMaxHealth;
                        }
                    }
                }

                getModuleBonus() {
                    return {
                        speed: this.modules.filter(m => m && m.startsWith('speed')).length,
                        defense: this.modules.filter(m => m && m.startsWith('defense')).length
                    };
                }

                getSpeedModuleTiers() {
                    const speedModules = this.modules.filter(m => m && m.startsWith('speed'));
                    return speedModules.map(module => {
                        const parts = module.split('-');
                        return parts.length > 1 ? parseInt(parts[1]) : 1;
                    });
                }

                getDefenseModuleTiers() {
                    const defenseModules = this.modules.filter(m => m && m.startsWith('defense'));
                    return defenseModules.map(module => {
                        const parts = module.split('-');
                        return parts.length > 1 ? parseInt(parts[1]) : 1;
                    });
                }
            }

            class Wall extends GameObject {
                constructor(x, y, subtype = 'stone') {
                    console.log(`Wall constructor called with subtype: ${subtype}`);
                    super(x, y, 'wall', subtype);
                    this.health = this.getMaxHealth();
                    this.maxHealth = this.health;
                    console.log(`Wall health set to: ${this.health}`);
                    this.blocksMovement = true;
                }

                getMaxHealth() {
                    switch (this.subtype) {
                        case 'steel': return 3;
                        case 'spike': return 3;
                        case 'castle': return 15;
                        default: return 1;
                    }
                }

                takeDamage(damage = 1) {
                    this.health -= damage;
                    return this.health <= 0;
                }
            }

            class Tech extends GameObject {
                constructor(x, y, subtype = 'miner') {
                    super(x, y, 'tech', subtype);
                    this.cost = this.getCost();
                    this.health = 2;
                    this.maxHealth = 2;

                    if (subtype === 'turret') {
                        this.shotsLeft = 8;
                        this.range = 3;
                    } else if (subtype === 'goldturret') {
                        this.shotsLeft = 10;
                        this.range = 3;
                    } else if (subtype === 'camptower') {
                        this.shotsLeft = Infinity; // Doesn't vanish after shots
                        this.range = 3;
                        this.coinsPerKill = 14; // Takes 14 coins per kill
                    }
                }

                getCost() {
                    const costs = {
                        miner: { Steel: 20 },
                        goldminer: { Steel: 25 },
                        coinmaker: { Steel: 30 },
                        oilrig: { Steel: 35 },
                        turret: { Steel: 40 },
                        goldturret: { gold: 200 },
                        bomb: { gold: 10 },
                        supply: { gold: 35 },
                        campfire: { Steel: 30 },
                        camptower: { iron: 70, coins: 80 },
                        warpgate: { Steel: 150, gold: 100, oil: 75 }
                    };
                    return costs[this.subtype] || { Steel: 20 };
                }

                onTurn() {
                    const multiplier = gameState.getResourceMultiplier();

                    const campfireBonus = 1 + (0.5 * this.getNearbyCampfires());

                    const speedModuleTiers = this.getSpeedModuleTiers();
                    const speedModuleMultiplier = speedModuleTiers.reduce((total, tier) => total + (tier + 1), 1);

                    switch (this.subtype) {
                        case 'miner':
                            gameState.addResources({ Steel: Math.floor(5 * campfireBonus * multiplier * speedModuleMultiplier) });
                            createResourceCollectionEffect(this.x, this.y, 'Steel');
                            break;
                        case 'goldminer':
                            gameState.addResources({ gold: Math.ceil(1 * campfireBonus * multiplier * speedModuleMultiplier) });
                            createResourceCollectionEffect(this.x, this.y, 'gold');
                            break;
                        case 'coinmaker':
                            gameState.addResources({ coins: Math.floor(5 * campfireBonus * multiplier * speedModuleMultiplier) });
                            createResourceCollectionEffect(this.x, this.y, 'coins');
                            break;
                        case 'oilrig':
                            gameState.addResources({ oil: Math.ceil(1 * campfireBonus * multiplier * speedModuleMultiplier) });
                            createResourceCollectionEffect(this.x, this.y, 'oil');
                            break;
                        case 'supply':
                            this.handleSupplyDrop();
                            break;
                        case 'turret':
                        case 'goldturret':
                        case 'camptower':
                            const speedModuleTiers = this.getSpeedModuleTiers();
                            const attacksPerTurn = speedModuleTiers.reduce((total, tier) => total + (tier + 1), 1);
                            for (let i = 0; i < attacksPerTurn; i++) {
                                if (this.shotsLeft > 0 || this.subtype === 'camptower') {
                                    this.attackNearbyEnemies();
                                }
                            }
                            break;
                        case 'bomb':
                            this.handleBomb();
                            break;
                    }
                }

                getNearbyCampfires() {
                    let count = 0;
                    for (let dy = -1; dy <= 1; dy++) {
                        for (let dx = -1; dx <= 1; dx++) {
                            const worldX = this.x + dx;
                            const worldY = this.y + dy;

                            const gridX = worldX - gameState.cameraOffset.x;
                            const gridY = worldY - gameState.cameraOffset.y;

                            if (gridX >= 0 && gridX < CONFIG.GRID_SIZE_X && gridY >= 0 && gridY < CONFIG.GRID_SIZE_Y) {
                                const obj = gameState.grid[gridY][gridX];
                                if (obj && obj.type === 'tech' && obj.subtype === 'campfire') {
                                    count++;
                                }
                            }
                        }
                    }
                    return count;
                }

                handleSupplyDrop() {
                    if (Math.random() < 0.33) {
                        const resources = ['coins', 'Steel', 'gold'];
                        const resource = resources[Math.floor(Math.random() * resources.length)];
                        const amount = 5 + Math.floor(Math.random() * 6);
                        gameState.addResources({ [resource]: amount });
                        showNotification(`+${amount} ${resource} from Supply Drop!`, this.x, this.y);
                        createResourceCollectionEffect(this.x, this.y, resource);
                    }
                }

                attackNearbyEnemies() {
                    if (this.shotsLeft <= 0) return false;

                    for (let dy = -this.range; dy <= this.range; dy++) {
                        for (let dx = -this.range; dx <= this.range; dx++) {
                            if (Math.max(Math.abs(dx), Math.abs(dy)) > this.range) continue;
                            const worldX = this.x + dx;
                            const worldY = this.y + dy;

                            const gridX = worldX - gameState.cameraOffset.x;
                            const gridY = worldY - gameState.cameraOffset.y;

                            if (gridX >= 0 && gridX < CONFIG.GRID_SIZE_X && gridY >= 0 && gridY < CONFIG.GRID_SIZE_Y) {
                                const target = gameState.grid[gridY][gridX];
                                if (target && target.type === 'enemy') {
                                    if (gridY >= 0 && gridY < CONFIG.GRID_SIZE_Y &&
                                        gridX >= 0 && gridX < CONFIG.GRID_SIZE_X) {
                                        gameState.grid[gridY][gridX] = null;
                                    }

                                    gameState.objects.delete(target.id);
                                    gameState.worldObjects.delete(target.id);
                                                                        
                                    // Handle Camp Tower coin collection
                                    if (this.subtype === 'camptower' && this.coinsPerKill) {
                                        gameState.addResources({ coins: this.coinsPerKill });
                                        showNotification(`+${this.coinsPerKill} coins from kill!`, this.x, this.y);
                                    } else {
                                        this.shotsLeft--;
                                        if (this.shotsLeft <= 0) {
                                            const selfGridX = this.x - gameState.cameraOffset.x;
                                            const selfGridY = this.y - gameState.cameraOffset.y;
                                            if (selfGridY >= 0 && selfGridY < CONFIG.GRID_SIZE_Y &&
                                                selfGridX >= 0 && selfGridX < CONFIG.GRID_SIZE_X) {
                                                gameState.grid[selfGridY][selfGridX] = null;
                                            }
                                                                                
                                            gameState.objects.delete(this.id);
                                            gameState.worldObjects.delete(this.id);
                                        }
                                    }
                                    return true;
                                }
                            }
                        }
                    }
                    return false;
                }

                handleBomb() {
                    for (let dy = -2; dy <= 2; dy++) {
                        for (let dx = -2; dx <= 2; dx++) {
                            const worldX = this.x + dx;
                            const worldY = this.y + dy;

                            const gridX = worldX - gameState.cameraOffset.x;
                            const gridY = worldY - gameState.cameraOffset.y;

                            if (gridX >= 0 && gridX < CONFIG.GRID_SIZE_X && gridY >= 0 && gridY < CONFIG.GRID_SIZE_Y) {
                                const target = gameState.grid[gridY][gridX];
                                if (target && target.type === 'enemy') {
                                    for (let dy2 = -2; dy2 <= 2; dy2++) {
                                        for (let dx2 = -2; dx2 <= 2; dx2++) {
                                            const worldX2 = this.x + dx2;
                                            const worldY2 = this.y + dy2;

                                            const gridX2 = worldX2 - gameState.cameraOffset.x;
                                            const gridY2 = worldY2 - gameState.cameraOffset.y;

                                            if (gridX2 >= 0 && gridX2 < CONFIG.GRID_SIZE_X && gridY2 >= 0 && gridY2 < CONFIG.GRID_SIZE_Y) {
                                                const target2 = gameState.grid[gridY2][gridX2];
                                                if (target2 && target2.type === 'enemy') {
                                                    if (gridY2 >= 0 && gridY2 < CONFIG.GRID_SIZE_Y &&
                                                        gridX2 >= 0 && gridX2 < CONFIG.GRID_SIZE_X) {
                                                        gameState.grid[gridY2][gridX2] = null;
                                                    }

                                                    gameState.objects.delete(target2.id);
                                                    gameState.worldObjects.delete(target2.id);
                                                }
                                            }
                                        }
                                    }

                                    const selfGridX = this.x - gameState.cameraOffset.x;
                                    const selfGridY = this.y - gameState.cameraOffset.y;
                                    if (selfGridY >= 0 && selfGridY < CONFIG.GRID_SIZE_Y &&
                                        selfGridX >= 0 && selfGridX < CONFIG.GRID_SIZE_X) {
                                        gameState.grid[selfGridY][selfGridX] = null;
                                    }

                                    gameState.objects.delete(this.id);
                                    gameState.worldObjects.delete(this.id);
                                    return;
                                }
                            }
                        }
                    }
                }

                takeDamage(damage = 1) {
                    this.health -= damage;
                    return this.health <= 0;
                }
            }

            class Army extends GameObject {
                constructor(x, y, subtype = 'scout') {
                    super(x, y, 'army', subtype);
                    this.cost = this.getCost();
                    this.health = this.getMaxHealth();
                    this.maxHealth = this.health;
                    this.range = this.getRange();
                    this.movement = this.getMovement();

                    if (subtype === 'barrack') {
                        this.spawnCounter = 0;
                    }
                }

                getCost() {
                    const costs = {
                        scout: { coins: 15 },
                        knight: { coins: 25 },
                        archer: { coins: 20 },
                        tank: { coins: 50 },
                        siegetower: { coins: 275 },
                        king: { gold: 500 },
                        barrack: { gold: 50 }
                    };
                    return costs[this.subtype] || { coins: 15 };
                }

                getMaxHealth() {
                    switch (this.subtype) {
                        case 'tank': return 5;
                        case 'king': return 25;
                        default: return 1;
                    }
                }

                getRange() {
                    switch (this.subtype) {
                        case 'archer':
                        case 'siegetower': return 4;
                        case 'king': return 2;
                        default: return 1;
                    }
                }

                getMovement() {
                    switch (this.subtype) {
                        case 'knight': return 5;
                        case 'archer': return 1;
                        case 'tank': return 1;
                        case 'king': return 2;
                        default: return 1;
                    }
                }

                getValidMoves() {
                    const moves = [];
                    const attacks = [];

                    const directions = this.subtype === 'knight' ?
                        [[-1, -1], [-1, 1], [1, -1], [1, 1]] :
                        [[-1, 0], [1, 0], [0, -1], [0, 1], [-1, -1], [-1, 1], [1, -1], [1, 1]];

                    directions.forEach(([dx, dy]) => {
                        for (let i = 1; i <= this.movement; i++) {
                            const worldX = this.x + dx * i;
                            const worldY = this.y + dy * i;

                            const gridX = worldX - gameState.cameraOffset.x;
                            const gridY = worldY - gameState.cameraOffset.y;

                            if (gridX < 0 || gridX >= CONFIG.GRID_SIZE_X || gridY < 0 || gridY >= CONFIG.GRID_SIZE_Y) break;

                            const target = gameState.grid[gridY][gridX];
                            if (target === null) {
                                moves.push({ x: worldX, y: worldY });
                            } else if (target.type === 'enemy') {
                                attacks.push({ x: worldX, y: worldY });
                                break;
                            } else {
                                break;
                            }
                        }
                    });

                    if (this.subtype === 'archer' || this.subtype === 'siegetower') {
                        const allDirections = [[-1, 0], [1, 0], [0, -1], [0, 1], [-1, -1], [-1, 1], [1, -1], [1, 1]];
                        allDirections.forEach(([dx, dy]) => {
                            for (let i = 1; i <= this.range; i++) {
                                const worldX = this.x + dx * i;
                                const worldY = this.y + dy * i;

                                const gridX = worldX - gameState.cameraOffset.x;
                                const gridY = worldY - gameState.cameraOffset.y;

                                if (gridX < 0 || gridX >= CONFIG.GRID_SIZE_X || gridY < 0 || gridY >= CONFIG.GRID_SIZE_Y) break;

                                const target = gameState.grid[gridY][gridX];
                                if (target && target.type === 'enemy') {
                                    attacks.push({ x: worldX, y: worldY });
                                }
                            }
                        });
                    }

                    return { moves, attacks };
                }

                onTurn() {
                    if (this.subtype === 'barrack') {
                        this.spawnCounter = (this.spawnCounter || 0) + 1;
                        if (this.spawnCounter >= 2) {
                            this.spawnCounter = 0;
                            const worldX = this.x - 1;
                            const worldY = this.y;

                            const gridX = worldX - gameState.cameraOffset.x;
                            const gridY = worldY - gameState.cameraOffset.y;

                            if (gridX >= 0 && gridX < CONFIG.GRID_SIZE_X && gridY >= 0 && gridY < CONFIG.GRID_SIZE_Y && gameState.grid[gridY][gridX] === null) {
                                const scout = new Army(worldX, worldY, 'scout');
                                addObjectToWorld(scout);
                                showNotification('Barrack spawned a Soldier!', gridX, gridY);
                            }
                        }
                    }
                }

                moveTo(x, y) {
                    const oldX = this.x;
                    const oldY = this.y;

                    this.x = x;
                    this.y = y;

                    gameState.worldObjects.set(this.id, this);

                    const oldGridX = oldX - gameState.cameraOffset.x;
                    const oldGridY = oldY - gameState.cameraOffset.y;
                    if (oldGridX >= 0 && oldGridX < CONFIG.GRID_SIZE_X &&
                        oldGridY >= 0 && oldGridY < CONFIG.GRID_SIZE_Y) {
                        gameState.grid[oldGridY][oldGridX] = null;
                    }

                    const gridX = x - gameState.cameraOffset.x;
                    const gridY = y - gameState.cameraOffset.y;

                    if (gridX >= 0 && gridX < CONFIG.GRID_SIZE_X && gridY >= 0 && gridY < CONFIG.GRID_SIZE_Y) {
                        gameState.grid[gridY][gridX] = this;
                        gameState.objects.set(this.id, this);
                    } else {
                        gameState.objects.delete(this.id);
                    }
                }

                takeDamage(damage = 1) {
                    this.health -= damage;
                    return this.health <= 0;
                }
            }

            class Enemy extends GameObject {
                constructor(x, y, subtype = 'basic') {
                    super(x, y, 'enemy', subtype);
                    this.health = this.getMaxHealth();
                    this.maxHealth = this.health;
                }

                getMaxHealth() {
                    // Base health values
                    let baseHealth;
                    switch (this.subtype) {
                        case 'tank': baseHealth = 100;
                            break;
                        case 'fast': baseHealth = 30;
                            break;
                        case 'ranged': baseHealth = 40;
                            break;
                        case 'healer': baseHealth = 25;
                            break;
                        default: baseHealth = 50;
                    }
                    
                    // Scale health every 5 waves by 1.5x
                    const waveScalingFactor = Math.pow(1.5, Math.floor((gameState.wave - 1) / 5));
                    const scaledHealth = Math.floor(baseHealth * waveScalingFactor);
                    
                    return scaledHealth;
                }

                onTurn() {
                    const playerGridX = CONFIG.PLAYER_START.x - gameState.cameraOffset.x;
                    const playerGridY = CONFIG.PLAYER_START.y - gameState.cameraOffset.y;

                    const playerWorldX = CONFIG.PLAYER_START.x;
                    const playerWorldY = CONFIG.PLAYER_START.y;

                    if (this.x === playerWorldX && this.y === playerWorldY) {
                        gameOver();
                        return;
                    }

                    const attacks = this.getValidAttacks();
                    if (attacks.length > 0) {
                        const target = attacks[0].target;
                        this.attackTarget(target);
                        return;
                    }

                    this.moveTowardsPlayer();
                }

                getValidAttacks() {
                    const attacks = [];
                    const directions = [[-1, 0], [1, 0], [0, -1], [0, 1], [-1, -1], [-1, 1], [1, -1], [1, 1]];

                    directions.forEach(([dx, dy]) => {
                        const worldX = this.x + dx;
                        const worldY = this.y + dy;

                        const gridX = worldX - gameState.cameraOffset.x;
                        const gridY = worldY - gameState.cameraOffset.y;

                        let target = null;

                        if (gridX >= 0 && gridX < CONFIG.GRID_SIZE_X && gridY >= 0 && gridY < CONFIG.GRID_SIZE_Y) {
                            target = gameState.grid[gridY][gridX];
                        } else {
                            for (const [id, obj] of gameState.worldObjects) {
                                if (obj.x === worldX && obj.y === worldY) {
                                    target = obj;
                                    break;
                                }
                            }

                            if (worldX === CONFIG.PLAYER_START.x && worldY === CONFIG.PLAYER_START.y) {
                                target = 'player';
                            }
                        }

                        if (target && (
                            target.type === 'army' ||
                            target.type === 'wall' ||
                            target.type === 'tech' ||
                            target === 'player'
                        )) {
                            attacks.push({ x: worldX, y: worldY, target });
                        }
                    });

                    return attacks;
                }

                moveTowardsPlayer() {
                    const playerGridX = CONFIG.PLAYER_START.x - gameState.cameraOffset.x;
                    const playerGridY = CONFIG.PLAYER_START.y - gameState.cameraOffset.y;

                    const playerWorldX = CONFIG.PLAYER_START.x;
                    const playerWorldY = CONFIG.PLAYER_START.y;

                    let dx = Math.sign(playerWorldX - this.x);
                    let dy = Math.sign(playerWorldY - this.y);

                    let newX = this.x + dx;
                    let newY = this.y + dy;

                    let newGridX = newX - gameState.cameraOffset.x;
                    let newGridY = newY - gameState.cameraOffset.y;

                    let canMove = true;
                    if (newGridX >= 0 && newGridX < CONFIG.GRID_SIZE_X &&
                        newGridY >= 0 && newGridY < CONFIG.GRID_SIZE_Y) {
                        canMove = gameState.grid[newGridY][newGridX] === null;
                    }

                    if (canMove) {
                        const oldGridX = this.x - gameState.cameraOffset.x;
                        const oldGridY = this.y - gameState.cameraOffset.y;
                        if (oldGridY >= 0 && oldGridY < CONFIG.GRID_SIZE_Y &&
                            oldGridX >= 0 && oldGridX < CONFIG.GRID_SIZE_X) {
                            gameState.grid[oldGridY][oldGridX] = null;
                        }

                        this.x = newX;
                        this.y = newY;

                        if (newGridX >= 0 && newGridX < CONFIG.GRID_SIZE_X &&
                            newGridY >= 0 && newGridY < CONFIG.GRID_SIZE_Y) {
                            gameState.grid[newGridY][newGridX] = this;
                        }

                        gameState.worldObjects.set(this.id, this);
                        gameState.objects.set(this.id, this);
                    }
                }

                attackTarget(target) {
                    if (target.type === 'army' || target.type === 'tech') {
                        const isDestroyed = target.takeDamage(1);
                        if (isDestroyed) {
                            if (target.y >= gameState.cameraOffset.y && target.y < gameState.cameraOffset.y + CONFIG.GRID_SIZE_Y &&
                                target.x >= gameState.cameraOffset.x && target.x < gameState.cameraOffset.x + CONFIG.GRID_SIZE_X) {
                                const gridY = target.y - gameState.cameraOffset.y;
                                const gridX = target.x - gameState.cameraOffset.x;
                                gameState.grid[gridY][gridX] = null;
                            }

                            gameState.objects.delete(target.id);
                            gameState.worldObjects.delete(target.id);

                            if (gameState.selectedUnit && gameState.selectedUnit.id === target.id) {
                                clearSelection();
                            }
                        }
                    } else if (target.type === 'wall') {
                        const isDestroyed = target.takeDamage(1);
                        if (isDestroyed) {
                            if (target.y >= gameState.cameraOffset.y && target.y < gameState.cameraOffset.y + CONFIG.GRID_SIZE_Y &&
                                target.x >= gameState.cameraOffset.x && target.x < gameState.cameraOffset.x + CONFIG.GRID_SIZE_X) {
                                const gridY = target.y - gameState.cameraOffset.y;
                                const gridX = target.x - gameState.cameraOffset.x;
                                gameState.grid[gridY][gridX] = null;
                            }

                            gameState.objects.delete(target.id);
                            gameState.worldObjects.delete(target.id);
                        }
                    } else if (target === 'player') {
                        gameOver();
                    }
                }

                takeDamage(damage = 1) {
                    this.health -= damage;
                    return this.health <= 0;
                }
            }

            const gameState = new GameState();

            async function initGame() {
                await loadTechTree();

                if (CONFIG.TECH_TREE.fortress && !gameState.isTechResearched('fortress')) {
                    console.log('Automatically researching Fortress at game start');
                    gameState.researchedTechs.add('fortress');
                    gameState.updateAvailableTechs();
                    gameState.checkTechTreeCompletion();
                }

                if (window.waveBreakTimeout) {
                    clearTimeout(window.waveBreakTimeout);
                    window.waveBreakTimeout = null;
                }

                createGrid();

                if (typeof gameState.cameraOffset === 'undefined') {
                    gameState.cameraOffset = { x: 0, y: 0 };
                }

                gameState.cameraOffset.x = Math.floor(CONFIG.GRID_SIZE_X / 2) - CONFIG.PLAYER_START.x;
                gameState.cameraOffset.y = Math.floor(CONFIG.GRID_SIZE_Y / 2) - CONFIG.PLAYER_START.y;

                const playerWorldX = CONFIG.PLAYER_START.x;
                const playerWorldY = CONFIG.PLAYER_START.y;
                const playerGridX = playerWorldX - gameState.cameraOffset.x;
                const playerGridY = playerWorldY - gameState.cameraOffset.y;

                if (playerGridX >= 0 && playerGridX < CONFIG.GRID_SIZE_X &&
                    playerGridY >= 0 && playerGridY < CONFIG.GRID_SIZE_Y) {
                    gameState.grid[playerGridY][playerGridX] = 'player';
                }

                // Force immediate and complete grid refresh to ensure player is visible
                setTimeout(() => {
                    // Rebuild grid completely
                    createGrid();
                    // Update grid data with world objects and player
                    updateGridFromWorldObjects();
                    // Refresh visual display
                    updateDisplay();
                    console.log('Complete grid rebuild and refresh after camera setup');
                }, 100);

                if (typeof gameState.enemiesRemaining === 'undefined') {
                    gameState.enemiesRemaining = 0;
                }

                spawnEnemy(5, 5);
                spawnEnemy(10, 2);
                spawnEnemy(2, 10);

                console.log(`Initial enemies spawned, count: ${gameState.enemiesRemaining}`);
                gameState.countEnemies();
                console.log(`After countEnemies, enemies remaining: ${gameState.enemiesRemaining}`);
                updateDisplay();
                setupEventListeners();

                showHomescreen();

                // Initialize daily crate system
                initializeDailyCrate();

                if (window.buttonStateInterval) {
                    clearInterval(window.buttonStateInterval);
                }
                window.buttonStateInterval = setInterval(updateButtonStates, 2000);
            }

            function createGrid() {
                const gridElement = document.getElementById('game-grid');
                if (!gridElement) {
                    console.error('Game grid element not found');
                    return;
                }

                gridElement.innerHTML = '';

                for (let y = 0; y < CONFIG.GRID_SIZE_Y; y++) {
                    for (let x = 0; x < CONFIG.GRID_SIZE_X; x++) {
                        const cell = document.createElement('div');
                        cell.className = 'grid-cell';
                        cell.dataset.x = x;
                        cell.dataset.y = y;

                        cell.addEventListener('click', (function (x, y) {
                            return function (e) {
                                e.stopPropagation();
                                handleCellClick(x, y);
                            };
                        })(x, y));

                        gridElement.appendChild(cell);
                    }
                }
            }

            let placementPreviewTooltip = null;

            function handleCellHover(x, y, isEntering) {
                if (!gameState.placementMode) {
                    hidePlacementPreview();
                    return;
                }

                const worldX = x + gameState.cameraOffset.x;
                const worldY = y + gameState.cameraOffset.y;

                if (isEntering) {
                    const cell = gameState.grid[y][x];
                    if (cell === null) {
                        showPlacementPreview(x, y, worldX, worldY);
                    } else {
                        hidePlacementPreview();
                    }
                } else {
                    hidePlacementPreview();
                }
            }

            function showPlacementPreview(gridX, gridY, worldX, worldY) {
                if (!placementPreviewTooltip) {
                    placementPreviewTooltip = document.createElement('div');
                    placementPreviewTooltip.className = 'placement-preview-tooltip';
                    document.body.appendChild(placementPreviewTooltip);
                }

                const [type, subtype] = parsePlacementMode(gameState.placementMode);
                const displayName = getDisplayName(type, subtype);
                const sprite = getSpriteForMode(gameState.placementMode);

                let cost = {};
                try {
                    if (type === 'wall') {
                        cost = getWallCost(subtype);
                    } else if (type === 'tech') {
                        const tempObj = new Tech(0, 0, subtype || 'miner');
                        cost = tempObj.cost;
                    } else if (type === 'army') {
                        const tempObj = new Army(0, 0, subtype || 'scout');
                        cost = tempObj.cost;
                    }
                } catch (e) {
                    cost = { 'See Info': 0 };
                }

                let costHtml = '';
                for (const [resource, amount] of Object.entries(cost)) {
                    if (amount > 0) {
                        const resourceIcon = getResourceIcon(resource);
                        const resourceSymbol = getResourceSymbol(resource);
                        costHtml += `
                <div class="preview-cost-item">
                    <img src="${resourceIcon}" alt="${resource}">
                    <span>${amount}${resourceSymbol}</span>
                </div>
            `;
                    }
                }

                if (!costHtml) {
                    costHtml = '<div class="preview-cost-placeholder">See Info Panel</div>';
                }

                placementPreviewTooltip.innerHTML = `
        <div class="preview-tooltip-content">
            <div class="preview-header">
                <img src="${sprite}" alt="${displayName}" class="preview-icon" onerror="this.classList.add('error'); this.src='./sprites/missing.png';">
                <div class="preview-title">${displayName}</div>
            </div>
            <div class="preview-costs">
                ${costHtml}
            </div>
            <div class="preview-instruction">CLICK TO PLACE</div>
        </div>
    `;

                const cellRect = document.querySelector(`[data-x="${gridX}"][data-y="${gridY}"]`).getBoundingClientRect();
                const tooltipWidth = placementPreviewTooltip.offsetWidth || 200;
                const tooltipHeight = placementPreviewTooltip.offsetHeight || 120;

                let left = cellRect.left + cellRect.width / 2 - tooltipWidth / 2;
                let top = cellRect.top - tooltipHeight - 12;

                left = Math.max(15, Math.min(left, window.innerWidth - tooltipWidth - 15));
                top = Math.max(15, Math.min(top, window.innerHeight - tooltipHeight - 15));

                placementPreviewTooltip.style.cssText = `
        position: fixed;
        left: ${left}px;
        top: ${top}px;
        z-index: 10000;
        pointer-events: none;
        display: block;
    `;
            }

            function hidePlacementPreview() {
                if (placementPreviewTooltip) {
                    placementPreviewTooltip.style.display = 'none';
                }
            }

            function getDisplayName(type, subtype) {
                const names = {
                    'wall': {
                        'stone': 'Stone Wall',
                        'steel': 'Steel Wall',
                        'spike': 'Spike Trap',
                        'fortress': 'Fortress Wall'
                    },
                    'tech': {
                        'miner': 'Iron Miner',
                        'goldminer': 'Gold Miner',
                        'coinmaker': 'Coin Maker',
                        'oilrig': 'Oil Rig',
                        'supply': 'Supply Drop',
                        'turret': 'Basic Turret',
                        'goldturret': 'Gold Turret',
                        'bomb': 'Bomb',
                        'campfire': 'Campfire'
                    },
                    'army': {
                        'scout': 'Scout',
                        'knight': 'Knight',
                        'archer': 'Archer',
                        'tank': 'Tank',
                        'siegetower': 'Siege Tower',
                        'king': 'King',
                        'barrack': 'Barracks'
                    }
                };

                if (names[type] && names[type][subtype]) {
                    return names[type][subtype];
                }

                return subtype ? subtype.charAt(0).toUpperCase() + subtype.slice(1) : type.charAt(0).toUpperCase() + type.slice(1);
            }

            function getSpriteForMode(mode) {
                if (mode.includes('-')) {
                    const parts = mode.split('-');
                    const type = parts[0];
                    const subtype = parts[1];

                    if (CONFIG.SPRITES[type] && CONFIG.SPRITES[type][subtype]) {
                        return CONFIG.SPRITES[type][subtype];
                    }

                    const fallbackSprites = {
                        'wall-stone': './sprites/wall.png',
                        'wall-steel': './sprites/wallsteel.png',
                        'wall-spike': './sprites/spike.png',
                        'wall-castle': './sprites/Castle_wall.png',
                        'tech-miner': './sprites/iron.png',
                        'tech-goldminer': './sprites/gold.png',
                        'tech-coinmaker': './sprites/bank.png',
                        'tech-oilrig': './sprites/oilrig.png',
                        'tech-turret': './sprites/turret.png',
                        'tech-goldturret': './sprites/goldturret.png',
                        'tech-bomb': './sprites/bomb.png',
                        'tech-supply': './sprites/supply.gif',
                        'tech-campfire': './sprites/campfire.gif',
                        'tech-warpgate': './sprites/wargate.png',
                        'army-scout': './sprites/soldier.png',
                        'army-knight': './sprites/knight.png',
                        'army-archer': './sprites/Archer.png',
                        'army-tank': './sprites/Tank.png',
                        'army-king': './sprites/king.png',
                        'army-barrack': './sprites/barrack.png',
                        'army-siegetower': './sprites/siegetower.png',
                        'army-camptower': './sprites/camptower.png'
                    };

                    if (fallbackSprites[mode]) {
                        return fallbackSprites[mode];
                    }
                } else {
                    if (CONFIG.SPRITES[mode]) {
                        return CONFIG.SPRITES[mode];
                    }

                    const simpleFallback = {
                        'player': './sprites/spawn.png',
                        'wall': './sprites/wall.png'
                    };

                    if (simpleFallback[mode]) {
                        return simpleFallback[mode];
                    }
                }

                return './sprites/missing.png';
            }

            function reattachGridCellListeners() {
                document.querySelectorAll('.grid-cell').forEach(cell => {
                    const x = parseInt(cell.dataset.x);
                    const y = parseInt(cell.dataset.y);
                    const newCell = cell.cloneNode(true);
                    cell.parentNode.replaceChild(newCell, cell);

                    newCell.addEventListener('click', (e) => {
                        e.stopPropagation();
                        handleCellClick(x, y);
                    });

                    newCell.addEventListener('mouseenter', (e) => {
                        e.stopPropagation();
                        handleCellHover(x, y, true);
                    });

                    newCell.addEventListener('mouseleave', (e) => {
                        e.stopPropagation();
                        handleCellHover(x, y, false);
                    });
                });
            }

            function handleCellClick(x, y) {
                const worldX = x + gameState.cameraOffset.x;
                const worldY = y + gameState.cameraOffset.y;

                const cell = gameState.grid[y][x];
                let actionTaken = false;

                if (gameState.placementMode) {
                    if (cell === null) {
                        const [type, subtype] = parsePlacementMode(gameState.placementMode);
                        const placed = placeObject(x, y, type, subtype);
                        if (placed) {
                            actionTaken = true;
                            window.keepFoldersOpen = false;
                            console.log('Resetting keepFoldersOpen = false after placement');
                        }
                    }
                    updateDisplay();
                    if (actionTaken) {
                        processEnemyTurn();
                    }
                    return;
                }

                if (cell && cell.type === 'army') {
                    clearSelection();
                    gameState.selectedUnit = cell;
                    highlightValidMoves(cell);
                    updateDisplay();
                    return;
                }

                if (cell && (cell.type === 'wall' || cell.type === 'tech')) {
                    showBuildingInfo(cell);
                    return;
                }

                if (gameState.selectedUnit) {
                    const { moves, attacks } = gameState.selectedUnit.getValidMoves();

                    const isValidMove = moves.some(move => move.x === worldX && move.y === worldY);
                    const isValidAttack = attacks.some(attack => attack.x === worldX && attack.y === worldY);

                    if (isValidMove && cell === null) {
                        gameState.selectedUnit.moveTo(worldX, worldY);
                        actionTaken = true;
                    } else if (isValidAttack && cell && cell.type === 'enemy') {
                        attackEnemy(cell);
                        actionTaken = true;
                    } else {
                        clearSelection();
                    }

                    clearSelection();
                    updateDisplay();
                    if (actionTaken) {
                        processEnemyTurn();
                    }
                }
            }

            function parsePlacementMode(mode) {
                if (mode.includes('-')) {
                    const parts = mode.split('-');
                    return [parts[0], parts[1]];
                }
                return [mode, null];
            }

            function placeObject(x, y, type, subtype = null) {
                const worldX = x + gameState.cameraOffset.x;
                const worldY = y + gameState.cameraOffset.y;

                if (type === 'tech' && subtype === 'oilrig') {
                    if (isAdjacentToCampfire(x, y)) {
                        showNotification('Oil rigs cannot be placed beside campfires!', x, y, 'warning');
                        return false;
                    }
                }

                if (type === 'tech' && subtype === 'campfire') {
                    if (isAdjacentToOilRig(x, y)) {
                        showNotification('Campfires cannot be placed beside oil rigs!', x, y, 'warning');
                        return false;
                    }
                }

                if (type === 'tech' && subtype === 'camptower') {
                    if (isWithinTwoBlockRadiusOfBuilding(x, y)) {
                        showNotification('Camp Tower cannot be placed within 2 blocks of any building!', x, y, 'warning');
                        return false;
                    }
                }

                let obj;
                let cost;

                switch (type) {
                    case 'wall':
                        console.log(`Creating wall with subtype: ${subtype || 'stone'}`);
                        obj = new Wall(worldX, worldY, subtype || 'stone');
                        console.log(`Wall created with health: ${obj.health}/${obj.maxHealth}`);
                        cost = getWallCost(subtype);
                        break;
                    case 'tech':
                        obj = new Tech(worldX, worldY, subtype || 'miner');
                        cost = obj.cost;
                        break;
                    case 'army':
                        obj = new Army(worldX, worldY, subtype || 'scout');
                        cost = obj.cost;
                        break;
                    default:
                        return false;
                }

                if (!gameState.canAfford(cost)) {
                    showNotification('Not enough resources!', x, y, 'warning');
                    return false;
                }

                gameState.spendResources(cost);
                addObjectToWorld(obj);

                if (type === 'tech') {
                    obj.onTurn();
                }

                showNotification(`${subtype || type} placed!`, x, y, 'success');
                createPlacementEffect(x, y);
                return true;
            }

            function isAdjacentToCampfire(x, y) {
                for (let dy = -1; dy <= 1; dy++) {
                    for (let dx = -1; dx <= 1; dx++) {
                        if (dx === 0 && dy === 0) continue;

                        const checkX = x + dx;
                        const checkY = y + dy;

                        if (checkX >= 0 && checkX < CONFIG.GRID_SIZE_X && checkY >= 0 && checkY < CONFIG.GRID_SIZE_Y) {
                            const obj = gameState.grid[checkY][checkX];
                            if (obj && obj.type === 'tech' && obj.subtype === 'campfire') {
                                return true;
                            }
                        }
                    }
                }
                return false;
            }

            function isAdjacentToOilRig(x, y) {
                for (let dy = -1; dy <= 1; dy++) {
                    for (let dx = -1; dx <= 1; dx++) {
                        if (dx === 0 && dy === 0) continue;

                        const checkX = x + dx;
                        const checkY = y + dy;

                        if (checkX >= 0 && checkX < CONFIG.GRID_SIZE_X && checkY >= 0 && checkY < CONFIG.GRID_SIZE_Y) {
                            const obj = gameState.grid[checkY][checkX];
                            if (obj && obj.type === 'tech' && obj.subtype === 'oilrig') {
                                return true;
                            }
                        }
                    }
                }
                return false;
            }

            function isWithinTwoBlockRadiusOfBuilding(x, y) {
                for (let dy = -2; dy <= 2; dy++) {
                    for (let dx = -2; dx <= 2; dx++) {
                        if (dx === 0 && dy === 0) continue;

                        const checkX = x + dx;
                        const checkY = y + dy;

                        if (checkX >= 0 && checkX < CONFIG.GRID_SIZE_X && checkY >= 0 && checkY < CONFIG.GRID_SIZE_Y) {
                            const obj = gameState.grid[checkY][checkX];
                            if (obj && (obj.type === 'wall' || obj.type === 'tech' || obj.type === 'army')) {
                                return true;
                            }
                        }
                    }
                }
                return false;
            }

            function getWallCost(subtype) {
                switch (subtype) {
                    case 'steel': return { Steel: 20 };
                    case 'spike': return { Steel: 15 };
                    case 'castle': return { gold: 25 };
                    default: return { Steel: 10 };
                }
            }

            function spawnEnemy(x, y, subtype = null) {
                console.log(`spawnEnemy called with x=${x}, y=${y}`);
                const worldX = x + gameState.cameraOffset.x;
                const worldY = y + gameState.cameraOffset.y;

                if (y >= 0 && y < CONFIG.GRID_SIZE_Y && x >= 0 && x < CONFIG.GRID_SIZE_X && gameState.grid[y][x] === null) {
                    if (!subtype) {
                        const enemyTypes = [
                            { type: 'basic', weight: 5 },
                            { type: 'fast', weight: 3 },
                            { type: 'tank', weight: 2 },
                            { type: 'ranged', weight: 3 },
                            { type: 'healer', weight: 2 }
                        ];

                        const totalWeight = enemyTypes.reduce((sum, type) => sum + type.weight, 0);
                        let random = Math.random() * totalWeight;

                        for (const enemyType of enemyTypes) {
                            random -= enemyType.weight;
                            if (random <= 0) {
                                subtype = enemyType.type;
                                break;
                            }
                        }
                    }

                    const enemy = new Enemy(worldX, worldY, subtype || 'basic');
                    addObjectToWorld(enemy);
                    gameState.enemiesRemaining++;
                    console.log(`Enemy spawned, enemies remaining: ${gameState.enemiesRemaining}`);
                } else {
                    console.log(`Failed to spawn enemy at ${x},${y} - cell not empty or out of bounds`);
                }
            }

            function clearSelection() {
                gameState.selectedUnit = null;
                document.querySelectorAll('.grid-cell').forEach(cell => {
                    cell.classList.remove('selected', 'valid-move', 'valid-attack');
                });
            }

            function attackEnemy(enemy) {
                const gridX = enemy.x - gameState.cameraOffset.x;
                const gridY = enemy.y - gameState.cameraOffset.y;

                if (gridY >= 0 && gridY < CONFIG.GRID_SIZE_Y &&
                    gridX >= 0 && gridX < CONFIG.GRID_SIZE_X) {
                    gameState.grid[gridY][gridX] = null;
                }

                gameState.objects.delete(enemy.id);
                gameState.worldObjects.delete(enemy.id);
                gameState.enemiesRemaining--;
                console.log(`Enemy attacked, enemies remaining: ${gameState.enemiesRemaining}`);

                gameState.addResources({ coins: 5 });
                createEnemyDefeatEffect(enemy.x, enemy.y);
            }

            function gameOver() {
                showDeathScreen();
            }

            function showDeathScreen() {
                const deathScreen = document.getElementById('death-screen');
                if (!deathScreen) {
                    console.error('Death screen element not found!');
                    return;
                }

                document.getElementById('death-turns').textContent = gameState.turn;
                document.getElementById('death-waves').textContent = gameState.wave;

                const resourcesLost = Object.values(gameState.sessionResources).reduce((sum, val) => sum + val, 0);
                document.getElementById('death-resources').textContent = resourcesLost;

                deathScreen.classList.add('active');

                gameState.totalMissions++;
                updateStatsPanel();
            }

            function hideDeathScreen() {
                const deathScreen = document.getElementById('death-screen');
                if (deathScreen) {
                    deathScreen.classList.remove('active');
                }
            }

            function highlightValidMoves(unit) {
                const { moves, attacks } = unit.getValidMoves();

                moves.forEach(move => {
                    const gridX = move.x - gameState.cameraOffset.x;
                    const gridY = move.y - gameState.cameraOffset.y;

                    if (gridX >= 0 && gridX < CONFIG.GRID_SIZE_X &&
                        gridY >= 0 && gridY < CONFIG.GRID_SIZE_Y) {
                        const cell = document.querySelector(`[data-x="${gridX}"][data-y="${gridY}"]`);
                        if (cell) {
                            cell.classList.add('valid-move');
                        }
                    }
                });

                attacks.forEach(attack => {
                    const gridX = attack.x - gameState.cameraOffset.x;
                    const gridY = attack.y - gameState.cameraOffset.y;

                    if (gridX >= 0 && gridX < CONFIG.GRID_SIZE_X &&
                        gridY >= 0 && gridY < CONFIG.GRID_SIZE_Y) {
                        const cell = document.querySelector(`[data-x="${gridX}"][data-y="${gridY}"]`);
                        if (cell) {
                            cell.classList.add('valid-attack');
                        }
                    }
                });

                const unitGridX = unit.x - gameState.cameraOffset.x;
                const unitGridY = unit.y - gameState.cameraOffset.y;

                if (unitGridX >= 0 && unitGridX < CONFIG.GRID_SIZE_X &&
                    unitGridY >= 0 && unitGridY < CONFIG.GRID_SIZE_Y) {
                    const unitCell = document.querySelector(`[data-x="${unitGridX}"][data-y="${unitGridY}"]`);
                    if (unitCell) {
                        unitCell.classList.add('selected');
                    }
                }
            }

            function spawnNextWave() {
                console.log("spawnNextWave called");
                if (window.waveBreakTimeout) {
                    clearTimeout(window.waveBreakTimeout);
                    window.waveBreakTimeout = null;
                }
                gameState.wave++;
                console.log(`Wave incremented to ${gameState.wave}`);
                gameState.inWaveBreak = false;
                console.log("Wave break reset to false");

                let baseEnemies = 5 + gameState.wave * 3;
                let zoneMultiplier = 1;

                switch (gameState.currentZone) {
                    case 'shallow':
                        zoneMultiplier = 1.2;
                        break;
                    case 'medium':
                        zoneMultiplier = 1.8;
                        break;
                    case 'deep':
                        zoneMultiplier = 2.5;
                        break;
                    default:
                        zoneMultiplier = 1.2;
                }

                let numEnemies = Math.floor(baseEnemies * zoneMultiplier);

                const emptyCells = [];
                const priorityCells = [];
                const distantCells = [];

                const playerGridX = CONFIG.PLAYER_START.x - gameState.cameraOffset.x;
                const playerGridY = CONFIG.PLAYER_START.y - gameState.cameraOffset.y;

                for (let y = 0; y < CONFIG.GRID_SIZE_Y; y++) {
                    for (let x = 0; x < CONFIG.GRID_SIZE_X; x++) {
                        if (x === playerGridX && y === playerGridY) continue;

                        if (gameState.grid[y][x] === null) {
                            const distance = Math.abs(x - playerGridX) + Math.abs(y - playerGridY);

                            if (distance <= 3) {
                                priorityCells.push({ x, y, distance });
                            } else if (distance <= 6) {
                                emptyCells.push({ x, y, distance });
                            } else {
                                distantCells.push({ x, y, distance });
                            }
                        }
                    }
                }

                priorityCells.sort((a, b) => a.distance - b.distance);
                distantCells.sort((a, b) => b.distance - a.distance);

                let selectedCells = [];

                switch (gameState.currentZone) {
                    case 'shallow':
                        selectedCells = [...distantCells, ...emptyCells.slice(0, Math.floor(emptyCells.length * 0.3)), ...priorityCells.slice(0, 2)];
                        break;
                    case 'medium':
                        selectedCells = [...emptyCells, ...priorityCells.slice(0, Math.floor(priorityCells.length * 0.5)), ...distantCells.slice(0, Math.floor(distantCells.length * 0.3))];
                        break;
                    case 'deep':
                        const safePriorityCells = priorityCells.filter(cell => cell.distance > 2);
                        selectedCells = [...safePriorityCells, ...emptyCells.slice(0, Math.floor(emptyCells.length * 0.4)), ...distantCells.slice(0, 2)];
                        break;
                    default:
                        selectedCells = [...emptyCells, ...priorityCells, ...distantCells];
                }

                for (let i = selectedCells.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [selectedCells[i], selectedCells[j]] = [selectedCells[j], selectedCells[i]];
                }

                const enemiesToSpawn = Math.min(numEnemies, selectedCells.length);

                console.log(`Spawning wave ${gameState.wave}: ${enemiesToSpawn} enemies in ${gameState.currentZone} zone`);

                for (let i = 0; i < enemiesToSpawn; i++) {
                    const { x, y } = selectedCells[i];
                    spawnEnemy(x, y);
                }

                gameState.countEnemies();
                showNotification(`Wave ${gameState.wave} incoming!`, CONFIG.PLAYER_START.x, CONFIG.PLAYER_START.y, 'warning');
                updateDisplay();
            }

            function processEnemyTurn() {
                gameState.objects.forEach(obj => {
                    if (obj.type === 'army' && obj.onTurn) {
                        obj.onTurn();
                    }
                });

                gameState.objects.forEach(obj => {
                    if (obj.type === 'tech' && obj.onTurn) {
                        obj.onTurn();
                    }
                });

                const enemies = [];
                gameState.objects.forEach(obj => {
                    if (obj.type === 'enemy') {
                        enemies.push(obj);
                    }
                });

                enemies.forEach(enemy => {
                    enemy.onTurn();
                });

                gameState.turn++;
                gameState.countEnemies();

                if (gameState.gameMode === 'active_zone') {
                    updateExtractionUI();
                }

                console.log(`Enemies remaining: ${gameState.enemiesRemaining}, In wave break: ${gameState.inWaveBreak}`);

                if (gameState.enemiesRemaining === 0 && !gameState.inWaveBreak) {
                    console.log("Condition met: enemiesRemaining is 0 and not in wave break");
                    console.log("Starting wave break");
                    gameState.inWaveBreak = true;
                    gameState.waveBreakTurns = CONFIG.WAVE_BREAK_TURNS;
                    showNotification(`Wave ${gameState.wave} complete! Prepare for the next wave.`, CONFIG.PLAYER_START.x, CONFIG.PLAYER_START.y, 'success');
                }

                if (gameState.inWaveBreak) {
                    console.log(`Wave break turns remaining: ${gameState.waveBreakTurns}`);
                    gameState.waveBreakTurns--;
                    console.log(`Decremented wave break turns: ${gameState.waveBreakTurns}`);
                    if (gameState.waveBreakTurns <= 0) {
                        console.log("Spawning next wave");
                        spawnNextWave();
                    } else {

                        if (window.waveBreakTimeout) {
                            clearTimeout(window.waveBreakTimeout);
                        }
                        window.waveBreakTimeout = setTimeout(processEnemyTurn, 1000);
                    }
                }

                updateDisplay();
            }

            function updateDisplay() {
                document.getElementById('steel-count').textContent = gameState.resources.Steel;
                document.getElementById('coin-count').textContent = gameState.resources.coins;
                document.getElementById('gold-count').textContent = gameState.resources.gold;
                document.getElementById('oil-count').textContent = gameState.resources.oil;

                const vaultStoredSteel = document.getElementById('vault-stored-steel-count');
                if (vaultStoredSteel) {
                    vaultStoredSteel.textContent = gameState.storedResources.Steel;
                    console.log('Updated vault steel to:', gameState.storedResources.Steel);
                } else {
                    console.log('vault-stored-steel-count element not found');
                }

                const vaultTotalStorage = document.getElementById('vault-total-storage');
                if (vaultTotalStorage) {
                    const steelValue = gameState.storedResources.Steel * 1;
                    const coinValue = gameState.storedResources.coins * 5;
                    const goldValue = gameState.storedResources.gold * 2;
                    const oilValue = gameState.storedResources.oil * 20;

                    const vaultValue = steelValue + coinValue + goldValue + oilValue;

                    console.log('=== VAULT VALUE UPDATE ===');
                    console.log('Steel:', gameState.storedResources.Steel, '× 1 =', steelValue);
                    console.log('Coins:', gameState.storedResources.coins, '× 5 =', coinValue);
                    console.log('Gold:', gameState.storedResources.gold, '× 2 =', goldValue);
                    console.log('Oil:', gameState.storedResources.oil, '× 20 =', oilValue);
                    console.log('Total Value:', vaultValue);

                    vaultTotalStorage.textContent = vaultValue;
                    console.log('Vault display updated to:', vaultValue);
                } else {
                    console.log('vault-total-storage element not found');
                }

                const vaultStoredCoin = document.getElementById('vault-stored-coin-count');
                if (vaultStoredCoin) {
                    vaultStoredCoin.textContent = gameState.storedResources.coins;
                    console.log('Updated vault coins to:', gameState.storedResources.coins);
                } else {
                    console.log('vault-stored-coin-count element not found');
                }

                const vaultStoredGold = document.getElementById('vault-stored-gold-count');
                if (vaultStoredGold) {
                    vaultStoredGold.textContent = gameState.storedResources.gold;
                    console.log('Updated vault gold to:', gameState.storedResources.gold);
                } else {
                    console.log('vault-stored-gold-count element not found');
                }

                const vaultStoredOil = document.getElementById('vault-stored-oil-count');
                if (vaultStoredOil) {
                    vaultStoredOil.textContent = gameState.storedResources.oil;
                    console.log('Updated vault oil to:', gameState.storedResources.oil);
                } else {
                    console.log('vault-stored-oil-count element not found');
                }

                const sessionSteel = document.getElementById('session-steel-count');
                if (sessionSteel) sessionSteel.textContent = gameState.sessionResources.Steel;
                const sessionCoin = document.getElementById('session-coin-count');
                if (sessionCoin) sessionCoin.textContent = gameState.sessionResources.coins;

                document.getElementById('turn-count').textContent = gameState.turn;
                document.getElementById('wave-count').textContent = gameState.wave;
                document.getElementById('enemies-remaining').textContent = gameState.enemiesRemaining;

                const instructions = document.getElementById('turn-instructions');
                if (gameState.inWaveBreak) {
                    instructions.textContent = `Wave break: ${gameState.waveBreakTurns} turns until next wave`;
                } else if (gameState.placementMode) {
                    instructions.textContent = 'Click on an empty cell to place the selected object';
                } else if (gameState.selectedUnit) {
                    instructions.textContent = 'Click on a highlighted cell to move or attack';
                } else {
                    instructions.textContent = 'Click an army unit to select it, then click a highlighted square to move';
                }

                document.querySelectorAll('.grid-cell').forEach(cell => {
                    const x = parseInt(cell.dataset.x);
                    const y = parseInt(cell.dataset.y);
                    const obj = gameState.grid[y][x];

                    cell.className = 'grid-cell';
                    
                    // Add zone-specific class if in active zone
                    if (gameState.gameMode === 'active_zone' && gameState.currentZone) {
                        cell.classList.add(`zone-${gameState.currentZone}`);
                    }
                    cell.innerHTML = '';

                    if (obj === 'player') {
                        const sprite = document.createElement('div');
                        sprite.className = 'object-sprite';
                        const img = document.createElement('img');
                        img.src = CONFIG.SPRITES.player;
                        img.alt = 'player';
                        sprite.appendChild(img);
                        cell.appendChild(sprite);
                    } else if (obj && obj.type) {
                        const sprite = document.createElement('div');
                        sprite.className = 'object-sprite';
                        const img = document.createElement('img');
                        const spritePath = obj.getSprite();
                        console.log(`Setting sprite for ${obj.type}-${obj.subtype}: ${spritePath}`);
                        img.src = spritePath;
                        img.alt = obj.subtype;
                        img.onerror = function() {
                            console.error(`Failed to load sprite: ${spritePath}`);
                        };
                        sprite.appendChild(img);

                        if (obj.health < obj.maxHealth) {
                            const healthBar = document.createElement('div');
                            healthBar.className = 'health-bar';
                            const healthFill = document.createElement('div');
                            healthFill.className = 'health-fill';
                            healthFill.style.width = `${(obj.health / obj.maxHealth) * 100}%`;
                            healthBar.appendChild(healthFill);
                            cell.appendChild(healthBar);
                        }

                        cell.appendChild(sprite);
                    }

                    if (gameState.selectedUnit &&
                        gameState.selectedUnit.x === (x + gameState.cameraOffset.x) &&
                        gameState.selectedUnit.y === (y + gameState.cameraOffset.y)) {
                        cell.classList.add('selected');
                    }
                });

                if (gameState.selectedUnit) {
                    highlightValidMoves(gameState.selectedUnit);
                }

                reattachGridCellListeners();

                updateButtonStates();
                updateTechTreeDisplay();

                updateTechTreeResources();

                if (gameState.gameMode === 'active_zone') {
                    updateExtractionUI();
                }

                if (document.getElementById('module-selection-popup').style.display === 'flex') {
                    updateModuleAffordability();
                }
            }

            function updateTechTreeResources() {
                const techTreePopup = document.getElementById('tech-tree-popup');
                if (techTreePopup && techTreePopup.style.display === 'flex') {
                    const steelElement = document.getElementById('tech-tree-steel');
                    const coinsElement = document.getElementById('tech-tree-coins');
                    const goldElement = document.getElementById('tech-tree-gold');
                    const oilElement = document.getElementById('tech-tree-oil');

                    if (steelElement) steelElement.textContent = gameState.resources.Steel;
                    if (coinsElement) coinsElement.textContent = gameState.resources.coins;
                    if (goldElement) goldElement.textContent = gameState.resources.gold;
                    if (oilElement) oilElement.textContent = gameState.resources.oil;
                }
            }

            function updateTechTreeDisplay() {
                const techTreeContent = document.getElementById('tech-tree-content');
                if (techTreeContent && techTreeContent.style.display !== 'none') {
                    renderTechTree();
                }
            }

            function updateButtonStates() {
                document.querySelectorAll('.btn').forEach(btn => {
                    btn.classList.remove('active');
                });

                if (gameState.placementMode) {
                    const activeButton = document.querySelector(`[data-mode="${gameState.placementMode}"]`);
                    if (activeButton) {
                        activeButton.classList.add('active');
                    }
                }

                document.querySelectorAll('.btn[data-cost]').forEach(btn => {
                    try {
                        const cost = JSON.parse(btn.dataset.cost);
                        if (gameState.canAfford(cost)) {
                            btn.classList.remove('disabled');
                        } else {
                            btn.classList.add('disabled');
                        }

                        const mode = btn.dataset.mode;
                        if (mode && isBuildingRestricted(mode)) {
                            btn.classList.add('disabled');
                            if (!btn.dataset.originalTitle) {
                                btn.dataset.originalTitle = btn.title || '';
                                btn.title = 'Research required: ' + getResearchRequirementName(mode);
                            }
                        } else if (btn.dataset.originalTitle !== undefined) {
                            btn.title = btn.dataset.originalTitle;
                            delete btn.dataset.originalTitle;
                        }
                    } catch (e) {
                        console.warn('Error parsing cost for button:', btn, e);
                    }
                });

                // Handle dropdown buttons for research restrictions
                document.querySelectorAll('.dropdown-btn').forEach(btn => {
                    const mode = btn.dataset.mode;
                    if (mode && isBuildingRestricted(mode)) {
                        btn.classList.add('disabled');
                        if (!btn.dataset.originalTitle) {
                            btn.dataset.originalTitle = btn.title || '';
                            btn.title = 'Research required: ' + getResearchRequirementName(mode);
                        }
                    } else {
                        btn.classList.remove('disabled');
                        if (btn.dataset.originalTitle !== undefined) {
                            btn.title = btn.dataset.originalTitle;
                            delete btn.dataset.originalTitle;
                        }
                    }
                });
            }

            function getResearchRequirementName(mode) {
                const buildingRequirements = {
                    'wall-steel': 'Advanced Defense',
                    'wall-spike': 'Spike Traps',
                    'wall-castle': 'Castle Wall',
                    'tech-goldturret': 'Fortified Defense',
                    'tech-turret': 'Basic Turret',
                    'tech-bomb': 'Bomb Tech',
                    'tech-supply': 'Supply Systems',
                    'tech-goldminer': 'Advanced Mining',
                    'tech-oilrig': 'Oil Rig Tech',
                    'tech-coinmaker': 'Premium Mining',
                    'tech-campfire': 'Campfire Tech',
                    'tech-camptower': 'Siege Weapons',
                    'army-tank': 'Elite Units',
                    'army-siegetower': 'Siege Weapons',
                    'army-king': 'Command Units',
                    'army-barrack': 'Barrack Tech',
                    'army-archer': 'Ranged Units',
                    'army-knight': 'Advanced Army'
                };

                if (buildingRequirements[mode]) {
                    return buildingRequirements[mode];
                }

                if (mode === 'wall') {
                    return 'Fortress';
                }
                if (mode === 'army-scout') {
                    return 'None';
                }

                if (mode === 'tech') {
                    return 'None';
                }

                return 'Unknown Research';
            }

            function showNotification(message, x, y, type) {
                // Create notification for main game screen
                let container = document.querySelector('.notification-container');
                if (!container) {
                    container = document.createElement('div');
                    container.className = 'notification-container';
                    document.body.appendChild(container);
                }

                const notification = document.createElement('div');
                notification.className = 'notification';
                notification.textContent = message;

                container.insertBefore(notification, container.firstChild);

                // Also show notification on combat screen if it's active
                const combatScreen = document.getElementById('combat-battle-screen');
                if (combatScreen && combatScreen.classList.contains('active')) {
                    let combatContainer = combatScreen.querySelector('.combat-notification-container');
                    if (!combatContainer) {
                        combatContainer = document.createElement('div');
                        combatContainer.className = 'combat-notification-container';
                        combatContainer.style.position = 'absolute';
                        combatContainer.style.top = '20px';
                        combatContainer.style.right = '20px';
                        combatContainer.style.zIndex = '1000';
                        combatScreen.appendChild(combatContainer);
                    }

                    const combatNotification = document.createElement('div');
                    combatNotification.className = 'notification combat-notification';
                    combatNotification.textContent = message;
                    combatNotification.style.marginBottom = '10px';
                    
                    combatContainer.insertBefore(combatNotification, combatContainer.firstChild);

                    // Remove combat notification after delay
                    setTimeout(() => {
                        combatNotification.style.animation = 'fadeOut 0.3s ease forwards';
                        setTimeout(() => {
                            if (combatNotification.parentNode) {
                                combatNotification.parentNode.removeChild(combatNotification);
                            }
                        }, 300);
                    }, 3000);
                }

                // Remove main notification after delay
                setTimeout(() => {
                    notification.style.animation = 'fadeOut 0.3s ease forwards';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }

            function createParticleEffect(x, y, color, count = 15) {
                const effectContainer = document.createElement('div');
                effectContainer.className = 'particle-effect';
                effectContainer.style.left = x + 'px';
                effectContainer.style.top = y + 'px';
                document.body.appendChild(effectContainer);

                for (let i = 0; i < count; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.backgroundColor = color;
                    effectContainer.appendChild(particle);

                    const angle = Math.random() * Math.PI * 2;
                    const speed = 1 + Math.random() * 3;
                    const vx = Math.cos(angle) * speed;
                    const vy = Math.sin(angle) * speed;

                    const size = 2 + Math.random() * 4;
                    particle.style.width = size + 'px';
                    particle.style.height = size + 'px';

                    let posX = 0;
                    let posY = 0;
                    let opacity = 1;
                    particle.style.opacity = opacity;

                    const animate = () => {
                        posX += vx;
                        posY += vy;
                        opacity -= 0.02;

                        if (opacity <= 0) {
                            particle.remove();
                            return;
                        }

                        particle.style.transform = `translate(${posX}px, ${posY}px)`;
                        particle.style.opacity = opacity;

                        requestAnimationFrame(animate);
                    };

                    animate();
                }

                setTimeout(() => {
                    if (effectContainer.parentNode) {
                        effectContainer.parentNode.removeChild(effectContainer);
                    }
                }, 1000);
            }

            function createPlacementEffect(x, y) {
                const cell = document.querySelector(`[data-x="${x}"][data-y="${y}"]`);
                if (cell) {
                    const rect = cell.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    createParticleEffect(centerX, centerY, '#66d9ff', 20);
                }
            }

            function createEnemyDefeatEffect(x, y) {
                const cell = document.querySelector(`[data-x="${x}"][data-y="${y}"]`);
                if (cell) {
                    const rect = cell.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    createParticleEffect(centerX, centerY, '#ff5555', 25);
                }
            }

            let lastResourceEffectTime = 0;
            const RESOURCE_EFFECT_COOLDOWN = 2000;

            function createResourceCollectionEffect(x, y, resourceType) {
                const now = Date.now();
                if (now - lastResourceEffectTime < RESOURCE_EFFECT_COOLDOWN) {
                    return;
                }
                lastResourceEffectTime = now;

                const cell = document.querySelector(`[data-x="${x}"][data-y="${y}"]`);
                if (cell) {
                    const rect = cell.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;

                    let color;
                    switch (resourceType) {
                        case 'Steel': color = '#aaaaaa'; break;
                        case 'coins': color = '#d4af37'; break;
                        case 'gold': color = '#ffcc00'; break;
                        default: color = '#66d9ff';
                    }

                    createParticleEffect(centerX, centerY, color, 5);
                }
            }

            const BUTTONS = [
                { id: 'place-wall', mode: 'wall', cost: { Steel: 10 } },
                { id: 'place-steel-wall', mode: 'wall-steel', cost: { Steel: 20 } },
                { id: 'place-spike', mode: 'wall-spike', cost: { Steel: 15 } },
                { id: 'place-castle-wall', mode: 'wall-castle', cost: { gold: 25 } },
                { id: 'place-tech', mode: 'tech', cost: { Steel: 20 } },
                { id: 'place-gold-miner', mode: 'tech-goldminer', cost: { Steel: 25 } },
                { id: 'place-coin-maker', mode: 'tech-coinmaker', cost: { Steel: 30 } },
                { id: 'place-oil-rig', mode: 'tech-oilrig', cost: { Steel: 35 } },
                { id: 'place-turret', mode: 'tech-turret', cost: { Steel: 40 } },
                { id: 'place-gold-turret', mode: 'tech-goldturret', cost: { gold: 200 } },
                { id: 'place-bomb', mode: 'tech-bomb', cost: { gold: 10 } },
                { id: 'place-supply', mode: 'tech-supply', cost: { gold: 35 } },
                { id: 'place-campfire', mode: 'tech-campfire', cost: { Steel: 30 } },
                { id: 'place-scout', mode: 'army-scout', cost: { coins: 15 } },
                { id: 'place-knight', mode: 'army-knight', cost: { coins: 25 } },
                { id: 'place-archer', mode: 'army-archer', cost: { coins: 20 } },
                { id: 'place-tank', mode: 'army-tank', cost: { coins: 50 } },
                { id: 'place-siege-tower', mode: 'army-siegetower', cost: { coins: 275 } },
                { id: 'place-camp-tower', mode: 'tech-camptower', cost: { iron: 70, coins: 80 } },
                { id: 'place-king', mode: 'army-king', cost: { gold: 500 } },
                { id: 'place-barrack', mode: 'army-barrack', cost: { gold: 50 } },
                { id: 'place-warpgate', mode: 'tech-warpgate', cost: { Steel: 150, gold: 100, oil: 75 } }
            ];

            function setupExtractionEventListeners() {
                document.querySelectorAll('.zone-enter-btn').forEach(button => {
                    const clone = button.cloneNode(true);
                    button.parentNode.replaceChild(clone, button);

                    clone.addEventListener('click', function (e) {
                        e.stopPropagation();
                        const zoneType = clone.dataset.zone;
                        if (zoneType) {
                            openResourceSelection(zoneType);
                        }
                    });
                });

                const extractBtn = document.getElementById('extract-btn');
                if (extractBtn) {
                    const clone = extractBtn.cloneNode(true);
                    extractBtn.parentNode.replaceChild(clone, extractBtn);

                    clone.addEventListener('click', function (e) {
                        e.stopPropagation();
                        console.log('Extract button clicked!');
                        console.log('Button disabled:', clone.disabled);
                        if (!clone.disabled) {
                            console.log('Calling gameState.extractResources()');
                            gameState.extractResources();
                            console.log('Extract process complete');
                        } else {
                            console.log('Extract button is disabled');
                        }
                    });
                }

                const continueDeeperBtn = document.getElementById('continue-deeper-btn');
                if (continueDeeperBtn) {
                    const clone = continueDeeperBtn.cloneNode(true);
                    continueDeeperBtn.parentNode.replaceChild(clone, continueDeeperBtn);

                    clone.addEventListener('click', function (e) {
                        e.stopPropagation();
                        gameState.increaseThreat();
                        showNotification('Venturing deeper...', 12, 7, 'warning');
                    });
                }

                const viewBaseBtn = document.getElementById('view-base-btn');
                if (viewBaseBtn) {
                    const clone = viewBaseBtn.cloneNode(true);
                    viewBaseBtn.parentNode.replaceChild(clone, viewBaseBtn);

                    clone.addEventListener('click', function (e) {
                        e.stopPropagation();
                        gameState.gameMode = 'active_zone';
                        gameState.currentZone = 'base';
                        gameState.resources = { ...gameState.storedResources };
                        updateDisplay();
                        hideHomescreen();
                    });
                }

                const saveBtn = document.getElementById('save-game-btn');
                if (saveBtn) {
                    const clone = saveBtn.cloneNode(true);
                    saveBtn.parentNode.replaceChild(clone, saveBtn);

                    clone.addEventListener('click', function (e) {
                        e.stopPropagation();
                        saveGame();
                    });
                }

                const loadBtn = document.getElementById('load-game-btn');
                if (loadBtn) {
                    const clone = loadBtn.cloneNode(true);
                    loadBtn.parentNode.replaceChild(clone, loadBtn);

                    clone.addEventListener('click', function (e) {
                        e.stopPropagation();
                        loadGame();
                    });
                }

                const researchBtn = document.getElementById('research-btn');
                if (researchBtn) {
                    const clone = researchBtn.cloneNode(true);
                    researchBtn.parentNode.replaceChild(clone, researchBtn);

                    clone.addEventListener('click', function (e) {
                        e.stopPropagation();
                        openResearchTree();
                    });
                }

                const researchNavBtn = document.getElementById('research-nav-btn');
                if (researchNavBtn) {
                    const clone = researchNavBtn.cloneNode(true);
                    researchNavBtn.parentNode.replaceChild(clone, researchNavBtn);

                    clone.addEventListener('click', function (e) {
                        e.stopPropagation();
                        openResearchTree();
                    });
                }

                setupBuildingSelection();
            }

            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape' && gameState.placementMode) {
                    e.preventDefault();
                    e.stopPropagation();

                    gameState.placementMode = null;
                    hidePlacementPreview();
                    updateDisplay();

                    showNotification('Placement mode cleared', 12, 7, 'info');
                }
            });

            let mouseX = 0;
            let mouseY = 0;

            let selectionTooltip = null;

            document.addEventListener('mousemove', function (e) {
                mouseX = e.clientX;
                mouseY = e.clientY;
                updateTooltipPosition();
            });

            function createSelectionTooltip() {
                if (selectionTooltip) {
                    document.body.removeChild(selectionTooltip);
                }

                selectionTooltip = document.createElement('div');
                selectionTooltip.className = 'selection-tooltip';
                selectionTooltip.style.display = 'none';

                document.body.appendChild(selectionTooltip);
                return selectionTooltip;
            }

            function updateTooltipPosition() {
                if (selectionTooltip && selectionTooltip.style.display !== 'none') {
                    let left = mouseX + 15;
                    let top = mouseY + 15;

                    const tooltipWidth = selectionTooltip.offsetWidth || 200;
                    const tooltipHeight = selectionTooltip.offsetHeight || 80;

                    if (left + tooltipWidth > window.innerWidth) {
                        left = mouseX - tooltipWidth - 15;
                    }

                    if (top + tooltipHeight > window.innerHeight) {
                        top = mouseY - tooltipHeight - 15;
                    }

                    left = Math.max(10, Math.min(left, window.innerWidth - tooltipWidth - 10));
                    top = Math.max(10, Math.min(top, window.innerHeight - tooltipHeight - 10));

                    selectionTooltip.style.left = left + 'px';
                    selectionTooltip.style.top = top + 'px';
                }
            }

            function showSelectionTooltip(mode, name) {
                const tooltip = createSelectionTooltip();

                const buttonInfo = BUTTONS.find(btn => btn.mode === mode);
                const cost = buttonInfo ? buttonInfo.cost : {};

                let iconSrc = './sprites/' + getIconForMode(mode);

                let costHtml = '';
                for (const [resource, amount] of Object.entries(cost)) {
                    const resourceIcon = getResourceIcon(resource);
                    costHtml += `
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <img src="${resourceIcon}" alt="${resource}">
                        <span>${amount}${getResourceSymbol(resource)}</span>
                    </div>
                `;
                }

                tooltip.innerHTML = `
                <img class="tooltip-icon" src="${iconSrc}" alt="${name}">
                <div class="tooltip-content">
                    <div class="tooltip-name">${name}</div>
                    <div class="tooltip-cost">
                        ${costHtml}
                    </div>
                </div>
            `;

                tooltip.style.display = 'flex';
                updateTooltipPosition();
            }

            function hideSelectionTooltip() {
                if (selectionTooltip) {
                    selectionTooltip.style.display = 'none';
                }
            }

            function getIconForMode(mode) {
                const modeMap = {
                    'wall': 'wall.png',
                    'wall-steel': 'wall_steel.png',
                    'wall-spike': 'wall_spike.png',
                    'wall-castle': 'Castle_wall.png',
                    'tech': 'miner.png',
                    'tech-goldminer': 'goldminer.png',
                    'tech-coinmaker': 'bank.png',
                    'tech-oilrig': 'oilrig.png',
                    'tech-turret': 'turret.png',
                    'tech-goldturret': 'goldturret.png',
                    'tech-bomb': 'bomb.png',
                    'tech-supply': 'supply.png',
                    'tech-campfire': 'campfire.png',
                    'army-scout': 'scout.png',
                    'army-knight': 'knight.png',
                    'army-archer': 'Archer.png',
                    'army-tank': 'Tank.png',
                    'army-siegetower': 'siegetower.png',
                    'army-king': 'king.png',
                    'army-barrack': 'barrack.png'
                };

                return modeMap[mode] || 'research.png';
            }

            function getResourceIcon(resource) {
                const iconMap = {
                    'Steel': './sprites/ironin.png',
                    'coins': './sprites/coin.png',
                    'gold': './sprites/goldin.png'
                };
                return iconMap[resource] || './sprites/research.png';
            }

            function getResourceSymbol(resource) {
                const symbolMap = {
                    'Steel': 'S',
                    'coins': 'C',
                    'gold': 'G'
                };
                return symbolMap[resource] || '?';
            }

            function setupBuildingSelection() {
                document.querySelectorAll('.dropdown-btn').forEach(button => {
                    button.addEventListener('click', function (e) {
                        e.stopPropagation();

                        // Prevent clicking on disabled buttons
                        if (this.classList.contains('disabled')) {
                            const mode = this.dataset.mode;
                            if (mode) {
                                const requirement = getResearchRequirementName(mode);
                                showNotification(`Research required: ${requirement}`, 12, 7, 'warning');
                            }
                            return;
                        }

                        const buildingId = this.id.replace('place-', '');
                        const mode = this.id.replace('place-', '').replace('-', '_');
                        const name = this.querySelector('span:first-child').textContent;

                        clearAllSelections();

                        gameState.placementMode = mode;
                        window.keepFoldersOpen = true;

                        const folderItem = this.closest('.folder-item');
                        const folderTrigger = folderItem.querySelector('.folder-trigger');
                        folderTrigger.classList.add('selected');

                        showSelectionTooltip(mode, name);

                        updateDisplay();
                        showNotification(`Selected ${name}`, 12, 7, 'info');
                    });
                });

                document.querySelectorAll('.folder-trigger').forEach(trigger => {
                    trigger.addEventListener('click', function (e) {
                        e.stopPropagation();

                        if (this.classList.contains('selected')) {
                            clearAllSelections();
                            gameState.placementMode = null;
                            window.keepFoldersOpen = false;
                            hideSelectionTooltip();
                            updateDisplay();
                            showNotification('Selection cleared', 12, 7, 'info');
                        }
                    });
                });
            }

            function clearAllSelections() {
                document.querySelectorAll('.folder-trigger.selected').forEach(trigger => {
                    trigger.classList.remove('selected');
                });

                if (gameState.placementMode && !window.manualPlacementMode) {
                    gameState.placementMode = null;
                }

                hideSelectionTooltip();
                hidePlacementPreview();
            }

            function showHomescreen() {
                const overlay = document.getElementById('homescreen-overlay');
                if (overlay) {
                    overlay.classList.add('active');
                }
                document.body.style.overflow = 'hidden';
                clearAllSelections();
                hideSelectionTooltip();

                console.log('Updating vault display...');
                updateDisplay();

                setTimeout(() => {
                    console.log('Vault update 1...');
                    updateDisplay();
                }, 100);

                setTimeout(() => {
                    console.log('Vault update 2...');
                    updateDisplay();
                }, 300);

                setTimeout(() => {
                    console.log('Vault update 3...');
                    updateDisplay();
                    console.log('Final vault resources:', gameState.storedResources);
                }, 600);
            }

            function hideHomescreen() {
                const overlay = document.getElementById('homescreen-overlay');
                if (overlay) {
                    overlay.classList.remove('active');
                }
                document.body.style.overflow = 'auto';
            }

            function openResearchTree() {
                const popup = document.getElementById('tech-tree-popup');
                const overlay = document.getElementById('tech-tree-overlay');
                if (popup && overlay) {
                    popup.style.display = 'flex';
                    overlay.style.display = 'block';
                    renderTechTree();
                    makeTechTreeDraggable();
                }
            }

            function switchView(viewId) {
                document.querySelectorAll('.screen-view').forEach(view => {
                    view.classList.remove('active');
                });

                const targetView = document.getElementById(viewId);
                if (targetView) {
                    targetView.classList.add('active');
                }
            }

            function updateExtractionUI() {
                const zoneDisplay = document.getElementById('current-zone-display');
                if (zoneDisplay && gameState.currentZone) {
                    const zoneNames = {
                        shallow: 'SHALLOW ZONE',
                        medium: 'MEDIUM ZONE',
                        deep: 'DEEP ZONE',
                        base: 'BASE DEFENSE'
                    };
                    zoneDisplay.textContent = zoneNames[gameState.currentZone] || gameState.currentZone.toUpperCase();
                }

                const threatIndicator = document.getElementById('threat-indicator');
                if (threatIndicator) {
                    const isThreatened = gameState.checkBaseThreat();
                    const threatSpan = threatIndicator.querySelector('.threat-status');

                    if (isThreatened) {
                        threatSpan.textContent = 'THREATENED';
                        threatSpan.className = 'threat-status danger';
                    } else {
                        threatSpan.textContent = 'SECURE';
                        threatSpan.className = 'threat-status safe';
                    }
                }

                const extractBtn = document.getElementById('extract-btn');
                if (extractBtn) {
                    const isThreatened = gameState.checkBaseThreat();
                    if (isThreatened) {
                        extractBtn.disabled = true;
                        extractBtn.title = 'Cannot extract while enemies threaten the base!';
                    } else {
                        extractBtn.disabled = false;
                        extractBtn.title = 'Extract all session resources to storage';
                    }
                }

                const totalStorage = document.getElementById('total-storage');
                if (totalStorage) {
                    const totalValue = (gameState.storedResources.Steel * 1) +
                        (gameState.storedResources.coins * 5) +
                        (gameState.storedResources.gold * 2) +
                        (gameState.storedResources.oil * 20);
                    totalStorage.textContent = totalValue;
                }

                const vaultTotalStorage = document.getElementById('vault-total-storage');
                if (vaultTotalStorage) {
                    const steelValue = gameState.storedResources.Steel * 1;
                    const coinValue = gameState.storedResources.coins * 5;
                    const goldValue = gameState.storedResources.gold * 2;
                    const oilValue = gameState.storedResources.oil * 20;

                    const vaultValue = steelValue + coinValue + goldValue + oilValue;

                    console.log('=== VAULT VALUE CALCULATION ===');
                    console.log('Steel:', gameState.storedResources.Steel, '× 1 =', steelValue);
                    console.log('Coins:', gameState.storedResources.coins, '× 5 =', coinValue);
                    console.log('Gold:', gameState.storedResources.gold, '× 2 =', goldValue);
                    console.log('Oil:', gameState.storedResources.oil, '× 20 =', oilValue);
                    console.log('Total Value:', vaultValue);

                    vaultTotalStorage.textContent = vaultValue;
                    console.log('Vault display updated to:', vaultValue);
                }

                const vaultStoredSteel = document.getElementById('vault-stored-steel-count');
                if (vaultStoredSteel) vaultStoredSteel.textContent = gameState.storedResources.Steel;

                const vaultStoredCoin = document.getElementById('vault-stored-coin-count');
                if (vaultStoredCoin) vaultStoredCoin.textContent = gameState.storedResources.coins;

                const vaultStoredGold = document.getElementById('vault-stored-gold-count');
                if (vaultStoredGold) vaultStoredGold.textContent = gameState.storedResources.gold;

                const vaultStoredOil = document.getElementById('vault-stored-oil-count');
                if (vaultStoredOil) vaultStoredOil.textContent = gameState.storedResources.oil;
            }

            function setupEventListeners() {
                makeFoldersDraggable();

                setupExtractionEventListeners();

                document.querySelectorAll('[data-folder] .folder-title').forEach(function (title) {
                    const clone = title.cloneNode(true);
                    title.parentNode.replaceChild(clone, title);

                    clone.addEventListener('click', function (e) {
                        e.stopPropagation();
                        const folder = clone.closest('.folder');
                        folder.classList.toggle('open');

                        if (folder.classList.contains('open')) {
                            const rect = clone.getBoundingClientRect();
                            const folderContent = folder.querySelector('.folder-content');
                            if (folderContent) {
                                folderContent.style.left = rect.left + 'px';
                                folderContent.style.top = (rect.bottom + 5) + 'px';
                            }
                        } else {
                            const folderContent = folder.querySelector('.folder-content');
                            if (folderContent) {
                                folderContent.style.left = '';
                                folderContent.style.top = '';
                            }
                        }
                    });
                });

                const techTreeButton = document.getElementById('tech-tree-button');
                if (techTreeButton) {
                    const clone = techTreeButton.cloneNode(true);
                    techTreeButton.parentNode.replaceChild(clone, techTreeButton);

                    clone.addEventListener('click', function (e) {
                        e.stopPropagation();
                        console.log('Tech tree button clicked');
                        const popup = document.getElementById('tech-tree-popup');
                        const overlay = document.getElementById('tech-tree-overlay');
                        if (popup && overlay) {
                            popup.style.display = 'flex';
                            overlay.style.display = 'block';
                            renderTechTree();
                            makeTechTreeDraggable();
                            console.log('Tech tree popup opened');
                        } else {
                            console.error('Tech tree popup or overlay not found');
                        }
                    }, true);
                }

                const openResearchTreeButton = document.getElementById('open-research-tree');
                if (openResearchTreeButton) {
                    const clone = openResearchTreeButton.cloneNode(true);
                    openResearchTreeButton.parentNode.replaceChild(clone, openResearchTreeButton);

                    clone.addEventListener('click', function (e) {
                        e.stopPropagation();
                        console.log('Open research tree button clicked');
                        const popup = document.getElementById('tech-tree-popup');
                        const overlay = document.getElementById('tech-tree-overlay');
                        if (popup && overlay) {
                            popup.style.display = 'flex';
                            overlay.style.display = 'block';
                            renderTechTree();
                            makeTechTreeDraggable();
                            console.log('Tech tree popup opened from research folder');
                        } else {
                            console.error('Tech tree popup or overlay not found');
                        }
                    });
                }

                const techTreeClose = document.getElementById('tech-tree-close');
                if (techTreeClose) {
                    const clone = techTreeClose.cloneNode(true);
                    techTreeClose.parentNode.replaceChild(clone, techTreeClose);

                    clone.addEventListener('click', function () {
                        const popup = document.getElementById('tech-tree-popup');
                        const overlay = document.getElementById('tech-tree-overlay');
                        if (popup) popup.style.display = 'none';
                        if (overlay) overlay.style.display = 'none';
                    });
                }

                const techTreeOverlay = document.getElementById('tech-tree-overlay');
                if (techTreeOverlay) {
                    const clone = techTreeOverlay.cloneNode(true);
                    techTreeOverlay.parentNode.replaceChild(clone, techTreeOverlay);

                    clone.addEventListener('click', function () {
                        const popup = document.getElementById('tech-tree-popup');
                        const overlay = document.getElementById('tech-tree-overlay');
                        if (popup) popup.style.display = 'none';
                        if (overlay) overlay.style.display = 'none';
                    });
                }

                document.querySelectorAll('.folder-close').forEach(function (button) {
                    const clone = button.cloneNode(true);
                    button.parentNode.replaceChild(clone, button);

                    clone.addEventListener('click', function (e) {
                        e.stopPropagation();
                        const folder = clone.closest('.folder');
                        folder.classList.remove('open');
                    });
                });

                document.querySelectorAll('.info-icon').forEach(function (icon) {
                    const clone = icon.cloneNode(true);
                    icon.parentNode.replaceChild(clone, icon);

                    clone.addEventListener('click', function (e) {
                        e.stopPropagation();
                        showInfoPopup(clone.closest('.btn'));
                    });
                });

                BUTTONS.forEach(function (buttonData) {
                    const button = document.getElementById(buttonData.id);
                    if (button) {
                        const clone = button.cloneNode(true);
                        button.parentNode.replaceChild(clone, button);

                        clone.dataset.mode = buttonData.mode;
                        clone.dataset.cost = JSON.stringify(buttonData.cost);
                        clone.addEventListener('click', function (e) {
                            e.stopPropagation();
                            if (isBuildingRestricted(buttonData.mode)) {
                                showNotification('You need to research the required technology first!', CONFIG.PLAYER_START.x, CONFIG.PLAYER_START.y, 'warning');
                                return;
                            }
                            gameState.placementMode = gameState.placementMode === buttonData.mode ? null : buttonData.mode;

                            if (gameState.placementMode === buttonData.mode) {
                                window.keepFoldersOpen = true;
                                console.log('Setting keepFoldersOpen = true for mode:', buttonData.mode);
                            } else {
                                window.keepFoldersOpen = false;
                                console.log('Setting keepFoldersOpen = false');
                            }

                            updateButtonStates();
                            updateDisplay();
                        });
                    }
                });

                const saveGameButton = document.getElementById('save-game');
                if (saveGameButton) {
                    const clone = saveGameButton.cloneNode(true);
                    saveGameButton.parentNode.replaceChild(clone, saveGameButton);
                    clone.addEventListener('click', saveGame);
                }

                const loadGameButton = document.getElementById('load-game');
                if (loadGameButton) {
                    const clone = loadGameButton.cloneNode(true);
                    loadGameButton.parentNode.replaceChild(clone, loadGameButton);
                    clone.addEventListener('click', function () {
                        const fileInput = document.getElementById('load-file');
                        if (fileInput) fileInput.click();
                    });
                }

                const restartGameButton = document.getElementById('restart-game');
                if (restartGameButton) {
                    const clone = restartGameButton.cloneNode(true);
                    restartGameButton.parentNode.replaceChild(clone, restartGameButton);
                    clone.addEventListener('click', restartGame);
                }


                document.addEventListener('click', function (e) {
                    console.log('Global click handler - keepFoldersOpen:', window.keepFoldersOpen);
                    console.log('Clicked target:', e.target);
                    console.log('Is folder target:', !!e.target.closest('[data-folder]'));

                    if (!window.keepFoldersOpen && !e.target.closest('[data-folder]')) {
                        console.log('Closing folders');
                        document.querySelectorAll('.folder.open').forEach(folder => {
                            folder.classList.remove('open');
                        });
                    } else {
                        console.log('NOT closing folders - keepFoldersOpen:', window.keepFoldersOpen, 'isFolderTarget:', !!e.target.closest('[data-folder]'));
                    }

                    if (!e.target.closest('.info-popup') && !e.target.closest('.info-icon')) {
                        closeInfoPopup();
                    }
                });

                if (!document.getElementById('load-file')) {
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.id = 'load-file';
                    fileInput.accept = '.coregrid';
                    fileInput.style.display = 'none';
                    fileInput.addEventListener('change', function (e) {
                        if (e.target.files.length > 0) {
                            loadGame(e.target.files[0]);
                        }
                    });
                    document.body.appendChild(fileInput);
                }

                const buildingInfoClose = document.getElementById('building-info-close');
                if (buildingInfoClose) {
                    const clone = buildingInfoClose.cloneNode(true);
                    buildingInfoClose.parentNode.replaceChild(clone, buildingInfoClose);

                    clone.addEventListener('click', function () {
                        closeBuildingInfo();
                    });
                }

                const buildingInfoOverlay = document.getElementById('building-info-overlay');
                if (buildingInfoOverlay) {
                    const clone = buildingInfoOverlay.cloneNode(true);
                    buildingInfoOverlay.parentNode.replaceChild(clone, buildingInfoOverlay);

                    clone.addEventListener('click', function () {
                        closeBuildingInfo();
                    });
                }

                const teleportArmyBtn = document.getElementById('teleport-army-btn');
                if (teleportArmyBtn) {
                    const clone = teleportArmyBtn.cloneNode(true);
                    teleportArmyBtn.parentNode.replaceChild(clone, teleportArmyBtn);

                    clone.addEventListener('click', function (e) {
                        e.stopPropagation();
                        teleportArmyHome();
                    });
                }

                const sendArmyBtn = document.getElementById('send-army-btn');
                if (sendArmyBtn) {
                    const clone = sendArmyBtn.cloneNode(true);
                    sendArmyBtn.parentNode.replaceChild(clone, sendArmyBtn);

                    clone.addEventListener('click', function (e) {
                        e.stopPropagation();
                        sendSelectedArmy();
                    });
                }


                const playGameBtn = document.getElementById('play-game-btn');
                if (playGameBtn) {
                    const clone = playGameBtn.cloneNode(true);
                    playGameBtn.parentNode.replaceChild(clone, playGameBtn);

                    clone.addEventListener('click', function (e) {
                        e.stopPropagation();
                        const popup = document.getElementById('zone-selection-popup');
                        if (popup) {
                            popup.classList.add('active');
                        }
                    });
                }

                const loadGameBtn = document.getElementById('load-game-btn');
                if (loadGameBtn) {
                    const clone = loadGameBtn.cloneNode(true);
                    loadGameBtn.parentNode.replaceChild(clone, loadGameBtn);

                    clone.addEventListener('click', function (e) {
                        e.stopPropagation();
                        const fileInput = document.getElementById('load-file');
                        if (fileInput) fileInput.click();
                    });
                }

                const saveGameBtn = document.getElementById('save-game-btn');
                if (saveGameBtn) {
                    const clone = saveGameBtn.cloneNode(true);
                    saveGameBtn.parentNode.replaceChild(clone, saveGameBtn);

                    clone.addEventListener('click', function (e) {
                        e.stopPropagation();
                        saveGame();
                    });
                }

                const deathReturnBtn = document.getElementById('death-return-btn');
                if (deathReturnBtn) {
                    const clone = deathReturnBtn.cloneNode(true);
                    deathReturnBtn.parentNode.replaceChild(clone, deathReturnBtn);

                    clone.addEventListener('click', function (e) {
                        e.stopPropagation();
                        hideDeathScreen();
                        gameState.returnToHomescreen();
                        showHomescreen();
                        showNotification('Returned to base. Better luck next time!', 12, 7, 'warning');
                    });
                }

                const deathRetryBtn = document.getElementById('death-retry-btn');
                if (deathRetryBtn) {
                    const clone = deathRetryBtn.cloneNode(true);
                    deathRetryBtn.parentNode.replaceChild(clone, deathRetryBtn);

                    clone.addEventListener('click', function (e) {
                        e.stopPropagation();
                        hideDeathScreen();
                        gameState.enterZone(gameState.currentZone);
                        showNotification(`Retrying ${gameState.currentZone.toUpperCase()} mission...`, 12, 7, 'info');
                    });
                }
                const discordBtn = document.getElementById('discord-btn');
                if (discordBtn) {
                    const clone = discordBtn.cloneNode(true);
                    discordBtn.parentNode.replaceChild(clone, discordBtn);

                    clone.addEventListener('click', function (e) {
                        e.stopPropagation();
                        window.open('https://discord.gg/74c9RBYD4R', '_blank');
                    });
                }

                const wikiBtn = document.getElementById('open-wiki-btn');
                if (wikiBtn) {
                    const clone = wikiBtn.cloneNode(true);
                    wikiBtn.parentNode.replaceChild(clone, wikiBtn);

                    clone.addEventListener('click', function (e) {
                        e.stopPropagation();
                        openWikiModal();
                    });
                }

                const attackGameBtn = document.getElementById('attack-game-btn');
                if (attackGameBtn) {
                    const clone = attackGameBtn.cloneNode(true);
                    attackGameBtn.parentNode.replaceChild(clone, attackGameBtn);

                    clone.addEventListener('click', function (e) {
                        e.stopPropagation();
                        openCombatMenu();
                    });
                }

                const cratesGameBtn = document.getElementById('crates-game-btn');
                if (cratesGameBtn) {
                    const clone = cratesGameBtn.cloneNode(true);
                    cratesGameBtn.parentNode.replaceChild(clone, cratesGameBtn);

                    clone.addEventListener('click', function (e) {
                        e.stopPropagation();
                        openCratesModal();
                    });
                }

                initializeWiki();
            }

            function isBuildingRestricted(mode) {
                const buildingRequirements = {
                    'wall-steel': 'advanced_defense',
                    'wall-spike': 'spike_traps',
                    'wall-castle': 'castle_wall',

                    'tech-goldturret': 'fortified_defense',
                    'tech-turret': 'basic_turret',
                    'tech-bomb': 'bomb_tech',
                    'tech-supply': 'supply_systems',
                    'tech-campfire': 'campfire_tech',
                    'tech-warpgate': 'warpgate_tech',
                    'tech-goldminer': 'advanced_mining',
                    'tech-oilrig': 'oil_rig_tech',
                    'tech-coinmaker': 'premium_mining',

                    'army-tank': 'elite_units',
                    'army-siegetower': 'siege_weapons',
                    'army-king': 'command_units',
                    'army-barrack': 'barrack_tech',
                    'army-archer': 'ranged_units',
                    'army-knight': 'advanced_army'
                };

                const requiredTech = buildingRequirements[mode];
                if (requiredTech) {
                    return !gameState.isTechResearched(requiredTech);
                }
                if (mode === 'wall') {
                    return !gameState.isTechResearched('fortress');
                }
                if (mode === 'army-scout') {
                    return false;
                }
                if (mode === 'tech') {
                    return false;
                }
                return false;
            }

            function getResearchRequirementName(mode) {
                const buildingRequirements = {
                    'wall-steel': 'Advanced Defense',
                    'wall-spike': 'Spike Traps',
                    'wall-castle': 'Castle Wall',
                    'tech-goldturret': 'Fortified Defense',
                    'tech-turret': 'Basic Turret',
                    'tech-bomb': 'Bomb Tech',
                    'tech-supply': 'Supply Systems',
                    'tech-goldminer': 'Advanced Mining',
                    'tech-coinmaker': 'Premium Mining',
                    'tech-campfire': 'Campfire Tech',
                    'tech-warpgate': 'Warpgate Technology',
                    'army-tank': 'Elite Units',
                    'army-siegetower': 'Siege Weapons',
                    'army-king': 'Command Units',
                    'army-barrack': 'Barrack Tech',
                    'army-archer': 'Ranged Units',
                    'army-knight': 'Advanced Army'
                };

                if (buildingRequirements[mode]) {
                    return buildingRequirements[mode];
                }

                if (mode === 'wall') {
                    return 'Fortress';
                }
                if (mode === 'army-scout') {
                    return 'None';
                }

                if (mode === 'tech') {
                    return 'None';
                }

                return 'Unknown Research';
            }

            function debugResearch() {
                console.log('=== DEBUG RESEARCH INFO ===');
                console.log('Researched techs:', Array.from(gameState.researchedTechs));
                console.log('Available techs:', Array.from(gameState.availableTechs));
                console.log('Tech tree loaded:', Object.keys(CONFIG.TECH_TREE).length > 0);
                console.log('Current resources:', gameState.resources);

                const testTechs = ['fortress', 'module_research', 'basic_defense'];
                testTechs.forEach(techId => {
                    const canResearch = gameState.canResearchTech(techId);
                    const isResearched = gameState.isTechResearched(techId);
                    console.log(`${techId}: canResearch=${canResearch}, isResearched=${isResearched}`);
                });
            }


            function renderTechTree() {
                const techTreeContent = document.getElementById('tech-tree-content');
                const techTreeMain = document.getElementById('tech-tree-main');
                const techInfoPanel = document.getElementById('tech-info-panel');

                if (!techTreeContent || !techTreeMain) {
                    console.error('Tech tree elements not found');
                    return;
                }

                techTreeMain.innerHTML = '';

                if (!CONFIG.TECH_TREE || Object.keys(CONFIG.TECH_TREE).length === 0) {
                    techTreeMain.innerHTML = `
                    <div style="text-align: center; padding: 50px;">
                        <h3>Tech Tree Not Loaded</h3>
                        <p>Unable to load tech tree data. Please check the console for errors.</p>
                        <button onclick="loadTechTree().then(() => renderTechTree())" 
                                style="padding: 10px 20px; margin-top: 20px;">
                            Reload Tech Tree
                        </button>
                    </div>
                `;
                    return;
                }

                for (const techId in CONFIG.TECH_TREE) {
                    const tech = CONFIG.TECH_TREE[techId];
                    const fromPos = NODE_POSITIONS[techId];

                    if (fromPos && tech.prerequisites) {
                        tech.prerequisites.forEach(prereqId => {
                            const toPos = NODE_POSITIONS[prereqId];
                            if (toPos) {
                                const isResearched = gameState.isTechResearched(techId) && gameState.isTechResearched(prereqId);
                                const isLocked = !gameState.isTechResearched(techId) && !gameState.isTechResearched(prereqId) &&
                                    !gameState.availableTechs.has(techId) && !gameState.availableTechs.has(prereqId);
                                createConnectionLine(techTreeMain, fromPos, toPos, isResearched, isLocked);
                            }
                        });
                    }
                }

                for (const techId in CONFIG.TECH_TREE) {
                    const tech = CONFIG.TECH_TREE[techId];
                    const pos = NODE_POSITIONS[techId];

                    if (pos) {
                        createTechNode(techTreeMain, techId, tech, pos);
                    } else {
                        console.warn(`No position found for tech: ${techId}`);
                    }
                }
            }

            function createConnectionLine(container, fromPos, toPos, isResearched, isLocked) {
                const line = document.createElement('div');
                line.className = 'tech-connection';
                if (isResearched) {
                    line.classList.add('researched');
                } else if (isLocked) {
                    line.classList.add('locked');
                }

                const dx = toPos.x - fromPos.x;
                const dy = toPos.y - fromPos.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                const angle = Math.atan2(dy, dx) * 180 / Math.PI;

                line.style.width = distance + 'px';
                line.style.height = '4px';
                line.style.left = (fromPos.x + 45) + 'px';
                line.style.top = (fromPos.y + 45) + 'px';
                line.style.transform = `rotate(${angle}deg)`;
                line.style.transformOrigin = '0 0';
                line.style.transition = 'all 0.3s ease';

                container.appendChild(line);
            }

            function updateTechInfoPanel(techId, tech) {
                const infoPanel = document.getElementById('tech-info-panel');
                if (!infoPanel) return;

                let state = 'locked';
                let stateText = 'LOCKED';
                if (gameState.isTechResearched(techId)) {
                    state = 'researched';
                    stateText = 'RESEARCHED';
                } else if (gameState.availableTechs.has(techId)) {
                    state = 'available';
                    stateText = 'AVAILABLE';
                }

                let costHtml = '';
                if (tech.cost) {
                    const costs = [];
                    if (tech.cost.Steel) costs.push(`<span class="tech-cost-item tech-cost-steel">${tech.cost.Steel} STEEL</span>`);
                    if (tech.cost.coins) costs.push(`<span class="tech-cost-item tech-cost-coins">${tech.cost.coins} COINS</span>`);
                    if (tech.cost.gold) costs.push(`<span class="tech-cost-item tech-cost-gold">${tech.cost.gold} GOLD</span>`);
                    if (tech.cost.oil) costs.push(`<span class="tech-cost-item tech-cost-oil">${tech.cost.oil} OIL</span>`);
                    costHtml = costs.join('');
                }

                infoPanel.innerHTML = `
                <div class="tech-info-title">${tech.name}</div>
                <div class="tech-info-description">${tech.description}</div>
                <div class="tech-info-cost">${costHtml}</div>
                <div class="tech-info-status" style="margin-top: 10px; font-weight: bold; color: ${state === 'researched' ? '#7a977b' : state === 'available' ? '#66d9ff' : '#888'}">
                    ${stateText}
                </div>
            `;

                infoPanel.classList.remove('hidden');
            }

            function resetTechInfoPanel() {
                const infoPanel = document.getElementById('tech-info-panel');
                if (!infoPanel) return;

                infoPanel.innerHTML = '<div class="tech-info-default">Hover over a technology to see details</div>';
                infoPanel.classList.add('hidden');
            }

            function createTechNode(container, techId, tech, pos) {
                const nodeDiv = document.createElement('div');
                nodeDiv.className = 'tech-node';
                nodeDiv.dataset.techId = techId;
                nodeDiv.style.left = pos.x + 'px';
                nodeDiv.style.top = pos.y + 'px';

                if (gameState.isTechResearched(techId)) {
                    nodeDiv.classList.add('researched');
                } else if (gameState.availableTechs.has(techId)) {
                    nodeDiv.classList.add('available');
                } else {
                    nodeDiv.classList.add('locked');
                }

                const iconDiv = document.createElement('div');
                iconDiv.className = 'tech-node-icon';

                const img = document.createElement('img');
                const iconPath = `./sprites/${tech.icon || 'research.png'}`;
                img.src = iconPath;
                img.alt = tech.name;
                img.onerror = function () {
                    this.src = './sprites/research.png';
                };
                iconDiv.appendChild(img);
                nodeDiv.appendChild(iconDiv);

                if (!gameState.isTechResearched(techId) && gameState.availableTechs.has(techId)) {
                    nodeDiv.style.cursor = 'pointer';
                    nodeDiv.addEventListener('click', function () {
                        console.log(`Attempting to research: ${techId}`);
                        if (gameState.researchTech(techId)) {
                            showNotification(`${tech.name} researched!`, CONFIG.PLAYER_START.x, CONFIG.PLAYER_START.y, 'success');
                            renderTechTree();
                            updateButtonStates();
                            updateDisplay();
                        } else {
                            showNotification(`Cannot research ${tech.name}. Check requirements.`,
                                CONFIG.PLAYER_START.x, CONFIG.PLAYER_START.y, 'warning');
                        }
                    });
                }

                nodeDiv.addEventListener('mouseenter', function () {
                    updateTechInfoPanel(techId, tech);
                });

                nodeDiv.addEventListener('mouseleave', function () {
                    resetTechInfoPanel();
                });

                nodeDiv.title = `${tech.name}\n${tech.description}`;

                container.appendChild(nodeDiv);
                return nodeDiv;
            }

            function makeTechTreeDraggable() {
                const popup = document.getElementById('tech-tree-popup');
                const header = document.querySelector('.tech-tree-header');

                if (!popup || !header) return;

                let isDragging = false;
                let currentX;
                let currentY;
                let initialX;
                let initialY;
                let xOffset = 0;
                let yOffset = 0;

                header.addEventListener('mousedown', dragStart);
                document.addEventListener('mouseup', dragEnd);
                document.addEventListener('mousemove', drag);

                function dragStart(e) {
                    initialX = e.clientX - xOffset;
                    initialY = e.clientY - yOffset;

                    isDragging = true;
                    header.style.cursor = 'grabbing';
                }

                function dragEnd() {
                    initialX = currentX;
                    initialY = currentY;

                    isDragging = false;
                    header.style.cursor = 'move';
                }

                function drag(e) {
                    if (isDragging) {
                        e.preventDefault();
                        currentX = e.clientX - initialX;
                        currentY = e.clientY - initialY;

                        xOffset = currentX;
                        yOffset = currentY;

                        popup.style.transform = `translate(${currentX}px, ${currentY}px)`;
                    }
                }
            }

            function showInfoPopup(button) {
                const infoData = button.dataset.info.split(',');
                const title = infoData[0];
                const description = infoData[1];
                const stats = infoData.slice(2);

                let overlay = document.querySelector('.info-popup-overlay');
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.className = 'info-popup-overlay';
                    document.body.appendChild(overlay);
                }

                let popup = document.querySelector('.info-popup');
                if (!popup) {
                    popup = document.createElement('div');
                    popup.className = 'info-popup';
                    document.body.appendChild(popup);
                }

                let statsHtml = '';
                stats.forEach(function (stat) {
                    statsHtml += '<div class="info-popup-stat">' + stat + '</div>';
                });

                popup.innerHTML = `
                <div class="info-popup-header">
                    <div class="info-popup-title">${title}</div>
                    <button class="info-popup-close">×</button>
                </div>
                <div class="info-popup-content">
                    <p>${description}</p>
                    <div class="info-popup-stats">
                        ${statsHtml}
                    </div>
                </div>
            `;

                popup.querySelector('.info-popup-close').addEventListener('click', closeInfoPopup);

                overlay.style.display = 'block';
                popup.style.display = 'block';
            }

            function closeInfoPopup() {
                const overlay = document.querySelector('.info-popup-overlay');
                const popup = document.querySelector('.info-popup');

                if (overlay) overlay.style.display = 'none';
                if (popup) popup.style.display = 'none';
            }

            function showBuildingInfo(building) {
                if (building.type === 'tech' && building.subtype === 'warpgate') {
                    openArmySelection(building);
                    return;
                }

                const buildingInfoPopup = document.getElementById('building-info-popup');
                const buildingInfoOverlay = document.getElementById('building-info-overlay');
                const buildingSpecialActions = document.getElementById('building-special-actions');
                const teleportArmyBtn = document.getElementById('teleport-army-btn');

                document.getElementById('building-info-title').textContent = getBuildingName(building);

                document.getElementById('building-icon').src = building.getSprite();

                document.getElementById('building-description').textContent = getBuildingDescription(building);

                setupModuleSlots(building);

                // Only show teleport button for warpgate
                if (building.type === 'tech' && building.subtype === 'warpgate') {
                    if (buildingSpecialActions) buildingSpecialActions.style.display = 'flex';
                    if (teleportArmyBtn) teleportArmyBtn.style.display = 'block';
                } else {
                    if (buildingSpecialActions) buildingSpecialActions.style.display = 'none';
                    if (teleportArmyBtn) teleportArmyBtn.style.display = 'none';
                }

                buildingInfoPopup.style.display = 'flex';
                buildingInfoOverlay.style.display = 'block';

                window.currentBuilding = building;
            }

            function canBuildingHaveModules(building) {
                if (building.type === 'wall') {
                    return false;
                }

                return true;
            }

            function hasModuleResearch() {
                return gameState.isTechResearched('module_research') ||
                    (gameState.isTechResearched('speed_module') && gameState.isTechResearched('defense_module'));
            }

            function getBuildingName(building) {
                switch (building.type) {
                    case 'wall':
                        switch (building.subtype) {
                            case 'stone': return 'Wall';
                            case 'steel': return 'Steel Wall';
                            case 'spike': return 'Spike';
                            case 'fortress': return 'Fortress';
                            default: return building.subtype.charAt(0).toUpperCase() + building.subtype.slice(1);
                        }
                    case 'tech':
                        switch (building.subtype) {
                            case 'miner': return 'Steel Mine';
                            case 'goldminer': return 'Gold Mine';
                            case 'coinmaker': return 'Bank';
                            case 'oilrig': return 'Oil Rig';
                            case 'turret': return 'Turret';
                            case 'goldturret': return 'Gold Turret';
                            case 'bomb': return 'Bomb';
                            case 'supply': return 'Supply Drop';
                            case 'campfire': return 'Campfire';
                            case 'camptower': return 'Camp Tower';
                            default: return building.subtype.charAt(0).toUpperCase() + building.subtype.slice(1);
                        }
                    case 'army':
                        switch (building.subtype) {
                            case 'scout': return 'Soldier';
                            case 'knight': return 'Knight';
                            case 'archer': return 'Archer';
                            case 'tank': return 'Tank';
                            case 'siegetower': return 'Siege Tower';
                            case 'king': return 'King';
                            case 'barrack': return 'Barrack';
                            default: return building.subtype.charAt(0).toUpperCase() + building.subtype.slice(1);
                        }
                    default: return building.subtype ? building.subtype.charAt(0).toUpperCase() + building.subtype.slice(1) : 'Building';
                }
            }

            function getBuildingDescription(building) {
                switch (building.type) {
                    case 'wall':
                        switch (building.subtype) {
                            case 'stone': return 'Basic defensive structure to block enemy movement. Health: 1.';
                            case 'steel': return 'Stronger wall with increased durability. Health: 3.';
                            case 'spike': return 'Damages enemies that walk over it. Health: 3.';
                            case 'fortress': return 'Your main base that must be protected. Health: 5.';
                            default: return 'Wall structure.';
                        }
                    case 'tech':
                        switch (building.subtype) {
                            case 'miner': return 'Generates 5 steel per turn. Health: 2.';
                            case 'goldminer': return 'Generates 1 gold per turn. Health: 2.';
                            case 'coinmaker': return 'Generates 5 coins per turn. Health: 2.';
                            case 'oilrig': return 'Generates 1 oil per turn. Health: 2.';
                            case 'turret': return 'Attacks enemies within range 3. Health: 2, Shots: 8.';
                            case 'goldturret': return 'Powerful turret with range 3. Health: 2, Shots: 10.';
                            case 'bomb': return 'Explodes when enemy approaches damaging area. Health: 1.';
                            case 'supply': return 'Randomly generates resources. Health: 1.';
                            case 'campfire': return 'Boosts nearby resource buildings by 50%. Health: 1.';
                            case 'camptower': return 'Turret-like building that shoots enemies in 3x3 area. Health: 2. Takes 14 coins per kill.';
                            default: return 'Technology building.';
                        }
                    case 'army':
                        switch (building.subtype) {
                            case 'scout': return 'Basic unit with balanced stats. Health: 1, Range: 1, Movement: 1.';
                            case 'knight': return 'Fast-moving unit with high mobility. Health: 1, Range: 1, Movement: 5.';
                            case 'archer': return 'Ranged unit that can attack from a distance. Health: 1, Range: 4, Movement: 1.';
                            case 'tank': return 'Heavy unit with high health. Health: 5, Range: 1, Movement: 1.';
                            case 'siegetower': return 'Powerful siege unit with long range. Health: 1, Range: 4, Movement: 1.';
                            case 'king': return 'Command unit that boosts nearby army. Health: 25, Range: 2, Movement: 2.';
                            case 'barrack': return 'Automatically spawns soldier units. Health: 2.';
                            default: return 'Army unit.';
                        }
                    default: return 'Building structure.';
                }
            }

            function setupModuleSlots(building) {
                const moduleSlotsContainer = document.querySelector('.module-slots-container');

                if (!canBuildingHaveModules(building) || !hasModuleResearch()) {
                    if (moduleSlotsContainer) {
                        moduleSlotsContainer.style.display = 'none';

                        // Remove any existing locked messages first
                        const existingMessages = moduleSlotsContainer.parentNode.querySelectorAll('.modules-locked-message');
                        existingMessages.forEach(msg => msg.remove());

                        // Create new locked message
                        const lockedMessage = document.createElement('div');
                        lockedMessage.className = 'modules-locked-message';
                        lockedMessage.innerHTML = '<strong>🔒 Modules Locked</strong><br>Research <em>Module Research</em> in the Tech Tree to unlock modules for this building.';
                        moduleSlotsContainer.parentNode.insertBefore(lockedMessage, moduleSlotsContainer.nextSibling);
                    }
                    return;
                }

                if (moduleSlotsContainer) {
                    moduleSlotsContainer.style.display = 'flex';

                    // Remove any existing locked messages when modules are unlocked
                    const existingMessages = moduleSlotsContainer.parentNode.querySelectorAll('.modules-locked-message');
                    existingMessages.forEach(msg => msg.remove());
                }

                const moduleSlot1 = document.getElementById('module-slot-1');

                const moduleSlot2 = document.getElementById('module-slot-2');

                const newModuleSlot1 = moduleSlot1.cloneNode(true);
                const newModuleSlot2 = moduleSlot2.cloneNode(true);
                moduleSlot1.parentNode.replaceChild(newModuleSlot1, moduleSlot1);
                moduleSlot2.parentNode.replaceChild(newModuleSlot2, moduleSlot2);

                updateModuleSlotDisplay(building, 1);
                updateModuleSlotDisplay(building, 2);

                newModuleSlot1.addEventListener('click', () => showModuleSelectionPopup(building, 1));
                newModuleSlot2.addEventListener('click', () => showModuleSelectionPopup(building, 2));

                setupModuleSelectionPopup(building);
            }

            function updateModuleSlotDisplay(building, slotNumber) {
                const slotElement = document.getElementById(`module-slot-${slotNumber}`);
                const iconElement = slotElement.querySelector('.module-slot-icon');
                const tierElement = slotElement.querySelector('.module-slot-tier');

                slotElement.classList.remove('equipped', 'empty');

                if (building.modules && building.modules.length >= slotNumber && building.modules[slotNumber - 1]) {
                    const module = building.modules[slotNumber - 1];
                    const moduleInfo = module.split('-');
                    const type = moduleInfo[0];
                    const tier = moduleInfo[1] || '1';

                    slotElement.classList.add('equipped');

                    if (type === 'speed') {
                        iconElement.innerHTML = '<img src="./sprites/speedmod.png" alt="Speed Module">';
                    } else if (type === 'defense') {
                        iconElement.innerHTML = '<img src="./sprites/defensemod.png" alt="Defense Module">';
                    }

                    tierElement.textContent = tier;

                    tierElement.style.display = 'flex';
                } else {
                    slotElement.classList.add('empty');
                    iconElement.innerHTML = '';
                    tierElement.style.display = 'none';
                }
            }

            function showModuleSelectionPopup(building, slotNumber) {
                const popup = document.getElementById('module-selection-popup');
                const overlay = document.getElementById('module-selection-overlay');

                window.currentBuilding = building;
                window.currentSlot = slotNumber;

                updateModuleAffordability();

                popup.style.display = 'flex';
                overlay.style.display = 'block';
            }

            function setupModuleSelectionPopup(building) {
                const closeBtn = document.getElementById('module-close-btn');
                const overlay = document.getElementById('module-selection-overlay');

                if (closeBtn) {
                    closeBtn.onclick = closeModuleSelectionPopup;
                }

                if (overlay) {
                    overlay.onclick = closeModuleSelectionPopup;
                }

                const hasSpeedModuleTech = gameState.isTechResearched('speed_module') || gameState.isTechResearched('module_research');
                const hasDefenseModuleTech = gameState.isTechResearched('defense_module') || gameState.isTechResearched('module_research');

                document.querySelectorAll('.module-option').forEach(option => {
                    const moduleType = option.dataset.module;

                    if ((moduleType === 'speed' && !hasSpeedModuleTech) ||
                        (moduleType === 'defense' && !hasDefenseModuleTech)) {
                        option.style.display = 'none';
                    } else {
                        option.style.display = 'flex';
                    }
                });

                document.querySelectorAll('.module-option').forEach(option => {
                    option.onclick = function () {
                        if (this.classList.contains('unaffordable')) {
                            showNotification('Not enough resources!', building.x, building.y, 'warning');
                            return;
                        }

                        const moduleType = this.dataset.module;
                        const moduleTier = this.dataset.tier;

                        if (window.currentBuilding && window.currentSlot) {
                            equipModule(window.currentBuilding, window.currentSlot, moduleType, moduleTier);
                        }

                        closeModuleSelectionPopup();
                    };
                });
            }

            function closeModuleSelectionPopup() {
                const popup = document.getElementById('module-selection-popup');
                const overlay = document.getElementById('module-selection-overlay');

                popup.style.display = 'none';
                overlay.style.display = 'none';

                document.querySelectorAll('.module-option').forEach(option => {
                    option.style.display = 'flex';
                });

                window.currentBuilding = null;
                window.currentSlot = null;
            }

            function updateModuleAffordability() {
                const options = document.querySelectorAll('.module-option');

                options.forEach(option => {
                    if (window.getComputedStyle(option).display === 'none') {
                        return;
                    }

                    const cost = parseInt(option.querySelector('.module-cost').textContent);

                    if (gameState.resources.Steel >= cost) {
                        option.classList.remove('unaffordable');
                    } else {
                        option.classList.add('unaffordable');
                    }
                });
            }

            function updateModuleSelectOptions(selectElement) {
                while (selectElement.children.length > 1) {
                    selectElement.removeChild(selectElement.lastChild);
                }

                if (gameState.isTechResearched('speed_module')) {
                    const speedOption = document.createElement('option');
                    speedOption.value = 'speed';
                    speedOption.textContent = 'Speed Module';
                    selectElement.appendChild(speedOption);
                }

                if (gameState.isTechResearched('defense_module')) {
                    const defenseOption = document.createElement('option');
                    defenseOption.value = 'defense';
                    defenseOption.textContent = 'Defense Module';
                    selectElement.appendChild(defenseOption);
                }
            }

            function equipModule(building, slotNumber, moduleType, moduleTier) {
                let cost;
                if (moduleType === 'speed') {
                    switch (moduleTier) {
                        case '1': cost = 145; break;
                        case '2': cost = 290; break;
                        case '3': cost = 580; break;
                        default: cost = 145; break;
                    }
                } else if (moduleType === 'defense') {
                    switch (moduleTier) {
                        case '1': cost = 50; break;
                        case '2': cost = 100; break;
                        case '3': cost = 200; break;
                        default: cost = 50; break;
                    }
                }

                if (gameState.resources.Steel < cost) {
                    showNotification('Not enough steel to equip this module!', building.x, building.y, 'warning');
                    return;
                }

                const moduleString = `${moduleType}-${moduleTier}`;

                if (building.modules && building.modules.length >= slotNumber && building.modules[slotNumber - 1]) {
                    const oldModule = building.modules[slotNumber - 1];
                    const oldModuleParts = oldModule.split('-');
                    building.removeModule(oldModuleParts[0]);
                }

                if (!building.modules) building.modules = [];

                building.modules[slotNumber - 1] = moduleString;

                building.applyModuleEffect(moduleType);

                gameState.spendResources({ Steel: cost });

                showNotification(`${moduleType === 'speed' ? 'Speed' : 'Defense'} Module (T${moduleTier}) equipped!`, building.x, building.y, 'success');

                setupModuleSlots(building);
                updateDisplay();
            }

            function unequipModule(building, slotNumber) {
                if (building.modules && building.modules.length >= slotNumber && building.modules[slotNumber - 1]) {
                    const module = building.modules[slotNumber - 1];
                    const moduleParts = module.split('-');
                    const moduleType = moduleParts[0];

                    building.removeModuleEffect(moduleType);

                    building.modules[slotNumber - 1] = null;

                    while (building.modules.length > 0 && building.modules[building.modules.length - 1] === null) {
                        building.modules.pop();
                    }

                    showNotification(`${moduleType === 'speed' ? 'Speed' : 'Defense'} Module unequipped!`, building.x, building.y, 'success');

                    setupModuleSlots(building);
                    updateDisplay();
                } else {
                    showNotification('No module to unequip in this slot!', building.x, building.y, 'warning');
                }
            }

            function closeBuildingInfo() {
                const buildingInfoPopup = document.getElementById('building-info-popup');
                const buildingInfoOverlay = document.getElementById('building-info-overlay');

                buildingInfoPopup.style.display = 'none';
                buildingInfoOverlay.style.display = 'none';

                closeModuleSelectionPopup();

                window.currentBuilding = null;
            }


            function openArmySelection(warpgate) {
                const popup = document.getElementById('army-selection-popup');
                if (!popup) return;

                window.currentWarGate = warpgate;

                populateArmyList();

                popup.classList.add('active');
            }

            function closeArmySelection() {
                const popup = document.getElementById('army-selection-popup');
                if (popup) {
                    popup.classList.remove('active');
                }

                window.currentWarGate = null;
                window.selectedArmyUnits = [];
            }

            function populateArmyList() {
                const armyListContainer = document.getElementById('army-units-list');
                if (!armyListContainer) return;

                armyListContainer.innerHTML = '';

                const armyUnits = [];
                for (let y = 0; y < CONFIG.GRID_SIZE_Y; y++) {
                    for (let x = 0; x < CONFIG.GRID_SIZE_X; x++) {
                        const cell = gameState.grid[y][x];
                        if (cell && cell.type === 'army' && cell.subtype !== 'barrack') {
                            armyUnits.push({
                                unit: cell,
                                x: x,
                                y: y,
                                gridX: x + gameState.cameraOffset.x,
                                gridY: y + gameState.cameraOffset.y
                            });
                        }
                    }
                }

                if (armyUnits.length === 0) {
                    armyListContainer.innerHTML = `
                    <div class="no-army-message">
                        <p>No deployable army units found on the grid.</p>
                        <p>Deploy some army units first, then use the War Gate to send them to your base.</p>
                    </div>
                `;
                    document.getElementById('send-army-btn').disabled = true;
                    return;
                }

                document.getElementById('send-army-btn').disabled = false;

                armyUnits.forEach(unitData => {
                    const unitItem = createArmyUnitItem(unitData);
                    armyListContainer.appendChild(unitItem);
                });

                window.selectedArmyUnits = [];
            }

            function createArmyUnitItem(unitData) {
                const unit = unitData.unit;

                const item = document.createElement('div');
                item.className = 'army-unit-item';
                item.dataset.unitId = unit.id;
                item.dataset.gridX = unitData.gridX;
                item.dataset.gridY = unitData.gridY;

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'army-unit-checkbox';

                const iconDiv = document.createElement('div');
                iconDiv.className = 'army-unit-icon';
                const img = document.createElement('img');
                img.src = unit.getSprite();
                img.alt = getBuildingName(unit);
                img.onerror = function () {
                    this.src = './sprites/soldier.png';
                };
                iconDiv.appendChild(img);

                const infoDiv = document.createElement('div');
                infoDiv.className = 'army-unit-info';

                const nameSpan = document.createElement('div');
                nameSpan.className = 'army-unit-name';
                nameSpan.textContent = getBuildingName(unit);

                const statsDiv = document.createElement('div');
                statsDiv.className = 'army-unit-stats';

                const healthStat = document.createElement('span');
                healthStat.className = 'army-unit-stat health';
                healthStat.textContent = `HP: ${unit.health}/${unit.maxHealth}`;

                const rangeStat = document.createElement('span');
                rangeStat.className = 'army-unit-stat range';
                rangeStat.textContent = `Range: ${unit.range}`;

                const movementStat = document.createElement('span');
                movementStat.className = 'army-unit-stat movement';
                movementStat.textContent = `Move: ${unit.movement}`;

                statsDiv.appendChild(healthStat);
                statsDiv.appendChild(rangeStat);
                statsDiv.appendChild(movementStat);

                infoDiv.appendChild(nameSpan);
                infoDiv.appendChild(statsDiv);

                item.addEventListener('click', function (e) {
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                    }
                    updateUnitSelection(item, checkbox.checked);
                });

                checkbox.addEventListener('change', function () {
                    updateUnitSelection(item, this.checked);
                });

                item.appendChild(checkbox);
                item.appendChild(iconDiv);
                item.appendChild(infoDiv);

                return item;
            }

            function updateUnitSelection(item, isSelected) {
                if (isSelected) {
                    item.classList.add('selected');
                    const unitId = item.dataset.unitId;
                    if (!window.selectedArmyUnits.includes(unitId)) {
                        window.selectedArmyUnits.push(unitId);
                    }
                } else {
                    item.classList.remove('selected');
                    const unitId = item.dataset.unitId;
                    window.selectedArmyUnits = window.selectedArmyUnits.filter(id => id !== unitId);
                }
            }

            function sendSelectedArmy() {
                if (!window.currentWarGate || !window.selectedArmyUnits || window.selectedArmyUnits.length === 0) {
                    showNotification('No units selected!', window.currentWarGate.x, window.currentWarGate.y, 'warning');
                    return;
                }

                const oilCost = window.selectedArmyUnits.length * 25;

                if (gameState.resources.oil < oilCost) {
                    showNotification(`Not enough oil! Need ${oilCost} oil (${window.selectedArmyUnits.length} units × 25).`,
                        window.currentWarGate.x, window.currentWarGate.y, 'warning');
                    return;
                }

                gameState.resources.oil -= oilCost;

                const transferredUnits = [];

                window.selectedArmyUnits.forEach(unitId => {
                    const unit = gameState.objects.get(unitId);
                    if (unit) {
                        if (!gameState.storedArmyUnits) {
                            gameState.storedArmyUnits = [];
                        }

                        gameState.storedArmyUnits.push({
                            type: unit.type,
                            subtype: unit.subtype,
                            health: unit.health,
                            maxHealth: unit.maxHealth,
                            range: unit.range,
                            movement: unit.movement
                        });

                        console.log('Stored army unit:', unit.subtype, 'Total stored:', gameState.storedArmyUnits.length);

                        transferredUnits.push(getBuildingName(unit));

                        const gridX = unit.x - gameState.cameraOffset.x;
                        const gridY = unit.y - gameState.cameraOffset.y;

                        if (gridX >= 0 && gridX < CONFIG.GRID_SIZE_X &&
                            gridY >= 0 && gridY < CONFIG.GRID_SIZE_Y) {
                            gameState.grid[gridY][gridX] = null;
                        }

                        gameState.objects.delete(unitId);
                        gameState.worldObjects.delete(unitId);
                    }
                });

                closeArmySelection();
                updateDisplay();

                setTimeout(() => {
                    updateArmyBoxDisplay();
                    console.log('Forced army box update. Stored units:', gameState.storedArmyUnits?.length || 0);
                }, 100);

                const unitNames = transferredUnits.slice(0, 3).join(', ');
                const extraText = transferredUnits.length > 3 ? ` and ${transferredUnits.length - 3} more` : '';
                showNotification(`Sent ${unitNames}${extraText} to base! (-${oilCost} oil)`,
                    window.currentWarGate.x, window.currentWarGate.y, 'success');
            }

            document.addEventListener('DOMContentLoaded', function () {
                console.log('DOM loaded, initializing army box display');
                setTimeout(() => {
                    updateArmyBoxDisplay();
                    console.log('Initial army box display updated');
                }, 500);
            });

            function updateArmyBoxDisplay() {
                const armyBox = document.getElementById('army-box');
                const unitCount = document.getElementById('army-unit-count');
                const unitsContainer = document.getElementById('army-units-container');

                if (!armyBox || !unitCount || !unitsContainer) return;

                const storedUnits = gameState.storedArmyUnits || [];

                unitCount.textContent = `${storedUnits.length} units`;

                unitsContainer.innerHTML = '';

                if (storedUnits.length === 0) {
                    unitsContainer.innerHTML = `
                    <div class="no-army-units">
                        <p>No army units stored</p>
                        <p>Use the WarGate to send units from a dive.</p>
                    </div>
                `;
                    return;
                }

                storedUnits.forEach(unitData => {
                    const unitElement = createArmyUnitDisplay(unitData);
                    unitsContainer.appendChild(unitElement);
                });
            }

            function createArmyUnitDisplay(unitData) {
                const unitDiv = document.createElement('div');
                unitDiv.className = 'army-unit-display';

                const iconDiv = document.createElement('div');
                iconDiv.className = 'army-unit-display-icon';
                const img = document.createElement('img');

                const spritePath = getSpriteForArmyType(unitData.subtype);
                img.src = spritePath;
                img.alt = unitData.subtype;
                img.onerror = function () {
                    this.src = './sprites/soldier.png';
                };

                iconDiv.appendChild(img);

                const infoDiv = document.createElement('div');
                infoDiv.className = 'army-unit-display-info';

                const nameDiv = document.createElement('div');
                nameDiv.className = 'army-unit-display-name';
                nameDiv.textContent = getBuildingName({ type: 'army', subtype: unitData.subtype });

                const statsDiv = document.createElement('div');
                statsDiv.className = 'army-unit-display-stats';

                const healthStat = document.createElement('span');
                healthStat.className = 'army-unit-display-stat health';
                healthStat.textContent = `HP: ${unitData.health}/${unitData.maxHealth}`;

                const damageStat = document.createElement('span');
                damageStat.className = 'army-unit-display-stat damage';
                damageStat.textContent = `DMG: ${unitData.damage || 1}`;

                const rangeStat = document.createElement('span');
                rangeStat.className = 'army-unit-display-stat range';
                rangeStat.textContent = `Range: ${unitData.range}`;

                const movementStat = document.createElement('span');
                movementStat.className = 'army-unit-display-stat movement';
                movementStat.textContent = `Move: ${unitData.movement}`;

                statsDiv.appendChild(healthStat);
                statsDiv.appendChild(damageStat);
                statsDiv.appendChild(rangeStat);
                statsDiv.appendChild(movementStat);

                infoDiv.appendChild(nameDiv);
                infoDiv.appendChild(statsDiv);

                unitDiv.appendChild(iconDiv);
                unitDiv.appendChild(infoDiv);

                return unitDiv;
            }

            function getSpriteForArmyType(subtype) {
                const spriteMap = {
                    'scout': './sprites/soldier.png',
                    'knight': './sprites/knight.png',
                    'archer': './sprites/Archer.png',
                    'tank': './sprites/Tank.png',
                    'siegetower': './sprites/siegetower.png',
                    'camptower': './sprites/camptower.png',
                    'king': './sprites/king.png',
                    'barrack': './sprites/barrack.png'
                };

                return spriteMap[subtype] || './sprites/soldier.png';
            }

            function teleportArmyHome() {
                if (gameState.resources.oil < 50) {
                    showNotification('Not enough oil! Need 50 oil to teleport armies.', 12, 7, 'warning');
                    return;
                }

                const armyUnits = [];
                for (let y = 0; y < CONFIG.GRID_SIZE_Y; y++) {
                    for (let x = 0; x < CONFIG.GRID_SIZE_X; x++) {
                        const cell = gameState.grid[y][x];
                        if (cell && cell.type === 'army') {
                            armyUnits.push({
                                unit: cell,
                                x: x,
                                y: y
                            });
                        }
                    }
                }

                if (armyUnits.length === 0) {
                    showNotification('No deployed armies to teleport!', 12, 7, 'warning');
                    return;
                }

                gameState.resources.oil -= 50;

                const fortressPos = CONFIG.PLAYER_START;
                let teleportedCount = 0;

                armyUnits.forEach(({ unit, x, y }) => {
                    gameState.grid[y][x] = null;

                    if (gameState.grid[fortressPos.y][fortressPos.x] === null) {
                        unit.x = fortressPos.x + gameState.cameraOffset.x;
                        unit.y = fortressPos.y + gameState.cameraOffset.y;
                        gameState.grid[fortressPos.y][fortressPos.x] = unit;
                        teleportedCount++;
                    } else {
                        const nearbySpots = [
                            { x: fortressPos.x - 1, y: fortressPos.y },
                            { x: fortressPos.x + 1, y: fortressPos.y },
                            { x: fortressPos.x, y: fortressPos.y - 1 },
                            { x: fortressPos.x, y: fortressPos.y + 1 }
                        ];

                        let placed = false;
                        for (const spot of nearbySpots) {
                            if (spot.x >= 0 && spot.x < CONFIG.GRID_SIZE_X &&
                                spot.y >= 0 && spot.y < CONFIG.GRID_SIZE_Y &&
                                gameState.grid[spot.y][spot.x] === null) {
                                unit.x = spot.x + gameState.cameraOffset.x;
                                unit.y = spot.y + gameState.cameraOffset.y;
                                gameState.grid[spot.y][spot.x] = unit;
                                teleportedCount++;
                                placed = true;
                                break;
                            }
                        }

                        if (!placed) {
                        }
                    }
                });

                closeBuildingInfo();
                updateDisplay();

                showNotification(`Teleported ${teleportedCount} armies back to base! (-50 oil)`, 12, 7, 'success');
            }

            function showTooltip(element, text) {
                hideTooltip();

                const tooltip = document.createElement('div');
                tooltip.className = 'tech-tooltip';
                tooltip.innerHTML = text;
                tooltip.id = 'tech-tree-tooltip';

                tooltip.style.opacity = '0';

                document.querySelector('.tech-tree-content').appendChild(tooltip);

                setTimeout(() => {
                    if (tooltip.parentNode) {
                        tooltip.style.opacity = '1';
                    }
                }, 50);
            }

            function updateTooltipPosition(e) {
                const tooltip = document.getElementById('tech-tree-tooltip');
                if (!tooltip) return;

                const techTreeContent = document.querySelector('.tech-tree-content');
                const techTreeRect = techTreeContent.getBoundingClientRect();

                let left = e.clientX - techTreeRect.left + 10;
                let top = e.clientY - techTreeRect.top + 10;

                if (tooltip.offsetWidth) {
                    if (left + tooltip.offsetWidth > techTreeRect.width - 10) {
                        left = techTreeRect.width - tooltip.offsetWidth - 10;
                    }
                    if (top + tooltip.offsetHeight > techTreeRect.height - 10) {
                        top = techTreeRect.height - tooltip.offsetHeight - 10;
                    }
                    if (left < 10) {
                        left = 10;
                    }
                    if (top < 10) {
                        top = 10;
                    }
                }

                tooltip.style.left = left + 'px';
                tooltip.style.top = top + 'px';
            }

            function hideTooltip() {
                const tooltip = document.getElementById('tech-tree-tooltip');
                if (tooltip) {
                    tooltip.style.opacity = '0';
                    setTimeout(() => {
                        if (tooltip.parentNode) {
                            tooltip.parentNode.removeChild(tooltip);
                        }
                    }, 200);
                }
            }

            function makeFoldersDraggable() {
                document.querySelectorAll('.folder-content').forEach(function (folderContent) {
                    const header = folderContent.querySelector('.folder-header');
                    if (!header) return;

                    let isDragging = false;
                    let currentX;
                    let currentY;
                    let initialX;
                    let initialY;
                    let xOffset = 0;
                    let yOffset = 0;

                    header.addEventListener('mousedown', dragStart);
                    document.addEventListener('mouseup', dragEnd);
                    document.addEventListener('mousemove', drag);

                    function dragStart(e) {
                        if (e.target.closest('.folder-close')) return;

                        initialX = e.clientX - xOffset;
                        initialY = e.clientY - yOffset;

                        isDragging = true;
                        header.style.cursor = 'grabbing';
                    }

                    function dragEnd() {
                        initialX = currentX;
                        initialY = currentY;

                        isDragging = false;
                        header.style.cursor = 'move';
                    }

                    function drag(e) {
                        if (isDragging) {
                            e.preventDefault();
                            currentX = e.clientX - initialX;
                            currentY = e.clientY - initialY;

                            xOffset = currentX;
                            yOffset = currentY;

                            setTranslate(currentX, currentY, folderContent);
                        }
                    }

                    function setTranslate(xPos, yPos, el) {
                        el.style.transform = 'translate3d(' + xPos + 'px, ' + yPos + 'px, 0)';
                    }
                });
            }

            function restartGame() {
                if (confirm('Are you sure you want to restart the game?')) {
                    gameState.reset();
                    initGame();
                }
            }

            function saveGame() {
                const gameData = {
                    resources: gameState.resources,
                    storedResources: gameState.storedResources,
                    sessionResources: gameState.sessionResources,
                    turn: gameState.turn,
                    wave: gameState.wave,
                    waveBreakTurns: gameState.waveBreakTurns,
                    inWaveBreak: gameState.inWaveBreak,
                    enemiesRemaining: gameState.enemiesRemaining,
                    researchedTechs: Array.from(gameState.researchedTechs),
                    grid: serializeGrid(),
                    gameMode: gameState.gameMode,
                    currentZone: gameState.currentZone,
                    zoneDepth: gameState.zoneDepth,
                    threatLevel: gameState.threatLevel,
                    cameraOffset: gameState.cameraOffset
                };

                const blob = new Blob([JSON.stringify(gameData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `coregrid_save_${new Date().toISOString().slice(0, 10)}.coregrid`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showNotification('Game saved successfully!', CONFIG.PLAYER_START.x, CONFIG.PLAYER_START.y, 'success');
            }

            function loadGame(file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const gameData = JSON.parse(e.target.result);

                        if (!gameData.resources || !gameData.grid) {
                            throw new Error('Invalid save file');
                        }

                        gameState.resources = gameData.resources;
                        gameState.storedResources = gameData.storedResources || { ...CONFIG.INITIAL_RESOURCES };
                        gameState.sessionResources = gameData.sessionResources || { Steel: 0, coins: 0, gold: 0, oil: 0 };
                        gameState.turn = gameData.turn;
                        gameState.wave = gameData.wave;
                        gameState.waveBreakTurns = gameData.waveBreakTurns || 0;
                        gameState.inWaveBreak = gameData.inWaveBreak || false;
                        gameState.enemiesRemaining = gameData.enemiesRemaining || 0;

                        gameState.gameMode = gameData.gameMode || 'homescreen';
                        gameState.currentZone = gameData.currentZone || null;
                        gameState.zoneDepth = gameData.zoneDepth || 0;
                        gameState.threatLevel = gameData.threatLevel || 0;
                        gameState.cameraOffset = gameData.cameraOffset || { x: 0, y: 0 };

                        gameState.researchedTechs = new Set(gameData.researchedTechs || []);
                        gameState.updateAvailableTechs();

                        deserializeGrid(gameData.grid);

                        if (gameState.gameMode === 'active_zone' && gameState.currentZone) {
                            showActiveZoneView();
                            document.getElementById('current-zone-display').textContent =
                                `${gameState.currentZone.toUpperCase()} ZONE`;
                            updateExtractionDisplay();
                        } else {
                            showHomescreen();
                        }

                        showNotification('Game loaded successfully!', CONFIG.PLAYER_START.x, CONFIG.PLAYER_START.y, 'success');
                        updateDisplay();
                    } catch (error) {
                        showNotification('Error loading game: Invalid save file', CONFIG.PLAYER_START.x, CONFIG.PLAYER_START.y, 'danger');
                        console.error('Error loading game:', error);
                    }
                };
                reader.readAsText(file);
            }

            function serializeGrid() {
                const gridData = [];
                for (let y = 0; y < CONFIG.GRID_SIZE_Y; y++) {
                    const row = [];
                    for (let x = 0; x < CONFIG.GRID_SIZE_X; x++) {
                        const obj = gameState.grid[y][x];
                        if (obj === 'player') {
                            row.push('player');
                        } else if (obj && obj.type) {
                            row.push({
                                type: obj.type,
                                subtype: obj.subtype,
                                health: obj.health,
                                maxHealth: obj.maxHealth,
                                modules: obj.modules || [],
                                ...(obj.type === 'tech' && (obj.subtype === 'turret' || obj.subtype === 'goldturret') ? { shotsLeft: obj.shotsLeft } : {}),
                                ...(obj.type === 'army' && obj.subtype === 'barrack' ? { spawnCounter: obj.spawnCounter } : {})
                            });
                        } else {
                            row.push(null);
                        }
                    }
                    gridData.push(row);
                }
                return gridData;
            }

            function deserializeGrid(gridData) {
                gameState.grid = Array(CONFIG.GRID_SIZE_Y).fill().map(() => Array(CONFIG.GRID_SIZE_X).fill(null));
                gameState.objects.clear();

                for (let y = 0; y < CONFIG.GRID_SIZE_Y; y++) {
                    for (let x = 0; x < CONFIG.GRID_SIZE_X; x++) {
                        const objData = gridData[y][x];
                        if (objData === 'player') {
                            gameState.grid[y][x] = 'player';
                        } else if (objData && objData.type) {
                            let obj;
                            switch (objData.type) {
                                case 'wall':
                                    obj = new Wall(x, y, objData.subtype);
                                    break;
                                case 'tech':
                                    obj = new Tech(x, y, objData.subtype);
                                    break;
                                case 'army':
                                    obj = new Army(x, y, objData.subtype);
                                    break;

                                case 'enemy':
                                    obj = new Enemy(x, y, objData.subtype);
                                    break;
                                default:
                                    continue;
                            }

                            obj.health = objData.health;
                            obj.maxHealth = objData.maxHealth;

                            if (objData.modules && objData.modules.length > 0) {
                                obj.modules = [...objData.modules];
                                objData.modules.forEach(module => {
                                    obj.applyModuleEffect(module);
                                });
                            }

                            if (objData.type === 'tech' && (objData.subtype === 'turret' || objData.subtype === 'goldturret') && objData.shotsLeft) {
                                obj.shotsLeft = objData.shotsLeft;
                            }

                            if (objData.type === 'army' && objData.subtype === 'barrack' && objData.spawnCounter) {
                                obj.spawnCounter = objData.spawnCounter;
                            }

                            gameState.grid[y][x] = obj;
                            gameState.objects.set(obj.id, obj);
                        }
                    }
                }
            }

            document.addEventListener('keydown', function (event) {
                if (event.key === 'Escape') {
                    closeModuleSelectionPopup();
                    closeBuildingInfo();
                    return;
                }

                if (!['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(event.key)) {
                    return;
                }

                event.preventDefault();

                switch (event.key) {
                    case 'ArrowUp':
                        moveCamera(0, -1);
                        break;
                    case 'ArrowDown':
                        moveCamera(0, 1);
                        break;
                    case 'ArrowLeft':
                        moveCamera(-1, 0);
                        break;
                    case 'ArrowRight':
                        moveCamera(1, 0);
                        break;
                }

                updateDisplay();
            });

            function moveCamera(dx, dy) {
                gameState.cameraOffset.x += dx;
                gameState.cameraOffset.y += dy;

                updateGridFromWorldObjects();
            }

            function updateGridFromWorldObjects() {
                gameState.grid = Array(CONFIG.GRID_SIZE_Y).fill().map(() => Array(CONFIG.GRID_SIZE_X).fill(null));

                gameState.worldObjects.forEach(obj => {
                    const gridX = obj.x - gameState.cameraOffset.x;
                    const gridY = obj.y - gameState.cameraOffset.y;

                    if (gridX >= 0 && gridX < CONFIG.GRID_SIZE_X &&
                        gridY >= 0 && gridY < CONFIG.GRID_SIZE_Y) {
                        gameState.grid[gridY][gridX] = obj;
                    }
                });

                const playerWorldX = CONFIG.PLAYER_START.x;
                const playerWorldY = CONFIG.PLAYER_START.y;
                const playerGridX = playerWorldX - gameState.cameraOffset.x;
                const playerGridY = playerWorldY - gameState.cameraOffset.y;

                if (playerGridX >= 0 && playerGridX < CONFIG.GRID_SIZE_X &&
                    playerGridY >= 0 && playerGridY < CONFIG.GRID_SIZE_Y) {
                    gameState.grid[playerGridY][playerGridX] = 'player';
                }
            }

            function addObjectToWorld(obj) {
                gameState.worldObjects.set(obj.id, obj);

                const gridX = obj.x - gameState.cameraOffset.x;
                const gridY = obj.y - gameState.cameraOffset.y;

                if (gridX >= 0 && gridX < CONFIG.GRID_SIZE_X &&
                    gridY >= 0 && gridY < CONFIG.GRID_SIZE_Y) {
                    gameState.objects.set(obj.id, obj);
                    gameState.grid[gridY][gridX] = obj;
                }
            }

            function debugNextWave() {
                console.log("Debug: Manually triggering next wave");
                spawnNextWave();
            }

            let cheatSequence = [];
            const cheats = {
                'ilikefemboys': {
                    sequence: ['i', 'l', 'i', 'k', 'e', 'f', 'e', 'm', 'b', 'o', 'y', 's'],
                    action: () => {
                        gameState.storedResources.Steel += 7000;
                        gameState.storedResources.coins += 7000;
                        gameState.storedResources.gold += 7000;
                        gameState.storedResources.oil += 7000;

                        gameState.resources.Steel += 7000;
                        gameState.resources.coins += 7000;
                        gameState.resources.gold += 7000;
                        gameState.resources.oil += 7000;

                        updateDisplay();
                        showNotification('hell yeah! +7000 Steel, Coins, Gold, and Oil added to VAULT!', CONFIG.PLAYER_START.x, CONFIG.PLAYER_START.y, 'success');
                    }
                },
                'trapsarehot': {
                    sequence: ['t', 'r', 'a', 'p', 's', 'a', 'r', 'e', 'h', 'o', 't'],
                    action: () => {
                        // Add 10 of each army type
                        const armyTypes = ['scout', 'knight', 'archer', 'tank'];
                        
                        if (!gameState.storedArmyUnits) {
                            gameState.storedArmyUnits = [];
                        }
                        
                        armyTypes.forEach(unitType => {
                            for (let i = 0; i < 10; i++) {
                                const unitTemplate = {
                                    type: 'army',
                                    subtype: unitType,
                                    health: getUnitMaxHealth(unitType),
                                    maxHealth: getUnitMaxHealth(unitType),
                                    damage: getUnitDamage(unitType),
                                    range: getUnitRange(unitType),
                                    movement: getUnitMovement(unitType),
                                    id: Date.now() + Math.random()
                                };
                                gameState.storedArmyUnits.push(unitTemplate);
                            }
                        });
                        
                        updateDisplay();
                        updateArmyBoxDisplay();
                        showNotification('Cheat activated! +10 of each army unit added to your army!', CONFIG.PLAYER_START.x, CONFIG.PLAYER_START.y, 'success');
                    }
                }
            };

            document.addEventListener('keydown', (event) => {
                cheatSequence.push(event.key.toLowerCase());

                // Check each cheat
                Object.keys(cheats).forEach(cheatName => {
                    const cheat = cheats[cheatName];
                    const sequenceLength = cheat.sequence.length;
                    
                    if (cheatSequence.length > sequenceLength) {
                        cheatSequence.shift();
                    }

                    if (cheatSequence.length === sequenceLength) {
                        let sequenceMatch = true;
                        for (let i = 0; i < sequenceLength; i++) {
                            if (cheatSequence[i] !== cheat.sequence[i]) {
                                sequenceMatch = false;
                                break;
                            }
                        }
                        
                        if (sequenceMatch) {
                            cheat.action();
                            cheatSequence = [];
                        }
                    }
                });
            });

            function createTechTreeCompletionEffects(rewards) {
                for (let y = 0; y < CONFIG.GRID_SIZE_Y; y++) {
                    for (let x = 0; x < CONFIG.GRID_SIZE_X; x++) {
                        setTimeout(() => {
                            const cell = document.querySelector(`[data-x="${x}"][data-y="${y}"]`);
                            if (cell) {
                                const rect = cell.getBoundingClientRect();
                                const centerX = rect.left + rect.width / 2;
                                const centerY = rect.top + rect.height / 2;

                                createParticleEffect(centerX, centerY, '#66d9ff', 8);
                                setTimeout(() => createParticleEffect(centerX, centerY, '#ffcc00', 6), 100);
                                setTimeout(() => createParticleEffect(centerX, centerY, '#ff5555', 4), 200);
                            }
                        }, (y * CONFIG.GRID_SIZE_X + x) * 20);
                    }
                }

                showCompletionBanner(rewards);
            }

            function showCompletionBanner(rewards) {
                // Default rewards if none provided
                const defaultRewards = {
                    Steel: 1000,
                    coins: 250,
                    gold: 250,
                    oil: 100
                };
                
                const actualRewards = rewards || defaultRewards;
                
                const banner = document.createElement('div');
                banner.className = 'tech-tree-completion-banner';
                banner.innerHTML = `
                <div class="banner-content">
                    <h2>🎉 TECH TREE COMPLETED! 🎉</h2>
                    <p>You have unlocked all technologies!</p>
                    <div class="bonus-rewards">
                        <span class="reward-item"><img src="./sprites/ironin.png"> +${actualRewards.Steel}</span>
                        <span class="reward-item"><img src="./sprites/coin.png"> +${actualRewards.coins}</span>
                        <span class="reward-item"><img src="./sprites/goldin.png"> +${actualRewards.gold}</span>
                        <span class="reward-item"><img src="./sprites/Oil.png"> +${actualRewards.oil}</span>
                    </div>
                </div>
            `;

                document.body.appendChild(banner);

                setTimeout(() => {
                    if (banner.parentNode) {
                        banner.style.animation = 'fadeOut 1s ease forwards';
                        setTimeout(() => {
                            if (banner.parentNode) {
                                banner.parentNode.removeChild(banner);
                            }
                        }, 1000);
                    }
                }, 5000);
            }

            document.addEventListener('DOMContentLoaded', async function () {
                await loadTechTree();
                initGame();
            });

            let selectedZoneType = null;
            let resourceSelection = { Steel: 0, coins: 0, gold: 0, oil: 0 };

            function openResourceSelection(zoneType) {
                selectedZoneType = zoneType;

                closeZoneSelection();

                const popup = document.getElementById('resource-selection-popup');
                if (popup) {
                    popup.classList.add('active');

                    document.getElementById('available-steel').textContent = gameState.storedResources.Steel;
                    document.getElementById('available-coins').textContent = gameState.storedResources.coins;
                    document.getElementById('available-gold').textContent = gameState.storedResources.gold;
                    document.getElementById('available-oil').textContent = gameState.storedResources.oil;

                    document.getElementById('overview-steel').textContent = gameState.storedResources.Steel;
                    document.getElementById('overview-coins').textContent = gameState.storedResources.coins;
                    document.getElementById('overview-gold').textContent = gameState.storedResources.gold;
                    document.getElementById('overview-oil').textContent = gameState.storedResources.oil;

                    document.getElementById('steel-slider').max = gameState.storedResources.Steel;
                    document.getElementById('steel-slider').value = 0;
                    document.getElementById('coins-slider').max = gameState.storedResources.coins;
                    document.getElementById('coins-slider').value = 0;
                    document.getElementById('gold-slider').max = gameState.storedResources.gold;
                    document.getElementById('gold-slider').value = 0;
                    document.getElementById('oil-slider').max = gameState.storedResources.oil;
                    document.getElementById('oil-slider').value = 0;
                    
                    // Force immediate update of displayed values
                    updateResourceValues();
                                    
                    // Ensure all values are properly displayed
                    requestAnimationFrame(() => {
                        updateResourceValues();
                        // Force reflow to ensure DOM updates are visible
                        popup.offsetHeight;
                    });
                    
                    // Set up periodic updates every 1 second while modal is open
                    if (window.resourceUpdateInterval) {
                        clearInterval(window.resourceUpdateInterval);
                    }
                    window.resourceUpdateInterval = setInterval(() => {
                        const modal = document.getElementById('resource-selection-popup');
                        if (modal && modal.classList.contains('active')) {
                            updateResourceValues();
                        } else {
                            // Clean up interval when modal is closed
                            clearInterval(window.resourceUpdateInterval);
                            window.resourceUpdateInterval = null;
                        }
                    }, 1000);
                }
            }

            function closeResourceSelection() {
                const popup = document.getElementById('resource-selection-popup');
                if (popup) {
                    popup.classList.remove('active');
                }
                selectedZoneType = null;
                
                // Clear the periodic update interval
                if (window.resourceUpdateInterval) {
                    clearInterval(window.resourceUpdateInterval);
                    window.resourceUpdateInterval = null;
                }
            }

            // Set up periodic display updates every 1 second
            function initializePeriodicUpdates() {
                if (window.mainDisplayUpdateInterval) {
                    clearInterval(window.mainDisplayUpdateInterval);
                }
                
                window.mainDisplayUpdateInterval = setInterval(() => {
                    // Update main resource display
                    updateDisplay();
                    
                    // Also update tech tree resources if it's open
                    updateTechTreeResources();
                }, 1000);
            }

            // Initialize periodic updates when page loads
            document.addEventListener('DOMContentLoaded', function() {
                initializePeriodicUpdates();
            });

            function closeZoneSelection() {
                const popup = document.getElementById('zone-selection-popup');
                if (popup) {
                    popup.classList.remove('active');
                }
            }

            function openCratesModal() {
                const cratesModal = document.getElementById('crates-modal');
                if (cratesModal) {
                    cratesModal.classList.add('active');
                    updateCrateButtons();
                    
                    // Refresh daily crate display when modal opens
                    checkNewDay();
                    updateDailyCrateDisplay();
                }
            }

            function closeCratesModal() {
                const cratesModal = document.getElementById('crates-modal');
                if (cratesModal) {
                    cratesModal.classList.remove('active');
                }
            }

            function updateCrateButtons() {
                // Update button states based on player's resources
                const crateItems = document.querySelectorAll('.crate-item');
                
                crateItems.forEach(item => {
                    const crateType = item.dataset.crate;
                    const level = parseInt(item.dataset.level);
                    const buyBtn = item.querySelector('.crate-buy-btn');
                    
                    const canAfford = canAffordCrate(crateType, level);
                    buyBtn.disabled = !canAfford;
                    
                    if (!canAfford) {
                        buyBtn.style.opacity = '0.5';
                        buyBtn.style.cursor = 'not-allowed';
                    } else {
                        buyBtn.style.opacity = '1';
                        buyBtn.style.cursor = 'pointer';
                    }
                });
            }

            function canAffordCrate(crateType, level) {
                const crateCosts = {
                    ore: {
                        1: { coins: 1000 },
                        2: { coins: 2000 },
                        3: { coins: 3000 }
                    },
                    oil: {
                        1: { Steel: 3000 },
                        2: { Steel: 4000 }
                    }
                };
                
                const cost = crateCosts[crateType][level];
                
                for (const [resource, amount] of Object.entries(cost)) {
                    if (gameState.storedResources[resource] < amount) {
                        return false;
                    }
                }
                return true;
            }

            function buyCrate(crateType, level) {
                const crateCosts = {
                    ore: {
                        1: { coins: 1000 },
                        2: { coins: 2000 },
                        3: { coins: 3000 }
                    },
                    oil: {
                        1: { Steel: 3000 },
                        2: { Steel: 4000 }
                    }
                };
                
                const crateNames = {
                    ore: {
                        1: 'Ore Crate Level 1',
                        2: 'Ore Crate Level 2',
                        3: 'Ore Crate Level 3'
                    },
                    oil: {
                        1: 'Oil Crate Level 1',
                        2: 'Oil Crate Level 2'
                    }
                };
                
                const cost = crateCosts[crateType][level];
                const crateName = crateNames[crateType][level];
                
                // Check if player can afford
                if (!canAffordCrate(crateType, level)) {
                    showNotification('Not enough resources to buy this crate!', 12, 7, 'warning');
                    return;
                }
                
                // Deduct cost
                for (const [resource, amount] of Object.entries(cost)) {
                    gameState.storedResources[resource] -= amount;
                }
                
                // Open crate and get reward
                const reward = openCrate(crateType, level);
                
                // Add reward to player's resources
                gameState.addResources(reward);
                
                // Show animated crate opening modal
                showAnimatedCrateOpening(crateType, level, reward, cost);
                
                // Update display
                updateDisplay();
                updateCrateButtons();
            }

            // Daily Crate System
            let dailyCrateData = {
                lastClaimDate: null,
                streak: 1,
                claimedToday: false
            };

            function initializeDailyCrate() {
                // Load saved data from localStorage
                const savedData = localStorage.getItem('coregrid_daily_crate');
                if (savedData) {
                    try {
                        dailyCrateData = JSON.parse(savedData);
                    } catch (e) {
                        console.error('Failed to parse daily crate data:', e);
                        resetDailyCrateData();
                    }
                }
                
                // Check if it's a new day
                checkNewDay();
                updateDailyCrateDisplay();
            }

            function resetDailyCrateData() {
                dailyCrateData = {
                    lastClaimDate: null,
                    streak: 1,
                    claimedToday: false
                };
                saveDailyCrateData();
            }

            function saveDailyCrateData() {
                try {
                    localStorage.setItem('coregrid_daily_crate', JSON.stringify(dailyCrateData));
                } catch (e) {
                    console.error('Failed to save daily crate data:', e);
                }
            }

            function checkNewDay() {
                const today = new Date().toDateString();
                const lastClaim = dailyCrateData.lastClaimDate;
                
                if (lastClaim) {
                    const lastClaimDate = new Date(lastClaim).toDateString();
                    
                    if (lastClaimDate !== today) {
                        // Different day
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        const yesterdayString = yesterday.toDateString();
                        
                        if (lastClaimDate === yesterdayString && !dailyCrateData.claimedToday) {
                            // Consecutive day - increase streak
                            dailyCrateData.streak = Math.min(dailyCrateData.streak + 1, 30); // Max 30 day streak
                        } else {
                            // Missed a day - reset streak
                            dailyCrateData.streak = 1;
                        }
                        dailyCrateData.claimedToday = false;
                    }
                } else {
                    // First time playing
                    dailyCrateData.streak = 1;
                    dailyCrateData.claimedToday = false;
                }
            }

            function updateDailyCrateDisplay() {
                const streakElement = document.getElementById('current-streak');
                const rewardsElement = document.getElementById('streak-rewards');
                const crateItem = document.getElementById('daily-crate-item');
                const claimButton = document.getElementById('claim-daily-btn');
                
                if (streakElement) {
                    streakElement.textContent = dailyCrateData.streak;
                }
                
                if (rewardsElement) {
                    const baseRewards = {
                        Steel: 500,
                        coins: 250,
                        gold: 250,
                        oil: 50
                    };
                    
                    // Double rewards for each day of streak
                    const multiplier = Math.pow(2, dailyCrateData.streak - 1);
                    const rewards = [];
                    
                    Object.entries(baseRewards).forEach(([resource, amount]) => {
                        const finalAmount = Math.floor(amount * multiplier);
                        const symbol = getResourceSymbol(resource);
                        rewards.push(`${finalAmount}${symbol}`);
                    });
                    
                    rewardsElement.textContent = rewards.join(' ');
                }
                
                // Update UI based on claim status
                if (crateItem && claimButton) {
                    if (dailyCrateData.claimedToday) {
                        crateItem.classList.add('claimed-today');
                        claimButton.textContent = 'CLAIMED TODAY';
                        claimButton.disabled = true;
                    } else {
                        crateItem.classList.remove('claimed-today');
                        claimButton.textContent = 'CLAIM DAILY';
                        claimButton.disabled = false;
                    }
                }
            }

            function claimDailyCrate() {
                if (dailyCrateData.claimedToday) {
                    showNotification('You\'ve already claimed today! Come back tomorrow.', 12, 7, 'warning');
                    return;
                }

                // Calculate rewards based on streak
                const baseRewards = {
                    Steel: 500,
                    coins: 250,
                    gold: 250,
                    oil: 50
                };
                
                const multiplier = Math.pow(2, dailyCrateData.streak - 1);
                const rewards = {};
                
                Object.entries(baseRewards).forEach(([resource, amount]) => {
                    rewards[resource] = Math.floor(amount * multiplier);
                });
                
                // Add rewards directly to vault (storedResources) since this is a free daily reward
                if (rewards.Steel) gameState.storedResources.Steel += rewards.Steel;
                if (rewards.coins) gameState.storedResources.coins += rewards.coins;
                if (rewards.gold) gameState.storedResources.gold += rewards.gold;
                if (rewards.oil) gameState.storedResources.oil += rewards.oil;
                
                // Also add to current resources for immediate availability
                gameState.addResources(rewards);
                
                // Update daily crate data
                dailyCrateData.lastClaimDate = new Date().toDateString();
                dailyCrateData.claimedToday = true;
                
                // Save data
                saveDailyCrateData();
                
                // Update display
                updateDailyCrateDisplay();
                updateDisplay(); // This will update vault displays
                
                // Show notification with rewards
                const rewardList = Object.entries(rewards)
                    .map(([resource, amount]) => `+${amount.toLocaleString()} ${resource}`)
                    .join(', ');
                
                showNotification(`Daily Crate Claimed! Streak: ${dailyCrateData.streak} days! Rewards: ${rewardList}`, 12, 7, 'success');
                
                // Create visual effect
                createDailyCrateEffect();
            }

            function createDailyCrateEffect() {
                const effect = document.createElement('div');
                effect.className = 'crate-opening-effect';
                effect.innerHTML = `
                    <div class="crate-effect-content">
                        <div class="crate-sparkles"></div>
                        <div class="crate-text">DAILY REWARD!</div>
                    </div>
                `;
                
                document.body.appendChild(effect);
                
                setTimeout(() => {
                    if (effect.parentNode) {
                        effect.parentNode.removeChild(effect);
                    }
                }, 2000);
            }

            function getResourceSymbol(resource) {
                const symbols = {
                    'Steel': 'S',
                    'coins': 'C',
                    'gold': 'G',
                    'oil': 'O'
                };
                return symbols[resource] || resource.charAt(0).toUpperCase();
            }

            function openCrate(crateType, level) {
                // Define reward ranges based on crate type and level
                const rewardRanges = {
                    ore: {
                        1: { min: 200, max: 2000, resources: ['Steel', 'coins', 'gold'] },
                        2: { min: 400, max: 4000, resources: ['Steel', 'coins', 'gold'] },
                        3: { min: 600, max: 10000, resources: ['Steel', 'coins', 'gold'] }
                    },
                    oil: {
                        1: { min: 150, max: 1500, resources: ['oil'] },
                        2: { min: 200, max: 4000, resources: ['oil'] }
                    }
                };
                
                const range = rewardRanges[crateType][level];
                
                // Implement weighted RNG - higher level = lower chance of good rewards
                let rewardAmount;
                
                if (level === 1) {
                    // Level 1: 70% chance of good reward, 30% chance of poor reward
                    if (Math.random() < 0.7) {
                        // Good reward: 70-100% of max range
                        rewardAmount = Math.floor(range.max * (0.7 + Math.random() * 0.3));
                    } else {
                        // Poor reward: 10-40% of max range
                        rewardAmount = Math.floor(range.max * (0.1 + Math.random() * 0.3));
                    }
                } else if (level === 2) {
                    // Level 2: 50% chance of good reward, 50% chance of average reward
                    const roll = Math.random();
                    if (roll < 0.5) {
                        // Good reward: 60-100% of max range
                        rewardAmount = Math.floor(range.max * (0.6 + Math.random() * 0.4));
                    } else {
                        // Average reward: 30-70% of max range
                        rewardAmount = Math.floor(range.max * (0.3 + Math.random() * 0.4));
                    }
                } else {
                    // Level 3: 30% chance of good reward, 70% chance of poor reward
                    if (Math.random() < 0.3) {
                        // Good reward: 50-100% of max range
                        rewardAmount = Math.floor(range.max * (0.5 + Math.random() * 0.5));
                    } else {
                        // Poor reward: 10-50% of max range
                        rewardAmount = Math.floor(range.max * (0.1 + Math.random() * 0.4));
                    }
                }
                
                // Ensure minimum reward
                rewardAmount = Math.max(range.min, rewardAmount);
                
                // Distribute reward among available resources
                const reward = {};
                
                if (range.resources.length === 1) {
                    // Single resource reward (oil crates)
                    reward[range.resources[0]] = rewardAmount;
                } else {
                    // Multiple resource reward (ore crates)
                    const resources = [...range.resources];
                    let remainingAmount = rewardAmount;
                    
                    // Shuffle resources for random distribution
                    for (let i = resources.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [resources[i], resources[j]] = [resources[j], resources[i]];
                    }
                    
                    // Distribute reward randomly among resources
                    resources.forEach((resource, index) => {
                        if (index === resources.length - 1) {
                            // Last resource gets remaining amount
                            reward[resource] = remainingAmount;
                        } else {
                            // Random amount for this resource
                            const amount = Math.floor(Math.random() * (remainingAmount * 0.6)) + 50;
                            reward[resource] = Math.min(amount, remainingAmount);
                            remainingAmount -= reward[resource];
                        }
                    });
                }
                
                return reward;
            }

            function showAnimatedCrateOpening(crateType, level, reward, cost) {
                // Close crates modal first
                closeCratesModal();
                
                // Set up result modal content
                document.getElementById('result-crate-name').textContent = 
                    `${crateType.charAt(0).toUpperCase() + crateType.slice(1)} Crate L${level}`;
                
                // Set crate sprite
                const spriteImg = document.querySelector('#result-sprite img');
                const spriteSrc = level === 1 ? './sprites/smallcrate.png' : './sprites/bigcrate.png';
                spriteImg.src = spriteSrc;
                spriteImg.alt = `${crateType.charAt(0).toUpperCase() + crateType.slice(1)} Crate L${level}`;
                
                // Calculate monetary values using the game's pricing system
                const resourcePrices = {
                    'Steel': 1,
                    'coins': 5,
                    'gold': 2,
                    'oil': 20
                };
                
                // Calculate cost value
                let costValue = 0;
                Object.entries(cost).forEach(([resource, amount]) => {
                    const price = resourcePrices[resource] || 0;
                    costValue += amount * price;
                });
                
                // Calculate reward value
                let rewardValue = 0;
                Object.entries(reward).forEach(([resource, amount]) => {
                    const price = resourcePrices[resource] || 0;
                    rewardValue += amount * price;
                });
                
                const profit = rewardValue - costValue;
                
                // Display rewards with monetary values
                const rewardDisplay = document.getElementById('reward-display');
                rewardDisplay.innerHTML = '';
                
                Object.entries(reward).forEach(([resource, amount]) => {
                    const price = resourcePrices[resource] || 0;
                    const value = amount * price;
                    const rewardItem = document.createElement('div');
                    rewardItem.className = `reward-item ${resource === 'oil' ? 'oil' : ''}`;
                    rewardItem.innerHTML = `
                        <div class="reward-label">${resource.toUpperCase()}</div>
                        <div class="reward-amount">+${amount.toLocaleString()}</div>
                        <div class="reward-value">${value.toLocaleString()} VALUE</div>
                    `;
                    rewardDisplay.appendChild(rewardItem);
                });
                
                // Show result message with monetary value
                const resultMessage = document.getElementById('result-message');
                if (profit > 0) {
                    resultMessage.className = 'result-message result-win';
                    resultMessage.textContent = `🎉 PROFIT: +${profit.toLocaleString()} VALUE!`;
                } else if (profit < 0) {
                    resultMessage.className = 'result-message result-loss';
                    resultMessage.textContent = `😞 LOSS: ${Math.abs(profit).toLocaleString()} VALUE`;
                } else {
                    resultMessage.className = 'result-message result-break-even';
                    resultMessage.textContent = `⚖️ BREAK EVEN`;
                }
                
                // Show result modal
                document.getElementById('crate-result-modal').style.display = 'flex';
            }
            
            function closeCrateResultModal() {
                document.getElementById('crate-result-modal').style.display = 'none';
            }

            function updateResourceValues() {
                // Update displayed values
                const steelValue = document.getElementById('steel-slider').value;
                const coinsValue = document.getElementById('coins-slider').value;
                const goldValue = document.getElementById('gold-slider').value;
                const oilValue = document.getElementById('oil-slider').value;
                
                document.getElementById('steel-value').textContent = steelValue;
                document.getElementById('coins-value').textContent = coinsValue;
                document.getElementById('gold-value').textContent = goldValue;
                document.getElementById('oil-value').textContent = oilValue;

                // Force DOM update
                document.getElementById('steel-value').offsetHeight;
                document.getElementById('coins-value').offsetHeight;
                document.getElementById('gold-value').offsetHeight;
                document.getElementById('oil-value').offsetHeight;

                resourceSelection = {
                    Steel: parseInt(steelValue) || 0,
                    coins: parseInt(coinsValue) || 0,
                    gold: parseInt(goldValue) || 0,
                    oil: parseInt(oilValue) || 0
                };
            }

            function selectAllResources() {
                document.getElementById('steel-slider').value = document.getElementById('steel-slider').max;
                document.getElementById('coins-slider').value = document.getElementById('coins-slider').max;
                document.getElementById('gold-slider').value = document.getElementById('gold-slider').max;
                document.getElementById('oil-slider').value = document.getElementById('oil-slider').max;
                updateResourceValues();
            }

            function selectHalfResources() {
                document.getElementById('steel-slider').value = Math.floor(document.getElementById('steel-slider').max / 2);
                document.getElementById('coins-slider').value = Math.floor(document.getElementById('coins-slider').max / 2);
                document.getElementById('gold-slider').value = Math.floor(document.getElementById('gold-slider').max / 2);
                document.getElementById('oil-slider').value = Math.floor(document.getElementById('oil-slider').max / 2);
                updateResourceValues();
            }

            function confirmResourceSelection() {
                gameState.storedResources.Steel -= resourceSelection.Steel;
                gameState.storedResources.coins -= resourceSelection.coins;
                gameState.storedResources.gold -= resourceSelection.gold;
                gameState.storedResources.oil -= resourceSelection.oil;

                gameState.enterZone(selectedZoneType);

                gameState.resources = { ...resourceSelection };

                closeResourceSelection();
                hideHomescreen();
                showNotification(`Entered ${selectedZoneType.toUpperCase()} ZONE with selected resources`, 12, 7, 'success');
            }

            document.addEventListener('DOMContentLoaded', function () {
                document.querySelectorAll('.resource-slider').forEach(slider => {
                    slider.addEventListener('input', updateResourceValues);
                });

                setTimeout(initializeFolderTooltips, 500);
            });

            function initializeFolderTooltips() {
                console.log('Initializing folder tooltips...');
                const buttons = document.querySelectorAll('.dropdown-btn');
                console.log('Found', buttons.length, 'dropdown buttons');

                buttons.forEach((button, index) => {
                    const costElement = button.querySelector('span:last-child');
                    console.log('Button', index, 'cost element:', costElement, 'text:', costElement?.textContent);

                    if (costElement && costElement.textContent && costElement.textContent.trim()) {
                        console.log('Adding click handler to button', index);
                        costElement.dataset.fullCost = costElement.textContent;

                        costElement.addEventListener('click', function (e) {
                            e.stopPropagation();
                            console.log('Cost clicked:', e.target.dataset.fullCost);
                            showFullCostPopup(e.target, e.target.dataset.fullCost);
                        });
                    }
                });
            }

            function showFullCostPopup(element, fullText) {
                console.log('Showing full cost popup for:', fullText);

                hideFullCostPopup();

                const popup = document.createElement('div');
                popup.className = 'full-cost-popup';
                popup.id = 'full-cost-popup';
                popup.textContent = fullText;

                const rect = element.getBoundingClientRect();
                popup.style.left = (rect.left + rect.width / 2 - 100) + 'px';
                popup.style.top = (rect.bottom + 10) + 'px';

                document.body.appendChild(popup);

                setTimeout(() => {
                    popup.classList.add('show');
                }, 10);

                setTimeout(() => {
                    hideFullCostPopup();
                }, 3000);
            }

            function hideFullCostPopup() {
                console.log('Hiding full cost popup');
                const existingPopup = document.getElementById('full-cost-popup');
                if (existingPopup) {
                    existingPopup.classList.remove('show');
                    setTimeout(() => {
                        if (existingPopup.parentNode) {
                            existingPopup.parentNode.removeChild(existingPopup);
                            console.log('Popup removed');
                        }
                    }, 200);
                }
            }
            window.debugTooltips = {
                init: initializeFolderTooltips,
                show: showFullCostPopup,
                hide: hideFullCostPopup
            };

            window.initializeFolderTooltips = initializeFolderTooltips;
            window.showFullCostPopup = showFullCostPopup;
            window.hideFullCostPopup = hideFullCostPopup;

            function initializeWiki() {
                setupWikiEventListeners();
            }

            function setupWikiEventListeners() {
                const searchInput = document.getElementById('wiki-search-input');
                const searchBtn = document.getElementById('wiki-search-btn');

                if (searchInput) {
                    searchInput.addEventListener('focus', function () {
                        wikiSearch();
                    });
                }

                const searchModalInput = document.getElementById('search-modal-input');
                const searchModalBtn = document.getElementById('search-modal-btn');

                if (searchModalInput) {
                    searchModalInput.addEventListener('input', debounce(function () {
                        performSearch(this.value.trim());
                    }, 300));

                    searchModalInput.addEventListener('keypress', function (e) {
                        if (e.key === 'Enter') {
                            performSearch(this.value.trim());
                        }
                    });
                }

                if (searchModalBtn) {
                    searchModalBtn.addEventListener('click', function () {
                        const input = document.getElementById('search-modal-input');
                        if (input) {
                            performSearch(input.value.trim());
                        }
                    });
                }

                if (searchBtn) {
                    searchBtn.addEventListener('click', wikiSearch);
                }

                const pageItems = document.querySelectorAll('.wiki-page-item');
                pageItems.forEach(item => {
                    item.addEventListener('click', function () {
                        const targetId = this.getAttribute('data-target');
                        showWikiPage(targetId);
                    });
                });

                const quickLinks = document.querySelectorAll('.quick-link-btn');
                quickLinks.forEach(btn => {
                    btn.addEventListener('click', function () {
                        const targetId = this.getAttribute('data-target');
                        showWikiPage(targetId);
                    });
                });
            }

            function openWikiModal() {
                const wikiModal = document.getElementById('wiki-modal');
                if (wikiModal) {
                    wikiModal.classList.add('active');
                    showWikiHome();
                    const searchInput = document.getElementById('wiki-search-input');
                    if (searchInput) {
                        searchInput.value = '';
                    }
                }
            }

            function closeWikiModal() {
                const wikiModal = document.getElementById('wiki-modal');
                if (wikiModal) {
                    wikiModal.classList.remove('active');
                }
            }

            function showWikiHome() {
                document.querySelectorAll('.wiki-article-content').forEach(article => {
                    article.classList.remove('active');
                });

                const homeContent = document.getElementById('wiki-home-content');
                if (homeContent) {
                    homeContent.classList.add('active');
                }

                document.querySelectorAll('.wiki-page-item').forEach(item => {
                    item.classList.remove('active');
                });
            }

            function showWikiPage(targetId) {
                document.querySelectorAll('.wiki-article-content').forEach(article => {
                    article.classList.remove('active');
                });

                const targetArticle = document.getElementById(targetId);
                if (targetArticle) {
                    targetArticle.classList.add('active');
                }

                document.querySelectorAll('.wiki-page-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.getAttribute('data-target') === targetId) {
                        item.classList.add('active');
                    }
                });
            }

            function wikiSearch() {
                openSearchModal();
            }

            function openSearchModal() {
                const searchModal = document.getElementById('wiki-search-modal');
                if (searchModal) {
                    searchModal.classList.add('active');

                    const searchInput = document.getElementById('search-modal-input');
                    if (searchInput) {
                        searchInput.value = '';
                        setTimeout(() => searchInput.focus(), 100);
                    }

                    showSearchPlaceholder();
                }
            }

            function closeSearchModal() {
                const searchModal = document.getElementById('wiki-search-modal');
                if (searchModal) {
                    searchModal.classList.remove('active');
                }
            }

            function performSearch(searchTerm) {
                if (!searchTerm) {
                    showSearchPlaceholder();
                    return;
                }

                const articles = document.querySelectorAll('.wiki-article-content:not(#wiki-home-content)');
                const results = [];

                articles.forEach(article => {
                    const articleId = article.id;
                    const articleElement = article.querySelector('.wiki-article');

                    if (!articleElement) return;

                    const titleElement = articleElement.querySelector('h1');
                    const title = titleElement ? titleElement.textContent : '';
                    const titleMatch = title.toLowerCase().includes(searchTerm);

                    const searchableElements = articleElement.querySelectorAll('h2, h3, p, li');
                    let contentMatches = [];
                    let excerpts = [];

                    searchableElements.forEach(element => {
                        const text = element.textContent.toLowerCase();
                        if (text.includes(searchTerm)) {
                            contentMatches.push({
                                element: element.tagName,
                                text: element.textContent.trim()
                            });

                            const excerpt = getContextAroundMatch(element.textContent, searchTerm);
                            if (!excerpts.includes(excerpt) && excerpts.length < 2) {
                                excerpts.push(excerpt);
                            }
                        }
                    });

                    if (titleMatch || contentMatches.length > 0) {
                        results.push({
                            id: articleId,
                            title: title,
                            excerpts: excerpts,
                            matchCount: contentMatches.length
                        });
                    }
                });

                showSearchModalResults(results, searchTerm);
            }

            function showSearchModalResults(results, searchTerm) {
                const container = document.getElementById('search-results-container');
                if (!container) return;

                if (results.length === 0) {
                    container.innerHTML = `
                        <div class="search-no-results">
                            <div class="no-results-icon"><i class="fas fa-search"></i></div>
                            <div class="no-results-text">No results found for "${searchTerm}"</div>
                            <div class="no-results-subtext">Try different keywords or browse all articles</div>
                        </div>
                    `;
                } else {
                    let resultsHTML = `<div class="search-results-list">`;

                    results.forEach(result => {
                        const excerptText = result.excerpts.join(' ... ') || 'No preview available';

                        resultsHTML += `
                            <div class="search-result-card" onclick="selectSearchResult('${result.id}')">
                                <div class="search-result-title">${result.title}</div>
                                <div class="search-result-excerpt">${excerptText}</div>
                                <div class="search-result-meta">
                                    <span>${result.matchCount} match${result.matchCount !== 1 ? 'es' : ''}</span>
                                    <span class="search-result-match-count">${result.matchCount}</span>
                                </div>
                            </div>
                        `;
                    });

                    resultsHTML += `</div>`;
                    container.innerHTML = resultsHTML;
                }
            }

            function showSearchPlaceholder() {
                const container = document.getElementById('search-results-container');
                if (container) {
                    container.innerHTML = `
                        <div class="search-placeholder">
                            <div class="search-icon"><i class="fas fa-search"></i></div>
                            <div class="search-instruction">Type to search through wiki articles</div>
                        </div>
                    `;
                }
            }

            function selectSearchResult(articleId) {
                closeSearchModal();

                closeWikiModal();

                setTimeout(() => {
                    openWikiModal();
                    setTimeout(() => {
                        showWikiPage(articleId);
                    }, 100);
                }, 300);
            }

            function getContextAroundMatch(text, searchTerm, contextLength = 60) {
                const lowerText = text.toLowerCase();
                const searchTermIndex = lowerText.indexOf(searchTerm.toLowerCase());

                if (searchTermIndex === -1) return text.substring(0, contextLength) + '...';

                const start = Math.max(0, searchTermIndex - contextLength / 2);
                const end = Math.min(text.length, searchTermIndex + searchTerm.length + contextLength / 2);

                let context = text.substring(start, end);
                if (start > 0) context = '...' + context;
                if (end < text.length) context = context + '...';

                return context;
            }

            function showSearchResults(results, searchTerm) {
                console.log("Showing search results:", results.length, "results for:", searchTerm);
                const dropdown = createSearchDropdown();
                const dropdownList = dropdown.querySelector('.search-dropdown-list');

                if (!dropdownList) {
                    console.error("Dropdown list not found!");
                    return;
                }

                if (results.length === 0) {
                    dropdownList.innerHTML = `
                        <div class="search-no-results">
                            <div class="no-results-icon"><i class="fas fa-search"></i></div>
                            <div class="no-results-text">No results found for "${searchTerm}"</div>
                            <div class="no-results-subtext">Try different keywords or browse articles</div>
                        </div>
                    `;
                } else {
                    let resultsHTML = `<div class="search-results-count">${results.length} result${results.length !== 1 ? 's' : ''} found</div>`;

                    results.forEach(result => {
                        resultsHTML += `
                            <div class="search-result-item" onclick="showWikiPage('${result.id}'); hideSearchDropdown();">
                                <div class="search-result-title">${result.title}</div>
                                <div class="search-result-matches">
                        `;

                        result.matches.forEach(match => {
                            resultsHTML += `
                                <div class="search-match">
                                    <span class="match-type">${getElementTypeLabel(match.element)}:</span>
                                    <span class="match-text">${highlightSearchTerm(match.context, searchTerm)}</span>
                                </div>
                            `;
                        });

                        if (result.matchCount > result.matches.length) {
                            resultsHTML += `<div class="more-matches">...and ${result.matchCount - result.matches.length} more matches</div>`;
                        }

                        resultsHTML += `</div></div>`;
                    });

                    dropdownList.innerHTML = resultsHTML;
                }

                dropdown.style.display = 'block';
                console.log("Dropdown should now be visible");
            }

            function getElementTypeLabel(elementType) {
                const labels = {
                    'H1': 'Title',
                    'H2': 'Section',
                    'H3': 'Subsection',
                    'P': 'Paragraph',
                    'LI': 'List Item'
                };
                return labels[elementType] || elementType;
            }

            function highlightSearchTerm(text, searchTerm) {
                const regex = new RegExp(`(${searchTerm})`, 'gi');
                return text.replace(regex, '<mark>$1</mark>');
            }

            function createSearchDropdown() {
                let dropdown = document.getElementById('wiki-search-dropdown');

                if (!dropdown) {
                    dropdown = document.createElement('div');
                    dropdown.id = 'wiki-search-dropdown';
                    dropdown.className = 'wiki-search-dropdown';
                    dropdown.innerHTML = `
                        <div class="search-dropdown-list"></div>
                    `;

                    const searchContainer = document.querySelector('.wiki-search');
                    if (searchContainer) {
                        searchContainer.parentNode.insertBefore(dropdown, searchContainer.nextSibling);
                        console.log("Dropdown created and inserted");
                    } else {
                        console.error("Search container not found!");
                    }
                } else {
                    console.log("Using existing dropdown");
                }

                return dropdown;
            }

            function hideSearchDropdown() {
                const dropdown = document.getElementById('wiki-search-dropdown');
                if (dropdown) {
                    dropdown.style.display = 'none';
                }
            }

            function getExcerpt(content, searchTerm, maxLength = 150) {
                const cleanContent = content.replace(/<[^>]*>/g, ' ');
                const lowerContent = cleanContent.toLowerCase();
                const searchTermIndex = lowerContent.indexOf(searchTerm);

                if (searchTermIndex === -1) return cleanContent.substring(0, maxLength) + '...';

                const start = Math.max(0, searchTermIndex - 50);
                const end = Math.min(cleanContent.length, searchTermIndex + maxLength);

                let excerpt = cleanContent.substring(start, end);
                if (start > 0) excerpt = '...' + excerpt;
                if (end < cleanContent.length) excerpt = excerpt + '...';

                return excerpt;
            }

            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            window.openWikiModal = openWikiModal;
            window.closeWikiModal = closeWikiModal;
            window.showWikiPage = showWikiPage;
            window.wikiSearch = wikiSearch;
            window.openSearchModal = openSearchModal;
            window.closeSearchModal = closeSearchModal;
            window.performSearch = performSearch;
            window.selectSearchResult = selectSearchResult;

            // Combat System Functions
            let combatState = {
                playerUnits: [],
                fortressUnits: [],
                fortressHealth: 100,
                maxFortressHealth: 100,
                campfireActive: false,
                battleLog: [],
                playerAction: null,
                fortressAction: null
            };

            function openCombatMenu() {
                const combatMenu = document.getElementById('combat-menu');
                if (combatMenu) {
                    combatMenu.classList.add('active');
                    populateCombatArmySelector();
                    setupCombatMenuEventListeners();
                    updateCombatMenuResources();
                }
            }

            function updateCombatMenuResources() {
                const oilCountElement = document.getElementById('combat-oil-count');
                if (oilCountElement && gameState.resources) {
                    oilCountElement.textContent = gameState.resources.oil || 0;
                }
            }

            function setupCombatMenuEventListeners() {
                // Set up start combat button event listener
                const startCombatBtn = document.getElementById('start-combat-btn');
                if (startCombatBtn) {
                    // Remove any existing event listeners by cloning
                    const newStartBtn = startCombatBtn.cloneNode(true);
                    startCombatBtn.parentNode.replaceChild(newStartBtn, startCombatBtn);
                    newStartBtn.addEventListener('click', startCombat);
                }
            }

            function closeCombatMenu() {
                const combatMenu = document.getElementById('combat-menu');
                if (combatMenu) {
                    combatMenu.classList.remove('active');
                }
                resetCombatSelection();
            }

            function populateCombatArmySelector() {
                const selector = document.getElementById('combat-army-selector');
                if (!selector) return;

                const storedUnits = gameState.storedArmyUnits || [];
                selector.innerHTML = '';

                if (storedUnits.length === 0) {
                    selector.innerHTML = '<p class="no-army-message">No army units available for combat.</p>';
                    document.getElementById('start-combat-btn').disabled = true;
                    return;
                }

                // Group units by type
                const unitGroups = {};
                storedUnits.forEach(unit => {
                    if (!unitGroups[unit.subtype]) {
                        unitGroups[unit.subtype] = [];
                    }
                    unitGroups[unit.subtype].push(unit);
                });

                // Create selectors for each unit type
                Object.keys(unitGroups).forEach(unitType => {
                    const unitGroup = unitGroups[unitType];
                    const selectorItem = createCombatUnitSelector(unitType, unitGroup);
                    selector.appendChild(selectorItem);
                });

                updateStartCombatButton();
            }

            function createCombatUnitSelector(unitType, units) {
                const container = document.createElement('div');
                container.className = 'combat-unit-selector';
                container.dataset.unitType = unitType;

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'combat-unit-checkbox';
                checkbox.addEventListener('change', function() {
                    const amountInput = container.querySelector('.unit-amount-input');
                    if (this.checked) {
                        amountInput.disabled = false;
                        amountInput.value = Math.min(3, units.length); // Default to 3 units
                    } else {
                        amountInput.disabled = true;
                        amountInput.value = 0;
                    }
                    updateStartCombatButton();
                });

                const iconDiv = document.createElement('div');
                iconDiv.className = 'combat-unit-icon';
                const img = document.createElement('img');
                img.src = getSpriteForArmyType(unitType);
                img.alt = unitType;
                img.onerror = function() {
                    this.src = './sprites/soldier.png';
                };
                iconDiv.appendChild(img);

                const infoDiv = document.createElement('div');
                infoDiv.className = 'combat-unit-info';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'combat-unit-name';
                nameDiv.textContent = getBuildingName({ type: 'army', subtype: unitType });
                
                const statsDiv = document.createElement('div');
                statsDiv.className = 'combat-unit-stats';
                
                // Get average stats for this unit type
                const avgHealth = Math.round(units.reduce((sum, u) => sum + u.health, 0) / units.length);
                const avgMaxHealth = Math.round(units.reduce((sum, u) => sum + u.maxHealth, 0) / units.length);
                const avgDamage = Math.round(units.reduce((sum, u) => sum + (u.damage || 1), 0) / units.length);
                const avgRange = Math.round(units.reduce((sum, u) => sum + u.range, 0) / units.length);
                const avgMovement = Math.round(units.reduce((sum, u) => sum + u.movement, 0) / units.length);
                
                statsDiv.innerHTML = `
                    <span class="combat-unit-stat">HP: ${avgHealth}/${avgMaxHealth}</span>
                    <span class="combat-unit-stat">DMG: ${avgDamage}</span>
                    <span class="combat-unit-stat">Range: ${avgRange}</span>
                    <span class="combat-unit-stat">Move: ${avgMovement}</span>
                    <span class="combat-unit-stat">Count: ${units.length}</span>
                `;
                
                infoDiv.appendChild(nameDiv);
                infoDiv.appendChild(statsDiv);

                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'combat-unit-controls';
                
                const amountControl = document.createElement('div');
                amountControl.className = 'unit-amount-control';
                
                const minusBtn = document.createElement('button');
                minusBtn.className = 'amount-btn';
                minusBtn.textContent = '-';
                minusBtn.addEventListener('click', function() {
                    const input = amountControl.querySelector('.unit-amount-input');
                    const currentValue = parseInt(input.value) || 0;
                    if (currentValue > 0) {
                        input.value = currentValue - 1;
                        if (input.value == 0) {
                            checkbox.checked = false;
                            input.disabled = true;
                        }
                        updateStartCombatButton();
                    }
                });
                
                const amountInput = document.createElement('input');
                amountInput.type = 'number';
                amountInput.className = 'unit-amount-input';
                amountInput.min = '0';
                amountInput.max = units.length.toString();
                amountInput.value = '0';
                amountInput.disabled = true;
                amountInput.addEventListener('input', function() {
                    let value = parseInt(this.value) || 0;
                    if (value < 0) value = 0;
                    if (value > units.length) value = units.length;
                    this.value = value;
                    if (value > 0 && !checkbox.checked) {
                        checkbox.checked = true;
                        this.disabled = false;
                    } else if (value === 0) {
                        checkbox.checked = false;
                        this.disabled = true;
                    }
                    updateStartCombatButton();
                });
                
                const plusBtn = document.createElement('button');
                plusBtn.className = 'amount-btn';
                plusBtn.textContent = '+';
                plusBtn.addEventListener('click', function() {
                    const input = amountControl.querySelector('.unit-amount-input');
                    const currentValue = parseInt(input.value) || 0;
                    if (currentValue < units.length) {
                        input.value = currentValue + 1;
                        if (!checkbox.checked) {
                            checkbox.checked = true;
                            input.disabled = false;
                        }
                        updateStartCombatButton();
                    }
                });
                
                amountControl.appendChild(minusBtn);
                amountControl.appendChild(amountInput);
                amountControl.appendChild(plusBtn);
                controlsDiv.appendChild(amountControl);

                container.appendChild(checkbox);
                container.appendChild(iconDiv);
                container.appendChild(infoDiv);
                container.appendChild(controlsDiv);

                return container;
            }

            function updateStartCombatButton() {
                const selectors = document.querySelectorAll('.combat-unit-selector');
                let totalSelected = 0;
                
                selectors.forEach(selector => {
                    const checkbox = selector.querySelector('.combat-unit-checkbox');
                    const amountInput = selector.querySelector('.unit-amount-input');
                    if (checkbox.checked) {
                        totalSelected += parseInt(amountInput.value) || 0;
                    }
                });
                
                const startBtn = document.getElementById('start-combat-btn');
                startBtn.disabled = totalSelected === 0;
            }

            function resetCombatSelection() {
                const selectors = document.querySelectorAll('.combat-unit-selector');
                selectors.forEach(selector => {
                    const checkbox = selector.querySelector('.combat-unit-checkbox');
                    const amountInput = selector.querySelector('.unit-amount-input');
                    checkbox.checked = false;
                    amountInput.disabled = true;
                    amountInput.value = '0';
                });
                document.getElementById('start-combat-btn').disabled = true;
            }

            function startCombat() {
                // Collect selected units with stacking
                const selectedUnits = [];
                const unitCounts = {}; // Track how many of each type selected
                const selectors = document.querySelectorAll('.combat-unit-selector');
                
                selectors.forEach(selector => {
                    const checkbox = selector.querySelector('.combat-unit-checkbox');
                    const amountInput = selector.querySelector('.unit-amount-input');
                    const unitType = selector.dataset.unitType;
                    
                    if (checkbox.checked) {
                        const amount = parseInt(amountInput.value) || 0;
                        if (amount > 0) {
                            unitCounts[unitType] = amount;
                            
                            // Get units of this type from stored army
                            const storedUnits = gameState.storedArmyUnits || [];
                            const typeUnits = storedUnits.filter(u => u.subtype === unitType);
                            
                            // Add one representative unit with count info
                            if (typeUnits.length > 0) {
                                const representativeUnit = {
                                    ...typeUnits[0],
                                    currentHealth: typeUnits[0].health,
                                    unitCount: amount,
                                    originalTypeUnits: typeUnits.slice(0, amount) // Store originals for removal
                                };
                                selectedUnits.push(representativeUnit);
                            }
                        }
                    }
                });

                if (selectedUnits.length === 0) {
                    showNotification('Select at least one unit to start combat!', 12, 7, 'warning');
                    return;
                }

                // Initialize combat state
                combatState.playerUnits = selectedUnits;
                combatState.unitCounts = unitCounts; // Store for loss calculation
                combatState.fortressUnits = [
                    { type: 'guard', health: 30, maxHealth: 30, damage: 8 },
                    { type: 'guard', health: 30, maxHealth: 30, damage: 8 }
                ];
                combatState.fortressHealth = 100;
                combatState.maxFortressHealth = 100;
                combatState.campfireActive = false;
                combatState.selectedUnitForAttack = null;
                combatState.currentTarget = null;
                combatState.battleLog = [{
                    turn: 0,
                    message: 'Battle started! Select a unit to attack with.',
                    type: 'system'
                }];

                // Remove selected units from stored army
                removeSelectedUnitsFromArmy(unitCounts);

                // Close menu and open battle
                closeCombatMenu();
                openCombatBattle();
            }

            function removeSelectedUnitsFromArmy(unitCounts) {
                const storedUnits = gameState.storedArmyUnits || [];
                
                Object.keys(unitCounts).forEach(unitType => {
                    const countToRemove = unitCounts[unitType];
                    let removed = 0;
                    
                    // Remove units from the end of the array
                    for (let i = storedUnits.length - 1; i >= 0 && removed < countToRemove; i--) {
                        if (storedUnits[i].subtype === unitType) {
                            storedUnits.splice(i, 1);
                            removed++;
                        }
                    }
                });
                
                updateArmyBoxDisplay();
            }

            function openCombatBattle() {
                const battleScreen = document.getElementById('combat-battle');
                if (battleScreen) {
                    battleScreen.classList.add('active');
                    setupCombatBattle();
                }
            }

            function exitCombat() {
                const battleScreen = document.getElementById('combat-battle');
                if (battleScreen) {
                    battleScreen.classList.remove('active');
                }
                resetCombatState();
            }

            function resetCombatState() {
                combatState = {
                    playerUnits: [],
                    fortressUnits: [],
                    fortressHealth: 100,
                    maxFortressHealth: 100,
                    campfireActive: false,
                    battleLog: [],
                    playerAction: null,
                    fortressAction: null
                };
            }

            function setupCombatBattle() {
                updateCombatDisplay();
                setupCombatEventListeners();
                
                // Initially disable action buttons
                document.getElementById('combat-attack-btn').disabled = true;
                document.getElementById('combat-defend-btn').disabled = true;
                
                // Show initial visual instructions
                showCombatVisualInstructions();
            }

            function showCombatVisualInstructions() {
                // Add visual cues to guide the player
                const instructions = document.createElement('div');
                instructions.className = 'combat-instructions-overlay';
                instructions.innerHTML = `
                    <div class="instruction-step step-1">
                        <div class="instruction-text">CLICK A UNIT TO SELECT IT</div>
                    </div>
                    <button class="skip-tutorial-btn" onclick="skipTutorial()">SKIP TUTORIAL</button>
                `;
                
                const combatArena = document.querySelector('.combat-arena');
                if (combatArena) {
                    combatArena.appendChild(instructions);
                    
                    // Remove after first unit selection or timeout
                    setTimeout(() => {
                        if (instructions.parentNode) {
                            instructions.parentNode.removeChild(instructions);
                        }
                    }, 15000);
                }
            }

            function skipTutorial() {
                // Remove all tutorial overlays
                const tutorials = document.querySelectorAll('.combat-instructions-overlay');
                tutorials.forEach(tutorial => {
                    if (tutorial.parentNode) {
                        tutorial.parentNode.removeChild(tutorial);
                    }
                });
                
                // Clear any pending timeouts
                clearTimeout(window.tutorialTimeout);
                
                // Show confirmation
                addToBattleLog('Tutorial skipped. Click units to select, then targets to attack.', 'system');
            }

            function setupCombatEventListeners() {
                // Remove existing listeners first
                const attackBtn = document.getElementById('combat-attack-btn');
                const defendBtn = document.getElementById('combat-defend-btn');
                const campfireToggle = document.getElementById('campfire-toggle');
                const startCombatBtn = document.getElementById('start-combat-btn');
                
                // Clone and replace buttons to remove old event listeners
                if (attackBtn) {
                    const newAttackBtn = attackBtn.cloneNode(true);
                    attackBtn.parentNode.replaceChild(newAttackBtn, attackBtn);
                    newAttackBtn.addEventListener('click', function() {
                        executePlayerAction('attack');
                    });
                }
                
                if (defendBtn) {
                    const newDefendBtn = defendBtn.cloneNode(true);
                    defendBtn.parentNode.replaceChild(newDefendBtn, defendBtn);
                    newDefendBtn.addEventListener('click', function() {
                        executePlayerAction('defend');
                    });
                }
                
                if (campfireToggle) {
                    const newCampfireToggle = campfireToggle.cloneNode(true);
                    campfireToggle.parentNode.replaceChild(newCampfireToggle, campfireToggle);
                    newCampfireToggle.addEventListener('click', toggleCampfire);
                }
                
                if (startCombatBtn) {
                    const newStartBtn = startCombatBtn.cloneNode(true);
                    startCombatBtn.parentNode.replaceChild(newStartBtn, startCombatBtn);
                    newStartBtn.addEventListener('click', startCombat);
                }
                
                // Set up fortress and guard click handlers
                setupTargetClickHandlers();
            }

            function setupTargetClickHandlers() {
                // Add click handlers for fortress targets
                const fortressDisplay = document.querySelector('.fortress-display');
                const fortressUnitsContainer = document.getElementById('fortress-units-combat');
                
                if (fortressDisplay) {
                    fortressDisplay.addEventListener('click', function() {
                        if (combatState.selectedUnitForAttack) {
                            selectTarget('fortress');
                        }
                    });
                    fortressDisplay.style.cursor = 'pointer';
                }
                
                // Add click handlers for guard units
                if (fortressUnitsContainer) {
                    fortressUnitsContainer.addEventListener('click', function(e) {
                        const unitElement = e.target.closest('.combat-unit-display');
                        if (unitElement && combatState.selectedUnitForAttack) {
                            // Find which guard was clicked
                            const guardIndex = Array.from(fortressUnitsContainer.children).indexOf(unitElement);
                            if (guardIndex >= 0 && combatState.fortressUnits[guardIndex] && 
                                combatState.fortressUnits[guardIndex].health > 0) {
                                selectTarget('guard', guardIndex);
                            }
                        }
                    });
                }
            }

            function selectUnitForAttack(unit) {
                // Clear previous selection
                document.querySelectorAll('.combat-unit-display').forEach(el => {
                    el.style.border = '';
                    el.style.boxShadow = '';
                    el.classList.remove('selected-unit');
                });
                
                // Highlight selected unit
                event.currentTarget.style.border = '3px solid #66d9ff';
                event.currentTarget.style.boxShadow = '0 0 15px rgba(102, 217, 255, 0.7)';
                event.currentTarget.classList.add('selected-unit');
                
                combatState.selectedUnitForAttack = unit;
                
                // Show target selection instructions
                showTargetInstructions();
                
                addToBattleLog(`Selected ${getBuildingName({ type: 'army', subtype: unit.subtype })} for attack. Now click on fortress or a guard to target.`, 'system');
                updateCombatDisplay();
            }

            function showTargetInstructions() {
                // Remove existing instructions
                const existingInstructions = document.querySelector('.combat-instructions-overlay');
                if (existingInstructions) {
                    existingInstructions.remove();
                }
                
                // Add target selection instructions
                const instructions = document.createElement('div');
                instructions.className = 'combat-instructions-overlay';
                instructions.innerHTML = `
                    <div class="instruction-step step-2">
                        <div class="instruction-text">NOW CLICK THE FORTRESS OR A GUARD TO TARGET</div>
                    </div>
                `;
                
                const combatArena = document.querySelector('.combat-arena');
                if (combatArena) {
                    combatArena.appendChild(instructions);
                }
            }

            function selectTarget(targetType, targetIndex = null) {
                console.log('selectTarget called with:', targetType, targetIndex);
                combatState.currentTarget = { type: targetType, index: targetIndex };
                
                let targetName = '';
                if (targetType === 'fortress') {
                    targetName = 'Fortress';
                } else if (targetType === 'guard') {
                    targetName = `Fortress Guard ${targetIndex + 1}`;
                }
                
                // Show action button instructions
                showActionButtonInstructions();
                
                addToBattleLog(`Target selected: ${targetName}. Now click ATTACK or DEFEND.`, 'system');
                
                // Enable action buttons with visual highlight
                const attackBtn = document.getElementById('combat-attack-btn');
                const defendBtn = document.getElementById('combat-defend-btn');
                
                console.log('Enabling buttons...');
                console.log('Attack button before:', attackBtn.disabled);
                console.log('Defend button before:', defendBtn.disabled);
                
                attackBtn.disabled = false;
                defendBtn.disabled = false;
                
                console.log('Attack button after:', attackBtn.disabled);
                console.log('Defend button after:', defendBtn.disabled);
                
                // Add pulsing effect to buttons
                attackBtn.classList.add('pulse-highlight');
                defendBtn.classList.add('pulse-highlight');
                
                // Remove pulse after delay
                setTimeout(() => {
                    attackBtn.classList.remove('pulse-highlight');
                    defendBtn.classList.remove('pulse-highlight');
                }, 3000);
                
                updateCombatDisplay();
            }

            function showActionButtonInstructions() {
                // Remove existing instructions
                const existingInstructions = document.querySelector('.combat-instructions-overlay');
                if (existingInstructions) {
                    existingInstructions.remove();
                }
                
                // Add action button instructions
                const instructions = document.createElement('div');
                instructions.className = 'combat-instructions-overlay';
                instructions.innerHTML = `
                    <div class="instruction-step step-3">
                        <div class="instruction-text">CLICK ATTACK OR DEFEND TO ACT</div>
                    </div>
                `;
                
                const combatArena = document.querySelector('.combat-arena');
                if (combatArena) {
                    combatArena.appendChild(instructions);
                    
                    // Remove instructions after action is taken
                    setTimeout(() => {
                        if (instructions.parentNode) {
                            instructions.parentNode.removeChild(instructions);
                        }
                    }, 8000);
                }
            }

            function updateCombatDisplay() {
                // Update fortress health display
                document.getElementById('fortress-health').textContent = 
                    `${combatState.fortressHealth}/${combatState.maxFortressHealth}`;
                
                // Update health bar
                const healthPercent = (combatState.fortressHealth / combatState.maxFortressHealth) * 100;
                const fortressHealthBar = document.getElementById('fortress-health-bar');
                fortressHealthBar.style.width = healthPercent + '%';
                
                // Add low health styling when below 30%
                if (healthPercent < 30) {
                    fortressHealthBar.classList.add('low');
                } else {
                    fortressHealthBar.classList.remove('low');
                }
                
                // Update player units display
                const playerUnitsContainer = document.getElementById('player-units-combat');
                playerUnitsContainer.innerHTML = '';
                combatState.playerUnits.forEach(unit => {
                    const unitElement = createCombatUnitDisplay(unit, 'player');
                    playerUnitsContainer.appendChild(unitElement);
                });
                
                // Update fortress units display
                const fortressUnitsContainer = document.getElementById('fortress-units-combat');
                fortressUnitsContainer.innerHTML = '';
                combatState.fortressUnits.forEach(unit => {
                    if (unit.health > 0) {
                        const unitElement = createCombatUnitDisplay(unit, 'fortress');
                        fortressUnitsContainer.appendChild(unitElement);
                    }
                });
                
                // Update campfire status
                const campfireToggle = document.getElementById('campfire-toggle');
                const campfireSpan = campfireToggle.querySelector('span');
                if (combatState.campfireActive) {
                    campfireToggle.classList.add('active');
                    campfireSpan.textContent = 'CAMPFIRE: ON';
                } else {
                    campfireToggle.classList.remove('active');
                    campfireSpan.textContent = 'CAMPFIRE: OFF';
                }
                
                // Update battle log
                updateBattleLog();
            }

            function createCombatUnitDisplay(unit, side) {
                const container = document.createElement('div');
                container.className = 'combat-unit-display';
                
                // Add click handler for player units
                if (side === 'player') {
                    container.addEventListener('click', function() {
                        selectUnitForAttack(unit);
                    });
                    container.style.cursor = 'pointer';
                }
                
                const iconDiv = document.createElement('div');
                iconDiv.className = 'combat-unit-display-icon';
                const img = document.createElement('img');
                
                if (side === 'player') {
                    img.src = getSpriteForArmyType(unit.subtype);
                    img.alt = unit.subtype;
                } else {
                    img.src = './sprites/defaultbad.png';
                    img.alt = 'Guard';
                }
                
                img.onerror = function() {
                    this.src = './sprites/soldier.png';
                };
                iconDiv.appendChild(img);
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'combat-unit-display-info';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'combat-unit-display-name';
                
                if (side === 'player') {
                    const baseName = getBuildingName({ type: 'army', subtype: unit.subtype });
                    nameDiv.textContent = unit.unitCount > 1 ? 
                        `${baseName} (×${unit.unitCount})` : baseName;
                } else {
                    nameDiv.textContent = 'Fortress Guard';
                }
                
                const healthDiv = document.createElement('div');
                healthDiv.className = 'combat-unit-display-health';
                
                if (side === 'player') {
                    healthDiv.textContent = `HP: ${unit.currentHealth || unit.health}/${unit.maxHealth}`;
                    
                    // Add damage information
                    const damageDiv = document.createElement('div');
                    damageDiv.className = 'combat-unit-damage-info';
                    
                    // Calculate base damage
                    const baseDamage = (unit.damage || 1) * unit.unitCount;
                    const displayDamage = baseDamage * 2; // Scale factor from combat calculation
                    
                    // Calculate boosted damage if campfire is active
                    let finalDamage = displayDamage;
                    let damageText = `DMG: ${displayDamage}`;
                    
                    if (combatState.campfireActive) {
                        finalDamage = Math.floor(displayDamage * 1.5);
                        damageText = `DMG: ${displayDamage} → ${finalDamage}`;
                    }
                    
                    damageDiv.textContent = damageText;
                    
                    // Style based on campfire status
                    if (combatState.campfireActive) {
                        damageDiv.style.color = '#ffa500'; // Orange for boosted damage
                        damageDiv.style.fontWeight = 'bold';
                        damageDiv.style.textShadow = '0 0 5px rgba(255, 165, 0, 0.5)';
                    } else {
                        damageDiv.style.color = '#dd7e77'; // Normal damage color
                    }
                    
                    damageDiv.style.fontSize = '0.85rem';
                    damageDiv.style.marginTop = '4px';
                    
                    healthDiv.appendChild(damageDiv);
                    
                    // Add stack indicator if multiple units
                    if (unit.unitCount > 1) {
                        const countIndicator = document.createElement('div');
                        countIndicator.className = 'unit-stack-indicator';
                        countIndicator.textContent = `${unit.unitCount} units`; 
                        countIndicator.style.fontSize = '0.8rem';
                        countIndicator.style.color = '#ceab77';
                        countIndicator.style.marginTop = '2px';
                        healthDiv.appendChild(countIndicator);
                    }
                } else {
                    healthDiv.textContent = `HP: ${unit.health}/${unit.maxHealth}`;
                }
                
                infoDiv.appendChild(nameDiv);
                infoDiv.appendChild(healthDiv);
                
                container.appendChild(iconDiv);
                container.appendChild(infoDiv);
                
                return container;
            }

            function updateBattleLog() {
                const logContainer = document.getElementById('combat-log');
                logContainer.innerHTML = '';
                
                combatState.battleLog.slice(-10).forEach(entry => {
                    const logEntry = document.createElement('div');
                    logEntry.className = 'log-entry ' + entry.type;
                    logEntry.textContent = entry.message;
                    logContainer.appendChild(logEntry);
                });
                
                logContainer.scrollTop = logContainer.scrollHeight;
            }

            function toggleCampfire() {
                if (gameState.resources.oil >= 100) { // Require 100 oil to activate
                    combatState.campfireActive = !combatState.campfireActive;
                    
                    const campfireToggle = document.getElementById('campfire-toggle');
                    const campfireSpan = campfireToggle.querySelector('span');
                    
                    if (combatState.campfireActive) {
                        gameState.resources.oil -= 100; // Cost 100 oil to activate
                        campfireToggle.classList.add('active');
                        campfireSpan.textContent = 'CAMPFIRE: ON';
                        addToBattleLog('🔥 Campfire activated! Costs 100 oil per attack. 50% damage boost.', 'system');
                        
                        // Add visual effect
                        campfireToggle.style.animation = 'pulse 0.5s 3';
                        setTimeout(() => {
                            campfireToggle.style.animation = '';
                        }, 1500);
                    } else {
                        campfireToggle.classList.remove('active');
                        campfireSpan.textContent = 'CAMPFIRE: OFF';
                        addToBattleLog('Campfire deactivated.', 'system');
                    }
                    
                    updateCombatDisplay();
                    updateDisplay(); // Update oil display
                } else {
                    showNotification('Need 100 oil to activate campfire!', 12, 7, 'warning');
                    
                    // Visual feedback for insufficient resources
                    const campfireToggle = document.getElementById('campfire-toggle');
                    campfireToggle.style.animation = 'shake 0.5s';
                    setTimeout(() => {
                        campfireToggle.style.animation = '';
                    }, 500);
                }
            }

            function executePlayerAction(action) {
                console.log('executePlayerAction called with:', action);
                console.log('Selected unit:', combatState.selectedUnitForAttack);
                console.log('Current target:', combatState.currentTarget);
                console.log('Campfire active:', combatState.campfireActive);
                
                if (!combatState.selectedUnitForAttack || !combatState.currentTarget) {
                    showNotification('Select a unit and target first!', 12, 7, 'warning');
                    return;
                }
                
                combatState.playerAction = action;
                
                // Fortress makes random choice
                combatState.fortressAction = Math.random() > 0.5 ? 'attack' : 'defend';
                
                // Resolve combat
                resolveCombatTurn();
                
                // Reset selections
                combatState.selectedUnitForAttack = null;
                combatState.currentTarget = null;
                
                // Disable action buttons until next selection
                const attackBtn = document.getElementById('combat-attack-btn');
                const defendBtn = document.getElementById('combat-defend-btn');
                
                if (attackBtn) attackBtn.disabled = true;
                if (defendBtn) defendBtn.disabled = true;
                
                // Clear highlights
                document.querySelectorAll('.combat-unit-display').forEach(el => {
                    el.style.border = '';
                    el.style.boxShadow = '';
                });
                
                // Check win/lose conditions
                checkCombatEndConditions();
            }

            function resolveCombatTurn() {
                console.log('resolveCombatTurn called');
                console.log('Player action:', combatState.playerAction);
                console.log('Fortress action:', combatState.fortressAction);
                console.log('Selected unit:', combatState.selectedUnitForAttack);
                console.log('Target:', combatState.currentTarget);
                console.log('Campfire active:', combatState.campfireActive);
                
                const playerAction = combatState.playerAction;
                const fortressAction = combatState.fortressAction;
                const selectedUnit = combatState.selectedUnitForAttack;
                const target = combatState.currentTarget;
                
                addToBattleLog(`Player chose to ${playerAction}`, 'player-action');
                addToBattleLog(`Fortress chose to ${fortressAction}`, 'fortress-action');
                
                // Calculate damage from selected unit stack (increased for better balance)
                let unitDamage = ((selectedUnit.damage || 1) * selectedUnit.unitCount) * 2; // Damage scales with unit count
                
                console.log('Base damage calculated:', unitDamage);
                
                // Campfire costs 100 oil per attack
                if (combatState.campfireActive) {
                    console.log('Campfire is active, checking oil...');
                    console.log('Available oil:', gameState.resources.oil);
                    
                    if (gameState.resources.oil >= 100) {
                        gameState.resources.oil -= 100;
                        unitDamage = Math.floor(unitDamage * 1.5); // 1.5x damage boost
                        addToBattleLog(`🔥 Campfire consumed 100 oil! Damage boosted.`, 'system');
                        updateDisplay(); // Update oil display
                        console.log('Campfire damage boost applied. New damage:', unitDamage);
                    } else {
                        // Not enough oil - campfire deactivates but attack proceeds normally
                        combatState.campfireActive = false;
                        const campfireToggle = document.getElementById('campfire-toggle');
                        const campfireSpan = campfireToggle.querySelector('span');
                        campfireToggle.classList.remove('active');
                        campfireSpan.textContent = 'CAMPFIRE: OFF';
                        addToBattleLog('Campfire deactivated - not enough oil! Attack proceeds without boost.', 'system');
                        console.log('Campfire deactivated due to insufficient oil');
                        // Attack continues with normal damage
                    }
                }
                
                // Resolve based on action combinations
                if (playerAction === 'attack' && fortressAction === 'attack') {
                    // Both attack - selected unit stack takes damage from fortress
                    const fortressDamage = calculateFortressDamage();
                    const unitsBefore = selectedUnit.unitCount;
                    applyDamageToSelectedUnit(selectedUnit, fortressDamage);
                    const unitsLost = unitsBefore - selectedUnit.unitCount;
                    
                    if (unitsLost > 0) {
                        addToBattleLog(`${getBuildingName({ type: 'army', subtype: selectedUnit.subtype })} stack lost ${unitsLost} unit(s)! Remaining: ${selectedUnit.unitCount}`, 'fortress-action');
                    } else {
                        addToBattleLog(`${getBuildingName({ type: 'army', subtype: selectedUnit.subtype })} took ${fortressDamage} damage! Health: ${selectedUnit.currentHealth}/${selectedUnit.health}`, 'fortress-action');
                    }
                    
                    // Check if entire stack is destroyed
                    if (selectedUnit.unitCount <= 0) {
                        addToBattleLog(`All ${getBuildingName({ type: 'army', subtype: selectedUnit.subtype })} units were destroyed!`, 'fortress-action');
                        removeDeadUnit(selectedUnit);
                    }
                } 
                else if (playerAction === 'attack' && fortressAction === 'defend') {
                    // Player attacks, fortress defends - damage target
                    if (target.type === 'fortress') {
                        applyDamageToFortress(unitDamage);
                        addToBattleLog(`Fortress took ${unitDamage} damage!`, 'player-action');
                    } else if (target.type === 'guard') {
                        const guard = combatState.fortressUnits[target.index];
                        guard.health -= unitDamage;
                        addToBattleLog(`Fortress Guard took ${unitDamage} damage!`, 'player-action');
                        
                        if (guard.health <= 0) {
                            addToBattleLog(`Fortress Guard was destroyed!`, 'player-action');
                        }
                    }
                }
                else if (playerAction === 'defend' && fortressAction === 'attack') {
                    // Player defends, fortress attacks - no effect
                    addToBattleLog('Player defended successfully!', 'player-action');
                }
                // Both defend - no effect
                
                // Reset actions for next turn
                combatState.playerAction = null;
                combatState.fortressAction = null;
                
                updateCombatDisplay();
            }

            function applyDamageToSelectedUnit(unit, damage) {
                // Apply damage to the stack of units
                let remainingDamage = damage;
                
                while (remainingDamage > 0 && unit.unitCount > 0) {
                    // Apply damage to current unit in stack
                    const damageToCurrentUnit = Math.min(remainingDamage, unit.currentHealth);
                    unit.currentHealth -= damageToCurrentUnit;
                    remainingDamage -= damageToCurrentUnit;
                    
                    // If current unit dies
                    if (unit.currentHealth <= 0) {
                        unit.unitCount--;
                        
                        // If there are more units in stack, bring next one to front
                        if (unit.unitCount > 0) {
                            unit.currentHealth = unit.health;
                        } else {
                            // No units left
                            unit.currentHealth = 0;
                            break;
                        }
                    }
                }
            }

            function removeDeadUnit(deadUnit) {
                combatState.playerUnits = combatState.playerUnits.filter(unit => unit !== deadUnit);
            }

            function calculatePlayerDamage() {
                let totalDamage = 0;
                let unitCount = 0;
                
                combatState.playerUnits.forEach(unit => {
                    if (unit.currentHealth > 0) {
                        unitCount++;
                        // Diminishing returns: each additional unit is 10% less effective
                        const effectiveness = Math.pow(0.9, unitCount - 1);
                        totalDamage += Math.floor(unit.damage * effectiveness);
                    }
                });
                
                // Cap at 10 units effectiveness
                return Math.min(totalDamage, combatState.playerUnits.slice(0, 10)
                    .reduce((sum, unit) => sum + unit.damage, 0));
            }

            function calculateFortressDamage() {
                return combatState.fortressUnits
                    .filter(unit => unit.health > 0)
                    .reduce((sum, unit) => sum + unit.damage, 0);
            }

            function applyDamageToPlayer(damage) {
                // Distribute damage among alive units
                const aliveUnits = combatState.playerUnits.filter(u => u.currentHealth > 0);
                if (aliveUnits.length === 0) return;
                
                const damagePerUnit = Math.floor(damage / aliveUnits.length);
                const remainder = damage % aliveUnits.length;
                
                aliveUnits.forEach((unit, index) => {
                    const unitDamage = damagePerUnit + (index < remainder ? 1 : 0);
                    unit.currentHealth = Math.max(0, unit.currentHealth - unitDamage);
                });
            }

            function applyDamageToFortress(damage) {
                combatState.fortressHealth = Math.max(0, combatState.fortressHealth - damage);
            }

            function addToBattleLog(message, type = 'system') {
                combatState.battleLog.push({
                    turn: combatState.battleLog.length,
                    message: message,
                    type: type
                });
            }

            function checkCombatEndConditions() {
                // Check if player won
                if (combatState.fortressHealth <= 0) {
                    endCombat(true);
                    return;
                }
                
                // Check if player lost (all units dead)
                const alivePlayerUnits = combatState.playerUnits.filter(u => u.currentHealth > 0 || u.unitCount > 0);
                if (alivePlayerUnits.length === 0) {
                    endCombat(false);
                    return;
                }
            }

            function endCombat(playerWon) {
                if (playerWon) {
                    addToBattleLog('Victory! Fortress conquered!', 'system');
                    showNotification('Combat Victory! Fortress conquered! Rewards: 4000 Steel, 2000 Coins, 2000 Gold, 700 Oil', 12, 7, 'success');
                    // Award resources
                    gameState.addResources({
                        Steel: 4000,
                        coins: 2000,
                        gold: 2000,
                        oil: 700
                    });
                    
                    // Return surviving units to army
                    returnSurvivingUnits();
                } else {
                    addToBattleLog('Defeat! All units destroyed.', 'system');
                    showNotification('Combat Defeat! All units were lost.', 12, 7, 'danger');
                    // Units are already removed, no need to do anything
                }
                
                updateBattleLog();
                
                // Disable action buttons
                document.getElementById('combat-attack-btn').disabled = true;
                document.getElementById('combat-defend-btn').disabled = true;
                
                // Auto-close after delay
                setTimeout(() => {
                    exitCombat();
                }, 3000);
            }

            function returnSurvivingUnits() {
                const storedUnits = gameState.storedArmyUnits || [];
                
                combatState.playerUnits.forEach(unit => {
                    // Add back surviving units
                    if (unit.currentHealth > 0 && unit.unitCount > 0) {
                        // Add the representative unit back
                        const survivingUnit = { ...unit };
                        delete survivingUnit.unitCount; // Remove the count property
                        delete survivingUnit.originalTypeUnits; // Remove original references
                        storedUnits.push(survivingUnit);
                        
                        // Add additional units if there are more in the stack
                        for (let i = 1; i < unit.unitCount; i++) {
                            if (unit.originalTypeUnits && unit.originalTypeUnits[i]) {
                                storedUnits.push({ ...unit.originalTypeUnits[i] });
                            }
                        }
                    }
                });
                
                updateArmyBoxDisplay();
            }

            // Helper functions for unit stats
            function getUnitMaxHealth(unitType) {
                switch (unitType) {
                    case 'tank': return 5;
                    case 'king': return 25;
                    default: return 1;
                }
            }
            
            function getUnitDamage(unitType) {
                switch (unitType) {
                    case 'tank': return 3;
                    case 'archer': return 2;
                    case 'knight': return 2;
                    case 'king': return 4;
                    default: return 1;
                }
            }
            
            function getUnitRange(unitType) {
                switch (unitType) {
                    case 'archer':
                    case 'siegetower': return 4;
                    case 'king': return 2;
                    default: return 1;
                }
            }
            
            function getUnitMovement(unitType) {
                switch (unitType) {
                    case 'knight': return 5;
                    case 'archer': return 1;
                    case 'tank': return 1;
                    case 'king': return 2;
                    default: return 1;
                }
            }

            // Make functions globally available
            window.openCombatMenu = openCombatMenu;
            window.closeCombatMenu = closeCombatMenu;
            window.startCombat = startCombat;
            window.exitCombat = exitCombat;

        </script>

        <div id="resource-selection-popup" class="modal-overlay">
            <div class="modal-content resource-selection-modal">
                <div class="modal-header">
                    <h2>SELECT RESOURCES TO BRING</h2>
                    <button class="close-btn" onclick="closeResourceSelection()"></button>
                </div>
                <div class="modal-body">
                    <div class="resource-selection-container">
                        <div class="resource-selection-layout">
                            <!-- Left sidebar with controls -->
                            <div class="resource-controls-sidebar">
                                <p class="resource-selection-description">
                                    Choose how much of each resource to take with you into the zone.
                                    You can only take what you have available in your vault!
                                </p>

                                <div class="resource-selection-actions">
                                    <button class="btn-secondary" onclick="selectAllResources()">MAX ALL</button>
                                    <button class="btn-secondary" onclick="selectHalfResources()">HALF ALL</button>
                                    <button class="btn-primary" onclick="confirmResourceSelection()">ENTER ZONE</button>
                                </div>
                            </div>

                            <!-- Right main content with resource grid -->
                            <div class="resource-grid-main">
                                <div class="resource-overview">
                                    <div class="resource-overview-item">
                                        <div class="resource-overview-icon">
                                            <img src="./sprites/ironin.png" alt="Steel">
                                        </div>
                                        <div class="resource-overview-name">Steel</div>
                                        <div class="resource-overview-amount" id="overview-steel">0</div>
                                    </div>
                                    <div class="resource-overview-item">
                                        <div class="resource-overview-icon">
                                            <img src="./sprites/coin.png" alt="Coins">
                                        </div>
                                        <div class="resource-overview-name">Coins</div>
                                        <div class="resource-overview-amount" id="overview-coins">0</div>
                                    </div>
                                    <div class="resource-overview-item">
                                        <div class="resource-overview-icon">
                                            <img src="./sprites/goldin.png" alt="Gold">
                                        </div>
                                        <div class="resource-overview-name">Gold</div>
                                        <div class="resource-overview-amount" id="overview-gold">0</div>
                                    </div>
                                    <div class="resource-overview-item">
                                        <div class="resource-overview-icon">
                                            <img src="./sprites/Oil.png" alt="Oil">
                                        </div>
                                        <div class="resource-overview-name">Oil</div>
                                        <div class="resource-overview-amount" id="overview-oil">0</div>
                                    </div>
                                </div>

                                <div class="resource-sliders">
                                    <div class="resource-slider-group">
                                        <div class="resource-label">
                                            <img src="./sprites/ironin.png" alt="Steel">
                                            <span>Steel</span>
                                            <span class="available-amount">(Available: <span
                                                    id="available-steel">0</span>)</span>
                                        </div>
                                        <input type="range" id="steel-slider" min="0" max="0" value="0" class="resource-slider">
                                        <div class="slider-value">Taking: <span id="steel-value">0</span></div>
                                    </div>

                                    <div class="resource-slider-group">
                                        <div class="resource-label">
                                            <img src="./sprites/coin.png" alt="Coins">
                                            <span>Coins</span>
                                            <span class="available-amount">(Available: <span
                                                    id="available-coins">0</span>)</span>
                                        </div>
                                        <input type="range" id="coins-slider" min="0" max="0" value="0" class="resource-slider">
                                        <div class="slider-value">Taking: <span id="coins-value">0</span></div>
                                    </div>

                                    <div class="resource-slider-group">
                                        <div class="resource-label">
                                            <img src="./sprites/goldin.png" alt="Gold">
                                            <span>Gold</span>
                                            <span class="available-amount">(Available: <span
                                                    id="available-gold">0</span>)</span>
                                        </div>
                                        <input type="range" id="gold-slider" min="0" max="0" value="0" class="resource-slider">
                                        <div class="slider-value">Taking: <span id="gold-value">0</span></div>
                                    </div>

                                    <div class="resource-slider-group">
                                        <div class="resource-label">
                                            <img src="./sprites/Oil.png" alt="Oil">
                                            <span>Oil</span>
                                            <span class="available-amount">(Available: <span id="available-oil">0</span>)</span>
                                        </div>
                                        <input type="range" id="oil-slider" min="0" max="0" value="0" class="resource-slider">
                                        <div class="slider-value">Taking: <span id="oil-value">0</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
</body>

</html>